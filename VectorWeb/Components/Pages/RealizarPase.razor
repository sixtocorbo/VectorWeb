@page "/documentos/pase/{Id:long}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.editar")]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@using VectorWeb.Utils
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject IRepository<EventosSistema> RepoEventos
@inject DocumentoPlazosService DocumentoPlazosService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject SecretariaDbContext DbContext
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-warning py-3">
            <h3 class="card-title mb-0 text-dark fw-bold">
                <i class="bi bi-arrow-right-circle-fill me-2"></i>Realizar Pase de Expediente
            </h3>
        </div>

        <div class="card-body p-4">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3 text-muted fw-bold">Analizando paquete de documentos...</p>
                </div>
            }
            else if (mensajeError != null)
            {
                <div class="alert alert-danger d-flex align-items-center shadow-sm" role="alert">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                    <div>
                        <div class="fw-bold">Ha ocurrido un inconveniente</div>
                        @mensajeError
                    </div>
                </div>
                <div class="mt-3">
                    <a href="documentos" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver a la Bandeja
                    </a>
                </div>
            }
            else
            {
                <EditForm EditContext="editContextRealizarPase" OnSubmit="IgnorarSubmitRealizarPase">
                    <DataAnnotationsValidator />

                    <div class="row g-4">
                        @* Columna Izquierda: Resumen del Paquete *@
                        <div class="col-lg-5">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-header bg-dark text-white fw-bold">
                                    <i class="bi bi-box-seam me-2"></i>Resumen del Paquete
                                </div>
                                <div class="card-body shadow-sm">
                                    @if (docPadre != null)
                                    {
                                        <div class="mb-4">
                                            <label class="badge bg-primary mb-2">EXPEDIENTE PRINCIPAL</label>
                                            <h5 class="text-dark fw-bold mb-1">@FormatearNumeroConTipo(docPadre)</h5>
                                            <p class="text-secondary small mb-2">@docPadre.Asunto</p>
                                            <div class="d-flex align-items-center">
                                                <span class="badge rounded-pill bg-secondary px-3">
                                                    <i class="bi bi-files me-1"></i> Fojas: @docPadre.Fojas
                                                </span>
                                            </div>
                                        </div>
                                        <hr class="text-muted" />
                                    }

                                    <h6 class="fw-bold text-muted mb-3 uppercase small">
                                        <i class="bi bi-paperclip me-1"></i> DOCUMENTOS ADJUNTOS (@documentosAdjuntos.Count)
                                    </h6>

                                    <div class="list-group list-group-flush rounded border shadow-sm" style="max-height: 300px; overflow-y: auto;">
                                        @if (documentosAdjuntos.Any())
                                        {
                                            @foreach (var adj in documentosAdjuntos)
                                            {
                                                <div class="list-group-item list-group-item-action py-3">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <h6 class="mb-1 fw-bold text-primary">@adj.IdTipoNavigation?.Nombre</h6>
                                                        <small class="text-muted">@adj.NumeroOficial</small>
                                                    </div>
                                                    <p class="mb-1 small text-truncate">@adj.Asunto</p>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="list-group-item py-4 text-center text-muted">
                                                <small>No hay documentos adjuntos vinculados</small>
                                            </div>
                                        }
                                    </div>

                                    <div class="alert alert-info mt-4 border-0 shadow-sm d-flex justify-content-between align-items-center">
                                        <span>Total a movilizar:</span>
                                        <span class="fs-5 fw-bold">@documentosAEnviar.Count</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Columna Derecha: Formulario de Pase *@
                        <div class="col-lg-7">
                            <div class="p-3 border rounded shadow-sm bg-white">
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-dark">
                                        <i class="bi bi-building me-1"></i> Oficina Destino:
                                    </label>
                                    @if (esPaseDesdeOficinaRemota)
                                    {
                                        <div class="input-group">
                                            <span class="input-group-text bg-light text-muted"><i class="bi bi-lock-fill"></i></span>
                                            <input class="form-control form-control-lg bg-light" value="@nombreOficinaBandejaEntrada" disabled />
                                        </div>
                                        <div class="form-text text-primary">
                                            <i class="bi bi-info-circle me-1"></i> El destino se fija automáticamente en <strong>BANDEJA DE ENTRADA</strong> para oficinas remotas.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="position-relative">
                                            <div class="input-group shadow-sm">
                                                <span class="input-group-text bg-white text-warning"><i class="bi bi-search"></i></span>
                                                <input type="text"
                                                       class="form-control form-control-lg border-start-0"
                                                       placeholder="Buscar oficina..."
                                                       value="@oficinaDestinoBusqueda"
                                                       autocomplete="off"
                                                       @oninput="FiltrarOficinasDestino"
                                                       @onfocus="MostrarSugerenciasOficinaDestino"
                                                       @onkeydown="ManejarTecladoOficinasDestino" />
                                            </div>

                                            @if (oficinasDestinoFiltradas.Any())
                                            {
                                                <div class="list-group position-absolute start-0 end-0 shadow-lg mt-1"
                                                     style="z-index: 1060; max-height: 250px; overflow-y: auto;">
                                                    @for (var i = 0; i < oficinasDestinoFiltradas.Count; i++)
                                                    {
                                                        var ofi = oficinasDestinoFiltradas[i];
                                                        var cssItem = i == indiceOficinaDestinoSeleccionada
                                                        ? "list-group-item list-group-item-action active"
                                                        : "list-group-item list-group-item-action";

                                                        <button type="button" class="@cssItem py-2" @onclick="() => SeleccionarOficinaDestino(ofi)">
                                                            <i class="bi bi-geo-alt me-2"></i>@ofi.Nombre
                                                        </button>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="form-text mt-2">
                                            Use <kbd class="bg-light text-dark border">↑</kbd> <kbd class="bg-light text-dark border">↓</kbd> y <kbd class="bg-light text-dark border">Enter</kbd> para navegar rápidamente.
                                        </div>
                                        <ValidationMessage For="@(() => nuevoMovimiento.IdOficinaDestino)" class="text-danger mt-1 small fw-bold" />
                                    }
                                </div>

                                <div class="card border-info mb-4">
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <InputCheckbox @bind-Value="crearActuacionRemota" class="form-check-input shadow-none" style="cursor: pointer; width: 3em; height: 1.5em;" />
                                            <label class="form-check-label fw-bold ms-2 mt-1" style="cursor: pointer;">
                                                @(esPaseDesdeOficinaRemota ? "El pase viene con actuación" : "El pase sale con actuación")
                                            </label>
                                        </div>
                                        @if (crearActuacionRemota)
                                        {
                                            <div class="mt-2 text-info small d-flex align-items-start">
                                                <i class="bi bi-info-square-fill me-2 mt-1"></i>
                                                <span>
                                                    @(esPaseDesdeOficinaRemota
                                                                                                ? "Se abrirá el editor para registrar el documento en nombre de la oficina remota antes de retornar."
                                                                                                : "Se abrirá el editor y al finalizar se enviará automáticamente al destino.")
                                        </span>
                                    </div>
                                                                        }
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Nuevo Estado:</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                            <InputSelect @bind-Value="nuevoEstadoId" class="form-select">
                                                @foreach (var est in estados)
                                                {
                                                    <option value="@est.IdEstado">@est.Nombre</option>
                                                }
                                            </InputSelect>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold text-success">Fojas Agregadas:</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-success text-white"><i class="bi bi-plus-lg"></i></span>
                                            <InputNumber @bind-Value="fojasAgregadas" class="form-control" min="0" />
                                        </div>
                                        <small class="text-muted">Se sumarán al expediente principal.</small>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Observación / Instrucciones:</label>
                                    <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase"
                                                   class="form-control shadow-sm"
                                                   rows="4"
                                                   placeholder="Escriba las instrucciones del pase..." />
                                </div>

                                <div class="d-flex justify-content-end gap-3 pt-3 border-top mt-4">
                                    <a href="documentos" class="btn btn-light border px-4">
                                        <i class="bi bi-x-circle me-1"></i> Cancelar
                                    </a>
                                    <button type="button" class="btn btn-success px-5 fw-bold shadow" @onclick="GuardarPaseDesdeBotonAsync">
                                        <i class="bi bi-send-check-fill me-2"></i> CONFIRMAR PASE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@* Mantenemos el bloque @code intacto *@

@code {
    [Parameter] public long Id { get; set; }
    private bool cargando = true;
    private string? mensajeError;
    private List<CatOficina> oficinas = new();
    private List<CatEstado> estados = new();
    private List<MaeDocumento> documentosAEnviar = new();
    private List<MaeDocumento> documentosAdjuntos = new();
    private MaeDocumento? docPadre;
    private TraMovimiento nuevoMovimiento = new();
    private EditContext editContextRealizarPase = default!;
    private int nuevoEstadoId = 2;
    private int fojasAgregadas = 0;
    private int usuarioLogueadoId = 1;
    private int idOficinaUsuario = 0;
    private bool usuarioSinOficinaAsignada;
    private bool esPaseDesdeOficinaRemota;
    private bool crearActuacionRemota = true;
    private int? idOficinaBandejaEntrada;
    private string nombreOficinaBandejaEntrada = "BANDEJA DE ENTRADA";
    private int idOficinaOrigenPaquete;
    private string oficinaDestinoBusqueda = string.Empty;
    private List<CatOficina> oficinasDestinoFiltradas = new();
    private int indiceOficinaDestinoSeleccionada = -1;
    private readonly Dictionary<int, int> usoOficinas = new();

    protected override async Task OnInitializedAsync()
    {
        editContextRealizarPase = new EditContext(nuevoMovimiento);
        try
        {
            cargando = true;
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (int.TryParse(user.FindFirstValue(ClaimTypes.NameIdentifier), out var uid)) usuarioLogueadoId = uid;
            if (int.TryParse(user.FindFirst("IdOficina")?.Value, out var oid)) idOficinaUsuario = oid;
            usuarioSinOficinaAsignada = idOficinaUsuario <= 0;

            oficinas = await RepoOficinas.GetQueryable().Where(o => usuarioSinOficinaAsignada || o.IdOficina != idOficinaUsuario).OrderBy(o => o.Nombre).ToListAsync();
            estados = (await RepoEstados.GetAllAsync()).ToList();
            idOficinaBandejaEntrada = (await RepoOficinas.GetQueryable().Where(o => o.Nombre.ToUpper() == "BANDEJA DE ENTRADA").Select(o => (int?)o.IdOficina).FirstOrDefaultAsync());
            await CargarUsoOficinasAsync();

            await AnalizarPaqueteAsync();
            nuevoMovimiento.ObservacionPase = "Se remite para su conocimiento, consideración y fines pertinentes.";
        }
        catch (Exception ex) { mensajeError = ex.Message; }
        finally { cargando = false; }
    }

    private async Task AnalizarPaqueteAsync()
    {
        var docBase = await RepoDocs.GetQueryable().FirstOrDefaultAsync(d => d.IdDocumento == Id);
        if (docBase == null) { mensajeError = "Documento no existe."; return; }
        if (idOficinaUsuario == 0) idOficinaUsuario = docBase.IdOficinaActual;
        esPaseDesdeOficinaRemota = !usuarioSinOficinaAsignada && docBase.IdOficinaActual != idOficinaUsuario;
        idOficinaOrigenPaquete = docBase.IdOficinaActual;
        if (esPaseDesdeOficinaRemota && idOficinaBandejaEntrada.HasValue) nuevoMovimiento.IdOficinaDestino = idOficinaBandejaEntrada.Value;

        documentosAEnviar = await RepoDocs.GetQueryable("IdTipoNavigation")
            .Where(d => d.IdHiloConversacion == docBase.IdHiloConversacion && (d.IdEstadoActual != 5 || d.IdDocumento == Id))
            .Where(d => usuarioSinOficinaAsignada || d.IdOficinaActual == (esPaseDesdeOficinaRemota ? idOficinaOrigenPaquete : idOficinaUsuario))
            .ToListAsync();

        docPadre = documentosAEnviar.FirstOrDefault(d => d.IdDocumentoPadre == null) ?? documentosAEnviar.OrderBy(d => d.FechaCreacion).FirstOrDefault();
        if (docPadre != null) documentosAdjuntos = documentosAEnviar.Where(d => d.IdDocumento != docPadre.IdDocumento).ToList();
    }

    private void FiltrarOficinasDestino(ChangeEventArgs e)
    {
        oficinaDestinoBusqueda = e.Value?.ToString() ?? string.Empty;
        nuevoMovimiento.IdOficinaDestino = 0;
        indiceOficinaDestinoSeleccionada = -1;
        if (!string.IsNullOrWhiteSpace(oficinaDestinoBusqueda))
        {
            oficinasDestinoFiltradas = BuscarOficinasDestino(oficinaDestinoBusqueda).Take(8).ToList();
            var exact = oficinas.FirstOrDefault(o => string.Equals(o.Nombre, oficinaDestinoBusqueda, StringComparison.OrdinalIgnoreCase));
            if (exact != null) nuevoMovimiento.IdOficinaDestino = exact.IdOficina;
        }
        else { oficinasDestinoFiltradas.Clear(); }
    }

    private void MostrarSugerenciasOficinaDestino() { if (!string.IsNullOrWhiteSpace(oficinaDestinoBusqueda)) oficinasDestinoFiltradas = BuscarOficinasDestino(oficinaDestinoBusqueda).Take(8).ToList(); }

    private void ManejarTecladoOficinasDestino(KeyboardEventArgs e)
    {
        if (!oficinasDestinoFiltradas.Any()) return;
        if (e.Key == "ArrowDown") indiceOficinaDestinoSeleccionada = Math.Min(indiceOficinaDestinoSeleccionada + 1, oficinasDestinoFiltradas.Count - 1);
        else if (e.Key == "ArrowUp") indiceOficinaDestinoSeleccionada = Math.Max(indiceOficinaDestinoSeleccionada - 1, 0);
        else if (e.Key == "Enter" && indiceOficinaDestinoSeleccionada >= 0) SeleccionarOficinaDestino(oficinasDestinoFiltradas[indiceOficinaDestinoSeleccionada]);
        else if (e.Key == "Escape") { oficinasDestinoFiltradas.Clear(); indiceOficinaDestinoSeleccionada = -1; }
    }

    private void SeleccionarOficinaDestino(CatOficina oficina) { nuevoMovimiento.IdOficinaDestino = oficina.IdOficina; oficinaDestinoBusqueda = oficina.Nombre ?? ""; oficinasDestinoFiltradas.Clear(); indiceOficinaDestinoSeleccionada = -1; }

    private async Task CargarUsoOficinasAsync()
    {
        var movimientos = await DbContext.TraMovimientos
            .AsNoTracking()
            .Select(m => new { m.IdOficinaOrigen, m.IdOficinaDestino })
            .ToListAsync();

        usoOficinas.Clear();
        foreach (var movimiento in movimientos)
        {
            SumarUsoOficina(movimiento.IdOficinaOrigen);
            SumarUsoOficina(movimiento.IdOficinaDestino);
        }
    }

    private void SumarUsoOficina(int? idOficina)
    {
        if (!idOficina.HasValue || idOficina.Value <= 0) return;
        usoOficinas[idOficina.Value] = usoOficinas.GetValueOrDefault(idOficina.Value) + 1;
    }

    private IEnumerable<CatOficina> BuscarOficinasDestino(string termino)
    {
        if (string.IsNullOrWhiteSpace(termino)) return Enumerable.Empty<CatOficina>();

        return oficinas
            .Where(o => o.Nombre.Contains(termino, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(o => PuntajeCoincidencia(o.Nombre, termino))
            .ThenByDescending(o => usoOficinas.GetValueOrDefault(o.IdOficina))
            .ThenBy(o => o.Nombre);
    }

    private static int PuntajeCoincidencia(string? nombreOficina, string termino)
    {
        if (string.IsNullOrWhiteSpace(nombreOficina)) return 0;
        if (nombreOficina.Equals(termino, StringComparison.OrdinalIgnoreCase)) return 3;
        if (nombreOficina.StartsWith(termino, StringComparison.OrdinalIgnoreCase)) return 2;
        return 1;
    }

    private async Task GuardarPaseDesdeBotonAsync()
    {
        if (!editContextRealizarPase.Validate()) return;

        var requiereOficinaDestino = !esPaseDesdeOficinaRemota;
        if (requiereOficinaDestino && nuevoMovimiento.IdOficinaDestino == 0)
        {
            await JS.InvokeVoidAsync("alert", "Debe seleccionar una oficina de destino antes de confirmar el pase.");
            return;
        }

        if (crearActuacionRemota)
        {
            var url = $"documentos/nuevo?IdPadre={docPadre?.IdDocumento ?? Id}&AutoPase" + (esPaseDesdeOficinaRemota ? "Bandeja=true" : $"Destino={nuevoMovimiento.IdOficinaDestino}");
            Navegador.NavigateTo(url); return;
        }

        var fechaBaseVencimiento = DateTime.Now;
        var diasPlazoPorTipo = await ObtenerDiasPlazoPorTipoAsync(documentosAEnviar);
        var vencimientoPorTipo = diasPlazoPorTipo.ToDictionary(
            kvp => kvp.Key,
            kvp => (DateTime?)DocumentoPlazosService.CalcularFechaVencimiento(fechaBaseVencimiento, kvp.Value));

        await using var trans = await DbContext.Database.BeginTransactionAsync();
        try
        {
            var documentosPorId = await DbContext.MaeDocumentos
                .Where(d => documentosAEnviar.Select(doc => doc.IdDocumento).Contains(d.IdDocumento))
                .ToDictionaryAsync(d => d.IdDocumento);

            var fechaVencimientoPorPadre = new Dictionary<long, DateTime?>();
            foreach (var doc in documentosAEnviar
                         .OrderBy(d => d.IdDocumentoPadre.HasValue)
                         .ThenBy(d => d.FechaCreacion))
            {
                if (!documentosPorId.TryGetValue(doc.IdDocumento, out var documentoActualizar))
                {
                    continue;
                }

                var ori = documentoActualizar.IdOficinaActual;
                documentoActualizar.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
                documentoActualizar.IdEstadoActual = nuevoEstadoId;

                if (documentoActualizar.IdDocumentoPadre.HasValue)
                {
                    documentoActualizar.FechaVencimiento = fechaVencimientoPorPadre.TryGetValue(documentoActualizar.IdDocumentoPadre.Value, out var fechaPadre)
                        ? fechaPadre
                        : null;
                }
                else
                {
                    var fechaVencimientoRaiz = ObtenerFechaVencimientoPorTipo(vencimientoPorTipo, documentoActualizar.IdTipo);
                    documentoActualizar.FechaVencimiento = fechaVencimientoRaiz;
                    fechaVencimientoPorPadre[documentoActualizar.IdDocumento] = fechaVencimientoRaiz;
                }

                if (docPadre != null && documentoActualizar.IdDocumento == docPadre.IdDocumento)
                {
                    documentoActualizar.Fojas = (documentoActualizar.Fojas ?? 0) + fojasAgregadas;
                }

                DbContext.TraMovimientos.Add(new TraMovimiento
                {
                    IdDocumento = documentoActualizar.IdDocumento,
                    IdOficinaOrigen = (usuarioSinOficinaAsignada || esPaseDesdeOficinaRemota) ? ori : idOficinaUsuario,
                    IdOficinaDestino = nuevoMovimiento.IdOficinaDestino,
                    FechaMovimiento = DateTime.Now,
                    IdUsuarioResponsable = usuarioLogueadoId,
                    IdEstadoEnEseMomento = nuevoEstadoId,
                    ObservacionPase = nuevoMovimiento.ObservacionPase
                });
            }

            DbContext.EventosSistemas.Add(new EventosSistema
            {
                UsuarioId = usuarioLogueadoId,
                FechaEvento = DateTime.Now,
                Modulo = "PASE",
                Descripcion = $"Pase de {documentosAEnviar.Count} docs."
            });

            await DbContext.SaveChangesAsync();
            await trans.CommitAsync(); Navegador.NavigateTo("documentos");
        }
        catch (Exception ex) { await trans.RollbackAsync(); mensajeError = ex.Message; }
    }
    private Task IgnorarSubmitRealizarPase(EditContext _) => Task.CompletedTask;

    private async Task<Dictionary<int, int>> ObtenerDiasPlazoPorTipoAsync(IEnumerable<MaeDocumento> documentos)
    {
        var tiposDocumento = documentos
            .Select(d => d.IdTipo)
            .Where(idTipo => idTipo > 0)
            .Distinct()
            .ToList();

        if (!tiposDocumento.Any())
        {
            return new Dictionary<int, int>();
        }

        var configuracionesPorTipo = await DbContext.CfgTiemposRespuesta
            .AsNoTracking()
            .Where(c => tiposDocumento.Contains(c.IdTipoDocumento))
            .GroupBy(c => c.IdTipoDocumento)
            .Select(g => new
            {
                IdTipo = g.Key,
                Dias = g.Where(c => string.Equals((c.Prioridad ?? string.Empty).Trim(), "NORMAL", StringComparison.OrdinalIgnoreCase))
                    .Select(c => (int?)c.DiasMaximos)
                    .FirstOrDefault() ?? g.Min(c => c.DiasMaximos)
            })
            .ToListAsync();

        return configuracionesPorTipo.ToDictionary(x => x.IdTipo, x => x.Dias);
    }

    private static DateTime? ObtenerFechaVencimientoPorTipo(IReadOnlyDictionary<int, DateTime?> vencimientoPorTipo, int idTipoDocumento)
    {
        if (idTipoDocumento <= 0)
        {
            return null;
        }

        return vencimientoPorTipo.TryGetValue(idTipoDocumento, out var fechaVencimiento)
            ? fechaVencimiento
            : null;
    }

    private static string FormatearNumeroConTipo(MaeDocumento documento)
    {
        var numero = string.IsNullOrWhiteSpace(documento.NumeroOficial) ? "S/N" : documento.NumeroOficial;
        var tipo = documento.IdTipoNavigation?.Nombre;
        return string.IsNullOrWhiteSpace(tipo) ? numero : $"{tipo} {numero}";
    }
}
