@page "/documentos/pase/{Id:long}"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject IRepository<EventosSistema> RepoEventos
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject SecretariaDbContext DbContext
@rendermode InteractiveServer

<div class="card shadow">
    <div class="card-header bg-warning text-dark">
        <h3><i class="bi bi-arrow-right-circle"></i> Realizar Pase</h3>
    </div>
    <div class="card-body">
        @if (cargando)
        {
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary ms-2 me-2" role="status"></div>
                <span>Analizando paquete de documentos...</span>
            </div>
        }
        else if (mensajeError != null)
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> @mensajeError
                <br />
                <a href="documentos" class="btn btn-secondary mt-2">Volver a la Bandeja</a>
            </div>
        }
        else
        {
            <EditForm Model="nuevoMovimiento" OnValidSubmit="GuardarPase">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-5">
                        <div class="card bg-light mb-3">
                            <div class="card-header fw-bold">üì¶ Resumen del Paquete</div>
                            <div class="card-body small">
                                @if (docPadre != null)
                                {
                                    <h6 class="text-primary fw-bold">EXPEDIENTE PRINCIPAL (PADRE)</h6>
                                    <p class="mb-1">
                                        <strong>@docPadre.NumeroOficial</strong><br />
                                        @docPadre.Asunto
                                    </p>
                                    <span class="badge bg-secondary">Fojas Acumuladas: @docPadre.Fojas</span>
                                    <hr />
                                }

                                @if (documentosAdjuntos.Any())
                                {
                                    <h6 class="text-secondary fw-bold">üìé ADJUNTOS (@documentosAdjuntos.Count)</h6>
                                    <ul class="list-unstyled">
                                        @foreach (var adj in documentosAdjuntos)
                                        {
                                            <li class="mb-1">
                                                <i class="bi bi-paperclip"></i>
                                                <span class="fw-semibold">@adj.IdTipoNavigation?.Nombre</span>
                                                @if (!string.IsNullOrWhiteSpace(adj.NumeroOficial))
                                                {
                                                    <span>- @adj.NumeroOficial</span>
                                                }
                                                <br />
                                                <span class="text-muted fst-italic">(@adj.Asunto)</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted">(Sin documentos adjuntos)</p>
                                }

                                <div class="alert alert-info mt-2 mb-0 py-2">
                                    <strong>Total a enviar:</strong> @documentosAEnviar.Count documento(s).
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Oficina Destino:</label>
                            @if (esPaseDesdeOficinaRemota)
                            {
                                <input class="form-control form-select-lg" value="@nombreOficinaBandejaEntrada" disabled />
                                <small class="text-muted">Al dar pase de una oficina remota, el destino se fija autom√°ticamente en BANDEJA DE ENTRADA.</small>
                            }
                            else
                            {
                                <div class="position-relative">
                                    <input type="text"
                                           class="form-control form-control-lg"
                                           placeholder="Escriba para buscar oficina destino..."
                                           value="@oficinaDestinoBusqueda"
                                           autocomplete="off"
                                           @oninput="FiltrarOficinasDestino"
                                           @onfocus="MostrarSugerenciasOficinaDestino"
                                           @onkeydown="ManejarTecladoOficinasDestino" />

                                    @if (oficinasDestinoFiltradas.Any())
                                    {
                                        <div class="list-group position-absolute start-0 end-0 shadow-sm"
                                             style="z-index: 1050; max-height: 240px; overflow-y: auto;">
                                            @for (var i = 0; i < oficinasDestinoFiltradas.Count; i++)
                                            {
                                                var ofi = oficinasDestinoFiltradas[i];
                                                var cssItem = i == indiceOficinaDestinoSeleccionada
                                                    ? "list-group-item list-group-item-action active"
                                                    : "list-group-item list-group-item-action";

                                                <button type="button"
                                                        class="@cssItem"
                                                        @onclick="() => SeleccionarOficinaDestino(ofi)">
                                                    @ofi.Nombre
                                                </button>
                                            }
                                        </div>
                                    }
                                </div>
                                <small class="text-muted d-block mt-1">
                                    Puede buscar escribiendo palabras en cualquier orden. Use ‚Üë ‚Üì y Enter para seleccionar.
                                </small>
                                <ValidationMessage For="@(() => nuevoMovimiento.IdOficinaDestino)" />
                            }
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="crearActuacionRemota" class="form-check-input" />
                            <label class="form-check-label fw-bold">@(esPaseDesdeOficinaRemota ? "El pase viene con actuaci√≥n" : "El pase sale con actuaci√≥n")</label>
                            @if (crearActuacionRemota)
                            {
                                @if (esPaseDesdeOficinaRemota)
                                {
                                    <small class="text-muted d-block mt-1">
                                        Al confirmar, se abrir√° Confecci√≥n de Actuaci√≥n para registrar el documento en nombre de la oficina remota y luego retornar el expediente a BANDEJA DE ENTRADA.
                                    </small>
                                }
                                else
                                {
                                    <small class="text-muted d-block mt-1">
                                        Al confirmar, se abrir√° Confecci√≥n de Actuaci√≥n y al finalizar se enviar√° autom√°ticamente el expediente a la oficina destino seleccionada.
                                    </small>
                                }
                            }
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nuevo Estado:</label>
                                <InputSelect @bind-Value="nuevoEstadoId" class="form-control">
                                    @foreach (var est in estados)
                                    {
                                        <option value="@est.IdEstado">@est.Nombre</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-success">
                                    <i class="bi bi-files"></i> Fojas Agregadas:
                                </label>
                                <InputNumber @bind-Value="fojasAgregadas" class="form-control" min="0" />
                                <small class="text-muted">Se sumar√°n al expediente principal.</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Observaci√≥n / Instrucciones:</label>
                            <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase" class="form-control" rows="4" 
                                           placeholder="Se remite para su conocimiento, consideraci√≥n y fines pertinentes..." />
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="documentos" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-success px-4 fw-bold">
                                <i class="bi bi-send-check"></i> CONFIRMAR PASE
                            </button>
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public long Id { get; set; }

    private bool cargando = true;
    private string? mensajeError;

    // Listas de datos
    private List<CatOficina> oficinas = new();
    private List<CatEstado> estados = new();

    // L√≥gica del Paquete (frmPase.vb)
    private List<MaeDocumento> documentosAEnviar = new();
    private List<MaeDocumento> documentosAdjuntos = new();
    private MaeDocumento? docPadre;

    // Modelo del formulario
    private TraMovimiento nuevoMovimiento = new();
    private int nuevoEstadoId = 2; // Por defecto: 2 = En Tr√°mite / Enviado (Seg√∫n frmPase.vb)
    private int fojasAgregadas = 0;
    private int usuarioLogueadoId = 1;
    private int idOficinaUsuario = 0;
    private bool usuarioSinOficinaAsignada;
    private bool esPaseDesdeOficinaRemota;
    private bool crearActuacionRemota;
    private int? idOficinaBandejaEntrada;
    private string nombreOficinaBandejaEntrada = "BANDEJA DE ENTRADA";
    private int idOficinaOrigenPaquete;
    private string oficinaDestinoBusqueda = string.Empty;
    private List<CatOficina> oficinasDestinoFiltradas = new();
    private int indiceOficinaDestinoSeleccionada = -1;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargando = true;

            // 1. Obtener usuario y su oficina
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var claimId = user.FindFirstValue(ClaimTypes.NameIdentifier);
            var claimOficina = user.FindFirst("IdOficina")?.Value;

            if (int.TryParse(claimId, out var uid)) usuarioLogueadoId = uid;
            if (int.TryParse(claimOficina, out var oid)) idOficinaUsuario = oid;
            usuarioSinOficinaAsignada = idOficinaUsuario <= 0;

            // 2. Cargar combos
            var queryOficinas = RepoOficinas.GetQueryable();
            if (!usuarioSinOficinaAsignada)
            {
                queryOficinas = queryOficinas.Where(o => o.IdOficina != idOficinaUsuario); // No mostrar mi propia oficina
            }

            oficinas = await queryOficinas
                .OrderBy(o => o.Nombre)
                .ToListAsync();

            idOficinaBandejaEntrada = (await RepoOficinas.GetQueryable()
                .Where(o => o.Nombre.ToUpper() == "BANDEJA DE ENTRADA")
                .Select(o => (int?)o.IdOficina)
                .FirstOrDefaultAsync());

            if (idOficinaBandejaEntrada.HasValue)
            {
                var nombreBandeja = await RepoOficinas.GetQueryable()
                    .Where(o => o.IdOficina == idOficinaBandejaEntrada.Value)
                    .Select(o => o.Nombre)
                    .FirstOrDefaultAsync();

                if (!string.IsNullOrWhiteSpace(nombreBandeja))
                {
                    nombreOficinaBandejaEntrada = nombreBandeja;
                }
            }

            estados = (await RepoEstados.GetAllAsync()).ToList();

            // 3. ANALIZAR PAQUETE (L√≥gica de frmPase.vb -> AnalizarPaquete)
            await AnalizarPaqueteAsync();
            
            // 4. Texto por defecto (como en frmPase.vb)
            nuevoMovimiento.ObservacionPase = "Se remite para su conocimiento, consideraci√≥n y fines pertinentes.";
        }
        catch (Exception ex)
        {
            mensajeError = "Error inicializando: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task AnalizarPaqueteAsync()
    {
        // Traemos el documento base que clicke√≥ el usuario
        var docBase = await RepoDocs.GetQueryable().FirstOrDefaultAsync(d => d.IdDocumento == Id);

        if (docBase == null)
        {
            mensajeError = "El documento solicitado no existe.";
            return;
        }

        if (idOficinaUsuario == 0)
        {
            idOficinaUsuario = docBase.IdOficinaActual;
        }

        esPaseDesdeOficinaRemota = !usuarioSinOficinaAsignada && docBase.IdOficinaActual != idOficinaUsuario;
        idOficinaOrigenPaquete = docBase.IdOficinaActual;

        if (esPaseDesdeOficinaRemota)
        {
            if (!idOficinaBandejaEntrada.HasValue)
            {
                mensajeError = "No se encontr√≥ la oficina BANDEJA DE ENTRADA para completar el pase autom√°tico.";
                return;
            }

            nuevoMovimiento.IdOficinaDestino = idOficinaBandejaEntrada.Value;
        }

        var guidFamilia = docBase.IdHiloConversacion;

        // TRAEMOS TODA LA FAMILIA QUE EST√Å CONMIGO (Igual que frmPase.vb)
        // Condici√≥n: Mismo Hilo + Misma Oficina + Activo (Estado != 5)
        var queryFamilia = RepoDocs.GetQueryable("IdTipoNavigation")
            .Where(d => d.IdHiloConversacion == guidFamilia && (d.IdEstadoActual != 5 || d.IdDocumento == Id));

        if (!usuarioSinOficinaAsignada)
        {
            var oficinaFiltro = esPaseDesdeOficinaRemota ? idOficinaOrigenPaquete : idOficinaUsuario;
            queryFamilia = queryFamilia.Where(d => d.IdOficinaActual == oficinaFiltro);
        }

        documentosAEnviar = await queryFamilia.ToListAsync();

        if (!documentosAEnviar.Any())
        {
            var queryDocumentoIndividual = RepoDocs.GetQueryable("IdTipoNavigation")
                .Where(d => d.IdDocumento == Id);

            if (!usuarioSinOficinaAsignada)
            {
                var oficinaFiltro = esPaseDesdeOficinaRemota ? idOficinaOrigenPaquete : idOficinaUsuario;
                queryDocumentoIndividual = queryDocumentoIndividual.Where(d => d.IdOficinaActual == oficinaFiltro);
            }

            documentosAEnviar = await queryDocumentoIndividual.ToListAsync();
        }

        if (!documentosAEnviar.Any())
        {
            mensajeError = "No hay documentos disponibles para enviar en este expediente.";
            return;
        }

        // IDENTIFICAMOS AL PADRE (JEFE)
        docPadre = documentosAEnviar.FirstOrDefault(d => d.IdDocumentoPadre == null);

        // Si no encontramos padre (caso raro de hu√©rfanos), tomamos el m√°s antiguo
        if (docPadre == null)
        {
            docPadre = documentosAEnviar.OrderBy(d => d.FechaCreacion).FirstOrDefault();
        }

        // Separamos los adjuntos para la vista
        if (docPadre != null)
        {
            documentosAdjuntos = documentosAEnviar.Where(d => d.IdDocumento != docPadre.IdDocumento).ToList();
        }
    }

    private async Task GuardarPase()
    {
        if (crearActuacionRemota)
        {
            var idDocumentoPadre = docPadre?.IdDocumento ?? Id;

            if (esPaseDesdeOficinaRemota)
            {
                Navegador.NavigateTo($"documentos/nuevo?IdPadre={idDocumentoPadre}&AutoPaseBandeja=true");
                return;
            }

            if (nuevoMovimiento.IdOficinaDestino == 0)
            {
                mensajeError = "Debe seleccionar una oficina destino para el pase con actuaci√≥n.";
                return;
            }

            Navegador.NavigateTo($"documentos/nuevo?IdPadre={idDocumentoPadre}&AutoPaseDestino={nuevoMovimiento.IdOficinaDestino}");
            return;
        }

        if (esPaseDesdeOficinaRemota)
        {
            if (!idOficinaBandejaEntrada.HasValue)
            {
                mensajeError = "No se encontr√≥ la oficina BANDEJA DE ENTRADA para completar el pase autom√°tico.";
                return;
            }

            nuevoMovimiento.IdOficinaDestino = idOficinaBandejaEntrada.Value;
        }

        if (nuevoMovimiento.IdOficinaDestino == 0) return;

        var nombreDestino = oficinas.FirstOrDefault(o => o.IdOficina == nuevoMovimiento.IdOficinaDestino)?.Nombre ?? nombreOficinaBandejaEntrada;
        var documentosProcesados = 0;

        await using var transaction = await DbContext.Database.BeginTransactionAsync();

        try
        {
            // Ejecuci√≥n del Pase Masivo (Igual que frmPase.vb -> btnConfirmar_Click)
            foreach (var doc in documentosAEnviar)
            {
                var oficinaOrigenMovimiento = doc.IdOficinaActual;

                // 1. Actualizamos ubicaci√≥n y estado
                doc.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
                doc.IdEstadoActual = nuevoEstadoId;

                // Limpiamos navegaciones para evitar conflictos de EF
                doc.IdEstadoActualNavigation = null!;
                doc.IdOficinaActualNavigation = null!;
                doc.IdTipoNavigation = null!;

                // 2. Sumamos fojas (SOLO AL PADRE, como en VB.NET)
                if (docPadre != null && doc.IdDocumento == docPadre.IdDocumento && fojasAgregadas > 0)
                {
                    // Basado en frmPase.vb l√≠nea 395: doc.Fojas += fojasNuevas
                    doc.Fojas = (doc.Fojas ?? 0) + fojasAgregadas;
                }

                // 3. Generamos Historial
                var mov = new TraMovimiento
                {
                    IdDocumento = doc.IdDocumento,
                    IdOficinaOrigen = (usuarioSinOficinaAsignada || esPaseDesdeOficinaRemota) ? oficinaOrigenMovimiento : idOficinaUsuario,
                    IdOficinaDestino = nuevoMovimiento.IdOficinaDestino,
                    FechaMovimiento = DateTime.Now,
                    IdUsuarioResponsable = usuarioLogueadoId,
                    IdEstadoEnEseMomento = nuevoEstadoId,
                    ObservacionPase = nuevoMovimiento.ObservacionPase
                };

                await RepoMovimientos.AddAsync(mov);
                await RepoDocs.UpdateAsync(doc);
                documentosProcesados++;
            }

            var evento = new EventosSistema
            {
                UsuarioId = usuarioLogueadoId,
                FechaEvento = DateTime.Now,
                Modulo = "PASE",
                Descripcion = $"Pase de {documentosProcesados} documento(s) a {nombreDestino}. " +
                              $"Observaci√≥n: {nuevoMovimiento.ObservacionPase}. " +
                              $"Fojas agregadas: {fojasAgregadas}."
            };

            await RepoEventos.AddAsync(evento);
            await transaction.CommitAsync();

            Navegador.NavigateTo("documentos");
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            mensajeError = "Error cr√≠tico al realizar el pase: " + ex.Message;
        }
    }

    private Task FiltrarOficinasDestino(ChangeEventArgs e)
    {
        oficinaDestinoBusqueda = e.Value?.ToString() ?? string.Empty;
        nuevoMovimiento.IdOficinaDestino = 0;
        indiceOficinaDestinoSeleccionada = -1;

        if (string.IsNullOrWhiteSpace(oficinaDestinoBusqueda))
        {
            oficinasDestinoFiltradas.Clear();
            return Task.CompletedTask;
        }

        oficinasDestinoFiltradas = BuscarOficinasDestino(oficinaDestinoBusqueda)
            .Take(8)
            .ToList();

        var coincidenciaExacta = oficinas.FirstOrDefault(o =>
            string.Equals(o.Nombre, oficinaDestinoBusqueda, StringComparison.OrdinalIgnoreCase));

        if (coincidenciaExacta != null)
        {
            nuevoMovimiento.IdOficinaDestino = coincidenciaExacta.IdOficina;
        }

        return Task.CompletedTask;
    }

    private void MostrarSugerenciasOficinaDestino()
    {
        if (!string.IsNullOrWhiteSpace(oficinaDestinoBusqueda))
        {
            oficinasDestinoFiltradas = BuscarOficinasDestino(oficinaDestinoBusqueda)
                .Take(8)
                .ToList();
        }
    }

    private Task ManejarTecladoOficinasDestino(KeyboardEventArgs e)
    {
        if (!oficinasDestinoFiltradas.Any())
        {
            return Task.CompletedTask;
        }

        if (e.Key == "ArrowDown")
        {
            indiceOficinaDestinoSeleccionada = Math.Min(indiceOficinaDestinoSeleccionada + 1, oficinasDestinoFiltradas.Count - 1);
            return Task.CompletedTask;
        }

        if (e.Key == "ArrowUp")
        {
            indiceOficinaDestinoSeleccionada = Math.Max(indiceOficinaDestinoSeleccionada - 1, 0);
            return Task.CompletedTask;
        }

        if (e.Key == "Enter" && indiceOficinaDestinoSeleccionada >= 0)
        {
            _ = SeleccionarOficinaDestino(oficinasDestinoFiltradas[indiceOficinaDestinoSeleccionada]);
            return Task.CompletedTask;
        }

        if (e.Key == "Escape")
        {
            oficinasDestinoFiltradas.Clear();
            indiceOficinaDestinoSeleccionada = -1;
        }

        return Task.CompletedTask;
    }

    private Task SeleccionarOficinaDestino(CatOficina oficina)
    {
        nuevoMovimiento.IdOficinaDestino = oficina.IdOficina;
        oficinaDestinoBusqueda = oficina.Nombre ?? string.Empty;
        oficinasDestinoFiltradas.Clear();
        indiceOficinaDestinoSeleccionada = -1;
        return Task.CompletedTask;
    }

    private IEnumerable<CatOficina> BuscarOficinasDestino(string terminoBusqueda)
    {
        var palabras = terminoBusqueda
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        if (palabras.Length == 0)
        {
            return Enumerable.Empty<CatOficina>();
        }

        return oficinas
            .Where(o => palabras.All(palabra =>
                (o.Nombre?.Contains(palabra, StringComparison.OrdinalIgnoreCase) ?? false)))
            .OrderBy(o => o.Nombre);
    }
}
