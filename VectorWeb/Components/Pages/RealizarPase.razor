@page "/documentos/pase/{Id:long}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.editar")]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@using VectorWeb.Utils

@* INYECCIÓN BLINDADA *@
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject IRepository<EventosSistema> RepoEventos
@inject DocumentoPlazosService DocumentoPlazosService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject IDbContextFactory<SecretariaDbContext> DbContextFactory
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-warning py-3">
            <h3 class="card-title mb-0 text-dark fw-bold">
                <i class="bi bi-arrow-right-circle-fill me-2"></i>Realizar Pase de Expediente
            </h3>
        </div>

        <div class="card-body p-4">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3 text-muted fw-bold">Analizando paquete de documentos...</p>
                </div>
            }
            else if (mensajeError != null)
            {
                <div class="alert alert-danger d-flex align-items-center shadow-sm" role="alert">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                    <div>
                        <div class="fw-bold">Ha ocurrido un inconveniente</div>
                        @mensajeError
                    </div>
                </div>
                <div class="mt-3">
                    <a href="documentos" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver a la Bandeja
                    </a>
                </div>
            }
            else
            {
                <EditForm EditContext="editContextRealizarPase" OnSubmit="IgnorarSubmitRealizarPase">
                    <DataAnnotationsValidator />

                    <div class="row g-4">
                        @* Columna Izquierda: Resumen del Paquete *@
                        <div class="col-lg-5">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-header bg-dark text-white fw-bold">
                                    <i class="bi bi-box-seam me-2"></i>Resumen del Paquete
                                </div>
                                <div class="card-body shadow-sm">
                                    @if (docPadre != null)
                                    {
                                        <div class="mb-4">
                                            <label class="badge bg-primary mb-2">EXPEDIENTE PRINCIPAL</label>
                                            <h5 class="text-dark fw-bold mb-1">@FormatearNumeroConTipo(docPadre)</h5>
                                            <p class="text-secondary small mb-2">@docPadre.Asunto</p>
                                            <div class="d-flex align-items-center">
                                                <span class="badge rounded-pill bg-secondary px-3">
                                                    <i class="bi bi-files me-1"></i> Fojas: @docPadre.Fojas
                                                </span>
                                            </div>
                                        </div>
                                        <hr class="text-muted" />
                                    }

                                    <h6 class="fw-bold text-muted mb-3 uppercase small">
                                        <i class="bi bi-paperclip me-1"></i> DOCUMENTOS ADJUNTOS (@documentosAdjuntos.Count)
                                    </h6>

                                    <div class="list-group list-group-flush rounded border shadow-sm" style="max-height: 300px; overflow-y: auto;">
                                        @if (documentosAdjuntos.Any())
                                        {
                                            @foreach (var adj in documentosAdjuntos)
                                            {
                                                <div class="list-group-item list-group-item-action py-3">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <h6 class="mb-1 fw-bold text-primary">@adj.IdTipoNavigation?.Nombre</h6>
                                                        <small class="text-muted">@adj.NumeroOficial</small>
                                                    </div>
                                                    <p class="mb-1 small text-truncate">@adj.Asunto</p>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="list-group-item py-4 text-center text-muted">
                                                <small>No hay documentos adjuntos vinculados</small>
                                            </div>
                                        }
                                    </div>

                                    <div class="alert alert-info mt-4 border-0 shadow-sm d-flex justify-content-between align-items-center">
                                        <span>Total a movilizar:</span>
                                        <span class="fs-5 fw-bold">@documentosAEnviar.Count</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Columna Derecha: Formulario de Pase *@
                        <div class="col-lg-7">
                            <div class="p-3 border rounded shadow-sm bg-white">
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-dark">
                                        <i class="bi bi-building me-1"></i> Oficina Destino:
                                    </label>
                                    @if (esPaseDesdeOficinaRemota)
                                    {
                                        <div class="input-group">
                                            <span class="input-group-text bg-light text-muted"><i class="bi bi-lock-fill"></i></span>
                                            <input class="form-control form-control-lg bg-light" value="@nombreOficinaBandejaEntrada" disabled />
                                        </div>
                                        <div class="form-text text-primary">
                                            <i class="bi bi-info-circle me-1"></i> El destino se fija automáticamente en <strong>BANDEJA DE ENTRADA</strong> para oficinas remotas.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="position-relative">
                                            <div class="input-group shadow-sm">
                                                <span class="input-group-text bg-white text-warning"><i class="bi bi-search"></i></span>
                                                <input type="text"
                                                       class="form-control form-control-lg border-start-0"
                                                       placeholder="Buscar oficina..."
                                                       @bind="oficinaDestinoBusqueda"
                                                       @oninput="FiltrarOficinasDestino"
                                                       @onfocus="MostrarSugerenciasOficinaDestino"
                                                       @onkeydown="ManejarTecladoOficinasDestino"
                                                       autocomplete="off" />
                                            </div>

                                            @if (oficinasDestinoFiltradas.Any())
                                            {
                                                <div class="list-group position-absolute start-0 end-0 shadow-lg mt-1"
                                                     style="z-index: 1060; max-height: 250px; overflow-y: auto;">
                                                    @for (var i = 0; i < oficinasDestinoFiltradas.Count; i++)
                                                    {
                                                        var ofi = oficinasDestinoFiltradas[i];
                                                        var cssItem = i == indiceOficinaDestinoSeleccionada
                                                        ? "list-group-item list-group-item-action active"
                                                        : "list-group-item list-group-item-action";

                                                        <button type="button" class="@cssItem py-2" @onclick="() => SeleccionarOficinaDestino(ofi)">
                                                            <i class="bi bi-geo-alt me-2"></i>@ofi.Nombre
                                                        </button>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="form-text mt-2">
                                            Use <kbd class="bg-light text-dark border">↑</kbd> <kbd class="bg-light text-dark border">↓</kbd> y <kbd class="bg-light text-dark border">Enter</kbd> para navegar rápidamente.
                                        </div>
                                    }
                                </div>

                                <div class="card border-info mb-4">
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <InputCheckbox @bind-Value="crearActuacionRemota" class="form-check-input shadow-none" style="cursor: pointer; width: 3em; height: 1.5em;" />
                                            <label class="form-check-label fw-bold ms-2 mt-1" style="cursor: pointer;">
                                                @(esPaseDesdeOficinaRemota ? "El pase viene con actuación" : "El pase sale con actuación")
                                            </label>
                                        </div>
                                        @if (crearActuacionRemota)
                                        {
                                            <div class="mt-2 text-info small d-flex align-items-start">
                                                <i class="bi bi-info-square-fill me-2 mt-1"></i>
                                                <span>
                                                    @(esPaseDesdeOficinaRemota
                                                                                                ? "Se abrirá el editor para registrar el documento en nombre de la oficina remota antes de retornar."
                                                                                                : "Se abrirá el editor y al finalizar se enviará automáticamente al destino.")
                                        </span>
                                    </div>
                                                                        }
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Nuevo Estado:</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                            <InputSelect @bind-Value="nuevoEstadoId" class="form-select">
                                                @foreach (var est in estados)
                                                {
                                                    <option value="@est.IdEstado">@est.Nombre</option>
                                                }
                                            </InputSelect>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold text-success">Fojas Agregadas:</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-success text-white"><i class="bi bi-plus-lg"></i></span>
                                            <InputNumber @bind-Value="fojasAgregadas" class="form-control" min="0" />
                                        </div>
                                        <small class="text-muted">Se sumarán al expediente principal.</small>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Observación / Instrucciones:</label>
                                    <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase"
                                                   class="form-control shadow-sm"
                                                   rows="4"
                                                   placeholder="Escriba las instrucciones del pase..." />
                                </div>

                                <div class="d-flex justify-content-end gap-3 pt-3 border-top mt-4">
                                    <a href="documentos" class="btn btn-light border px-4">
                                        <i class="bi bi-x-circle me-1"></i> Cancelar
                                    </a>
                                    <button type="button" class="btn btn-success px-5 fw-bold shadow" @onclick="GuardarPaseDesdeBotonAsync">
                                        <i class="bi bi-send-check-fill me-2"></i> CONFIRMAR PASE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public long Id { get; set; }
    private bool cargando = true;
    private string? mensajeError;
    private List<CatOficina> oficinas = new();
    private List<CatEstado> estados = new();
    private List<MaeDocumento> documentosAEnviar = new();
    private List<MaeDocumento> documentosAdjuntos = new();
    private MaeDocumento? docPadre;
    private TraMovimiento nuevoMovimiento = new();
    private EditContext editContextRealizarPase = default!;
    private int nuevoEstadoId = 2;
    private int fojasAgregadas = 0;
    private int usuarioLogueadoId = 1;
    private int idOficinaUsuario = 0;
    private bool usuarioSinOficinaAsignada;
    private bool esPaseDesdeOficinaRemota;
    private bool crearActuacionRemota = true;
    private int? idOficinaBandejaEntrada;
    private string nombreOficinaBandejaEntrada = "BANDEJA DE ENTRADA";
    private int idOficinaOrigenPaquete;
    private string oficinaDestinoBusqueda = string.Empty;
    private List<CatOficina> oficinasDestinoFiltradas = new();
    private int indiceOficinaDestinoSeleccionada = -1;
    private readonly Dictionary<int, int> usoOficinas = new();

    protected override async Task OnInitializedAsync()
    {
        editContextRealizarPase = new EditContext(nuevoMovimiento);
        try
        {
            cargando = true;

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (int.TryParse(user.FindFirstValue(ClaimTypes.NameIdentifier), out var uid)) usuarioLogueadoId = uid;
            if (int.TryParse(user.FindFirst("IdOficina")?.Value, out var oid)) idOficinaUsuario = oid;
            usuarioSinOficinaAsignada = idOficinaUsuario <= 0;

            var listaOficinas = await RepoOficinas.GetFilteredAsync(o => usuarioSinOficinaAsignada || o.IdOficina != idOficinaUsuario);
            oficinas = listaOficinas.OrderBy(o => o.Nombre).ToList();

            var listaEstados = await RepoEstados.GetAllAsync();
            estados = listaEstados.ToList();

            var oficinasBandeja = await RepoOficinas.GetFilteredAsync(o => o.Nombre.ToUpper() == "BANDEJA DE ENTRADA");
            idOficinaBandejaEntrada = oficinasBandeja.Select(o => (int?)o.IdOficina).FirstOrDefault();

            await CargarUsoOficinasAsync();
            await AnalizarPaqueteAsync();

            nuevoMovimiento.ObservacionPase = "Se remite para su conocimiento, consideración y fines pertinentes.";
        }
        catch (Exception ex) { mensajeError = ex.Message; }
        finally { cargando = false; }
    }

    private async Task AnalizarPaqueteAsync()
    {
        var docsBase = await RepoDocs.GetFilteredAsync(d => d.IdDocumento == Id);
        var docBase = docsBase.FirstOrDefault();

        if (docBase == null) { mensajeError = "Documento no existe."; return; }

        if (idOficinaUsuario == 0) idOficinaUsuario = docBase.IdOficinaActual;
        esPaseDesdeOficinaRemota = !usuarioSinOficinaAsignada && docBase.IdOficinaActual != idOficinaUsuario;
        idOficinaOrigenPaquete = docBase.IdOficinaActual;

        if (esPaseDesdeOficinaRemota && idOficinaBandejaEntrada.HasValue)
            nuevoMovimiento.IdOficinaDestino = idOficinaBandejaEntrada.Value;

        var oficinaFiltro = esPaseDesdeOficinaRemota ? idOficinaOrigenPaquete : idOficinaUsuario;

        var familia = await RepoDocs.GetFilteredAsync(d =>
            d.IdHiloConversacion == docBase.IdHiloConversacion &&
            (d.IdEstadoActual != 5 || d.IdDocumento == Id),
            "IdTipoNavigation");

        documentosAEnviar = familia
            .Where(d => usuarioSinOficinaAsignada || d.IdOficinaActual == oficinaFiltro)
            .ToList();

        docPadre = documentosAEnviar.FirstOrDefault(d => d.IdDocumentoPadre == null)
                   ?? documentosAEnviar.OrderBy(d => d.FechaCreacion).FirstOrDefault();

        if (docPadre != null)
            documentosAdjuntos = documentosAEnviar.Where(d => d.IdDocumento != docPadre.IdDocumento).ToList();
    }

    private async Task GuardarPaseDesdeBotonAsync()
    {
        if (!editContextRealizarPase.Validate()) return;

        if (!esPaseDesdeOficinaRemota && nuevoMovimiento.IdOficinaDestino == 0)
        {
            await JS.InvokeVoidAsync("alert", "Debe seleccionar una oficina de destino.");
            return;
        }

        if (crearActuacionRemota)
        {
            var url = $"documentos/nuevo?IdPadre={docPadre?.IdDocumento ?? Id}&AutoPase" +
                      (esPaseDesdeOficinaRemota ? "Bandeja=true" : $"Destino={nuevoMovimiento.IdOficinaDestino}");
            Navegador.NavigateTo(url);
            return;
        }

        await using var db = await DbContextFactory.CreateDbContextAsync();
        await using var trans = await db.Database.BeginTransactionAsync();

        try
        {
            var idsAEnviar = documentosAEnviar.Select(doc => doc.IdDocumento).ToList();
            var docsDb = await db.MaeDocumentos.Where(d => idsAEnviar.Contains(d.IdDocumento)).ToListAsync();

            foreach (var doc in docsDb)
            {
                var oriAnterior = doc.IdOficinaActual;
                doc.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
                doc.IdEstadoActual = nuevoEstadoId;

                if (docPadre != null && doc.IdDocumento == docPadre.IdDocumento)
                    doc.Fojas = (doc.Fojas ?? 0) + fojasAgregadas;

                db.TraMovimientos.Add(new TraMovimiento
                {
                    IdDocumento = doc.IdDocumento,
                    IdOficinaOrigen = (usuarioSinOficinaAsignada || esPaseDesdeOficinaRemota) ? oriAnterior : idOficinaUsuario,
                    IdOficinaDestino = nuevoMovimiento.IdOficinaDestino,
                    FechaMovimiento = DateTime.Now,
                    IdUsuarioResponsable = usuarioLogueadoId,
                    IdEstadoEnEseMomento = nuevoEstadoId,
                    ObservacionPase = nuevoMovimiento.ObservacionPase
                });
            }

            await db.SaveChangesAsync();
            await trans.CommitAsync();
            Navegador.NavigateTo("documentos");
        }
        catch (Exception ex)
        {
            await trans.RollbackAsync();
            mensajeError = $"Error al procesar el pase: {ex.Message}";
        }
    }

    private async Task CargarUsoOficinasAsync()
    {
        await using var db = await DbContextFactory.CreateDbContextAsync();

        // Obtenemos las estadísticas de uso por oficina
        var stats = await db.TraMovimientos
            .AsNoTracking()
            .GroupBy(m => m.IdOficinaDestino)
            .Select(g => new { Id = g.Key, Total = g.Count() })
            .ToListAsync();

        usoOficinas.Clear();
        foreach (var s in stats)
        {
            // Si s.Id es mayor a 0, lo usamos directamente como llave del diccionario
            if (s.Id > 0)
            {
                usoOficinas[s.Id] = s.Total; // <-- QUITAMOS EL .Value AQUÍ
            }
        }
    }
    private void FiltrarOficinasDestino(ChangeEventArgs e)
    {
        oficinaDestinoBusqueda = e.Value?.ToString() ?? string.Empty;
        nuevoMovimiento.IdOficinaDestino = 0;
        indiceOficinaDestinoSeleccionada = -1;
        if (!string.IsNullOrWhiteSpace(oficinaDestinoBusqueda))
            oficinasDestinoFiltradas = BuscarOficinasDestino(oficinaDestinoBusqueda).Take(8).ToList();
        else
            oficinasDestinoFiltradas.Clear();
    }

    private void MostrarSugerenciasOficinaDestino() { if (!string.IsNullOrWhiteSpace(oficinaDestinoBusqueda)) oficinasDestinoFiltradas = BuscarOficinasDestino(oficinaDestinoBusqueda).Take(8).ToList(); }

    private void ManejarTecladoOficinasDestino(KeyboardEventArgs e)
    {
        if (!oficinasDestinoFiltradas.Any()) return;
        if (e.Key == "ArrowDown") indiceOficinaDestinoSeleccionada = Math.Min(indiceOficinaDestinoSeleccionada + 1, oficinasDestinoFiltradas.Count - 1);
        else if (e.Key == "ArrowUp") indiceOficinaDestinoSeleccionada = Math.Max(indiceOficinaDestinoSeleccionada - 1, 0);
        else if (e.Key == "Enter" && indiceOficinaDestinoSeleccionada >= 0) SeleccionarOficinaDestino(oficinasDestinoFiltradas[indiceOficinaDestinoSeleccionada]);
        else if (e.Key == "Escape") { oficinasDestinoFiltradas.Clear(); indiceOficinaDestinoSeleccionada = -1; }
    }

    private void SeleccionarOficinaDestino(CatOficina oficina) { nuevoMovimiento.IdOficinaDestino = oficina.IdOficina; oficinaDestinoBusqueda = oficina.Nombre ?? ""; oficinasDestinoFiltradas.Clear(); indiceOficinaDestinoSeleccionada = -1; }

    private IEnumerable<CatOficina> BuscarOficinasDestino(string t) =>
        oficinas.Where(o => o.Nombre.Contains(t, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(o => PuntajeCoincidencia(o.Nombre, t))
            .ThenByDescending(o => usoOficinas.GetValueOrDefault(o.IdOficina));

    private static int PuntajeCoincidencia(string? n, string t) =>
        string.IsNullOrWhiteSpace(n) ? 0 : (n.Equals(t, StringComparison.OrdinalIgnoreCase) ? 3 : (n.StartsWith(t, StringComparison.OrdinalIgnoreCase) ? 2 : 1));

    private static string FormatearNumeroConTipo(MaeDocumento doc) =>
        $"{(doc.IdTipoNavigation?.Nombre ?? "DOC")} {(string.IsNullOrWhiteSpace(doc.NumeroOficial) ? "S/N" : doc.NumeroOficial)}";

    private void IgnorarSubmitRealizarPase(EditContext _) { }
}