@page "/documentos/pase/{Id:int}"
@using Microsoft.EntityFrameworkCore
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject NavigationManager Navegador
@rendermode InteractiveServer

<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h3><i class="bi bi-arrow-right-circle"></i> Realizar Pase</h3>
    </div>
    <div class="card-body">
        @if (documento is null)
        {
            <p><em>Cargando datos del documento...</em></p>
        }
        else
        {
            <div class="alert alert-secondary">
                <h5>Documento: <strong>@documento.NumeroOficial</strong></h5>
                <p class="mb-0">@documento.Asunto</p>
                <hr />
                <small>Ubicación Actual: <strong>@documento.IdOficinaActualNavigation?.Nombre</strong> | Estado: @documento.IdEstadoActualNavigation?.Nombre</small>
            </div>

            <EditForm Model="nuevoMovimiento" OnValidSubmit="GuardarPase">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Oficina Destino:</label>
                        <InputSelect @bind-Value="nuevoMovimiento.IdOficinaDestino" class="form-control">
                            <option value="0">-- Seleccione Destino --</option>
                            @foreach (var ofi in oficinas)
                            {
                                @if (ofi.IdOficina != documento.IdOficinaActual)
                                {
                                    <option value="@ofi.IdOficina">@ofi.Nombre</option>
                                }
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Nuevo Estado:</label>
                        <InputSelect @bind-Value="nuevoEstadoId" class="form-control">
                            @foreach (var est in estados)
                            {
                                <option value="@est.IdEstado">@est.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Instrucciones / Comentario:</label>
                    <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase" class="form-control" rows="3" placeholder="Ej: Para su intervención..." />
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a href="documentos" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-send"></i> Confirmar Pase
                    </button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private MaeDocumento? documento;
    private TraMovimiento nuevoMovimiento = new();
    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();
    private int nuevoEstadoId;

    protected override async Task OnInitializedAsync()
    {
        documento = await RepoDocs.GetQueryable("IdOficinaActualNavigation,IdEstadoActualNavigation")
                                  .FirstOrDefaultAsync(d => d.IdDocumento == Id);

        if (documento is not null)
        {
            nuevoEstadoId = documento.IdEstadoActual;
            oficinas = await RepoOficinas.GetAllAsync();
            estados = await RepoEstados.GetAllAsync();
        }
    }

    private async Task GuardarPase()
    {
        if (documento is null || nuevoMovimiento.IdOficinaDestino == 0)
        {
            return;
        }

        nuevoMovimiento.IdDocumento = documento.IdDocumento;
        nuevoMovimiento.IdOficinaOrigen = documento.IdOficinaActual;
        nuevoMovimiento.FechaMovimiento = DateTime.Now;
        nuevoMovimiento.IdUsuarioResponsable = 1; // TODO: Usar ID real del usuario logueado
        nuevoMovimiento.IdEstadoEnEseMomento = nuevoEstadoId;

        await RepoMovimientos.AddAsync(nuevoMovimiento);

        documento.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
        documento.IdEstadoActual = nuevoEstadoId;

        // Evita conflictos de seguimiento en EF Core por entidades relacionadas
        // duplicadas en memoria; para este update solo necesitamos las FKs.
        documento.IdEstadoActualNavigation = null!;
        documento.IdOficinaActualNavigation = null!;
        documento.IdTipoNavigation = null!;

        await RepoDocs.UpdateAsync(documento);

        Navegador.NavigateTo("documentos");
    }
}
