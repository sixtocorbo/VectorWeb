@page "/documentos/pase/{Id:long}"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@rendermode InteractiveServer

<div class="card shadow">
    <div class="card-header bg-warning text-dark">
        <h3><i class="bi bi-arrow-right-circle"></i> Realizar Pase</h3>
    </div>
    <div class="card-body">
        @if (cargando)
        {
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary ms-2 me-2" role="status"></div>
                <span>Analizando paquete de documentos...</span>
            </div>
        }
        else if (mensajeError != null)
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> @mensajeError
                <br />
                <a href="documentos" class="btn btn-secondary mt-2">Volver a la Bandeja</a>
            </div>
        }
        else
        {
            <EditForm Model="nuevoMovimiento" OnValidSubmit="GuardarPase">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-5">
                        <div class="card bg-light mb-3">
                            <div class="card-header fw-bold">游닍 Resumen del Paquete</div>
                            <div class="card-body small">
                                @if (docPadre != null)
                                {
                                    <h6 class="text-primary fw-bold">EXPEDIENTE PRINCIPAL (PADRE)</h6>
                                    <p class="mb-1">
                                        <strong>@docPadre.NumeroOficial</strong><br />
                                        @docPadre.Asunto
                                    </p>
                                    <span class="badge bg-secondary">Fojas Acumuladas: @docPadre.Fojas</span>
                                    <hr />
                                }

                                @if (documentosAdjuntos.Any())
                                {
                                    <h6 class="text-secondary fw-bold">游늹 ADJUNTOS (@documentosAdjuntos.Count)</h6>
                                    <ul class="list-unstyled">
                                        @foreach (var adj in documentosAdjuntos)
                                        {
                                            <li class="mb-1">
                                                <i class="bi bi-paperclip"></i> @adj.NumeroOficial <br />
                                                <span class="text-muted fst-italic">(@adj.Asunto)</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted">(Sin documentos adjuntos)</p>
                                }

                                <div class="alert alert-info mt-2 mb-0 py-2">
                                    <strong>Total a enviar:</strong> @documentosAEnviar.Count documento(s).
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Oficina Destino:</label>
                            <InputSelect @bind-Value="nuevoMovimiento.IdOficinaDestino" class="form-control form-select-lg">
                                <option value="0">-- Seleccione Destino --</option>
                                @foreach (var ofi in oficinas)
                                {
                                    <option value="@ofi.IdOficina">@ofi.Nombre</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => nuevoMovimiento.IdOficinaDestino)" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nuevo Estado:</label>
                                <InputSelect @bind-Value="nuevoEstadoId" class="form-control">
                                    @foreach (var est in estados)
                                    {
                                        <option value="@est.IdEstado">@est.Nombre</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-success">
                                    <i class="bi bi-files"></i> Fojas Agregadas:
                                </label>
                                <InputNumber @bind-Value="fojasAgregadas" class="form-control" min="0" />
                                <small class="text-muted">Se sumar치n al expediente principal.</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Observaci칩n / Instrucciones:</label>
                            <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase" class="form-control" rows="4" 
                                           placeholder="Se remite para su conocimiento, consideraci칩n y fines pertinentes..." />
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="documentos" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-success px-4 fw-bold">
                                <i class="bi bi-send-check"></i> CONFIRMAR PASE
                            </button>
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public long Id { get; set; }

    private bool cargando = true;
    private string? mensajeError;

    // Listas de datos
    private List<CatOficina> oficinas = new();
    private List<CatEstado> estados = new();

    // L칩gica del Paquete (frmPase.vb)
    private List<MaeDocumento> documentosAEnviar = new();
    private List<MaeDocumento> documentosAdjuntos = new();
    private MaeDocumento? docPadre;

    // Modelo del formulario
    private TraMovimiento nuevoMovimiento = new();
    private int nuevoEstadoId = 2; // Por defecto: 2 = En Tr치mite / Enviado (Seg칰n frmPase.vb)
    private int fojasAgregadas = 0;
    private int usuarioLogueadoId = 1;
    private int idOficinaUsuario = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargando = true;

            // 1. Obtener usuario y su oficina
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var claimId = user.FindFirstValue(ClaimTypes.NameIdentifier);
            var claimOficina = user.FindFirst("IdOficina")?.Value;

            if (int.TryParse(claimId, out var uid)) usuarioLogueadoId = uid;
            if (int.TryParse(claimOficina, out var oid)) idOficinaUsuario = oid;

            // 2. Cargar combos
            oficinas = await RepoOficinas.GetQueryable()
                .Where(o => o.IdOficina != idOficinaUsuario) // No mostrar mi propia oficina
                .OrderBy(o => o.Nombre)
                .ToListAsync();

            estados = await RepoEstados.GetAllAsync();

            // 3. ANALIZAR PAQUETE (L칩gica de frmPase.vb -> AnalizarPaquete)
            await AnalizarPaqueteAsync();
            
            // 4. Texto por defecto (como en frmPase.vb)
            nuevoMovimiento.ObservacionPase = "Se remite para su conocimiento, consideraci칩n y fines pertinentes.";
        }
        catch (Exception ex)
        {
            mensajeError = "Error inicializando: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task AnalizarPaqueteAsync()
    {
        // Traemos el documento base que clicke칩 el usuario
        var docBase = await RepoDocs.GetQueryable().FirstOrDefaultAsync(d => d.IdDocumento == Id);

        if (docBase == null)
        {
            mensajeError = "El documento solicitado no existe.";
            return;
        }

        // Validar que est칠 en mi oficina
        if (docBase.IdOficinaActual != idOficinaUsuario && idOficinaUsuario != 0)
        {
            mensajeError = $"Este documento no est치 en tu oficina. Est치 en: {docBase.IdOficinaActualNavigation?.Nombre ?? "Otra"}";
            return;
        }

        var guidFamilia = docBase.IdHiloConversacion;

        // TRAEMOS TODA LA FAMILIA QUE EST츼 CONMIGO (Igual que frmPase.vb)
        // Condici칩n: Mismo Hilo + Misma Oficina + Activo (Estado != 5)
        documentosAEnviar = await RepoDocs.GetQueryable("IdTipoNavigation")
            .Where(d => d.IdHiloConversacion == guidFamilia &&
                        d.IdOficinaActual == idOficinaUsuario &&
                        d.IdEstadoActual != 5)
            .ToListAsync();

        if (!documentosAEnviar.Any())
        {
            mensajeError = "No hay documentos disponibles para enviar en este expediente.";
            return;
        }

        // IDENTIFICAMOS AL PADRE (JEFE)
        docPadre = documentosAEnviar.FirstOrDefault(d => d.IdDocumentoPadre == null);

        // Si no encontramos padre (caso raro de hu칠rfanos), tomamos el m치s antiguo
        if (docPadre == null)
        {
            docPadre = documentosAEnviar.OrderBy(d => d.FechaCreacion).FirstOrDefault();
        }

        // Separamos los adjuntos para la vista
        if (docPadre != null)
        {
            documentosAdjuntos = documentosAEnviar.Where(d => d.IdDocumento != docPadre.IdDocumento).ToList();
        }
    }

    private async Task GuardarPase()
    {
        if (nuevoMovimiento.IdOficinaDestino == 0) return;

        // Ejecuci칩n del Pase Masivo (Igual que frmPase.vb -> btnConfirmar_Click)
        foreach (var doc in documentosAEnviar)
        {
            // 1. Actualizamos ubicaci칩n y estado
            doc.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
            doc.IdEstadoActual = nuevoEstadoId;

            // Limpiamos navegaciones para evitar conflictos de EF
            doc.IdEstadoActualNavigation = null!;
            doc.IdOficinaActualNavigation = null!;
            doc.IdTipoNavigation = null!;

            // 2. Sumamos fojas (SOLO AL PADRE, como en VB.NET)
            if (docPadre != null && doc.IdDocumento == docPadre.IdDocumento && fojasAgregadas > 0)
            {
                // Asumiendo que existe la propiedad Fojas en tu modelo, 
                // si se llama distinto (ej: CantidadFojas), ajustalo aqu칤.
                // Basado en frmPase.vb l칤nea 395: doc.Fojas += fojasNuevas
                doc.Fojas = (doc.Fojas ?? 0) + fojasAgregadas; 
            }

            // 3. Generamos Historial
            var mov = new TraMovimiento
            {
                IdDocumento = doc.IdDocumento,
                IdOficinaOrigen = idOficinaUsuario,
                IdOficinaDestino = nuevoMovimiento.IdOficinaDestino,
                FechaMovimiento = DateTime.Now,
                IdUsuarioResponsable = usuarioLogueadoId,
                IdEstadoEnEseMomento = nuevoEstadoId,
                ObservacionPase = nuevoMovimiento.ObservacionPase
            };

            await RepoMovimientos.AddAsync(mov);
            await RepoDocs.UpdateAsync(doc);
        }

        // Auditor칤a opcional o notificaci칩n podr칤a ir aqu칤

        Navegador.NavigateTo("documentos");
    }
}
