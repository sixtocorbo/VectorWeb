@page "/documentos/pase/{Id:int}"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@rendermode InteractiveServer

<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h3><i class="bi bi-arrow-right-circle"></i> Realizar Pase</h3>
    </div>
    <div class="card-body">
        @if (documento is null)
        {
            <p><em>Cargando datos del documento...</em></p>
        }
        else
        {
            <div class="alert alert-secondary">
                <h5>Documento: <strong>@documento.NumeroOficial</strong></h5>
                <p class="mb-0">@documento.Asunto</p>
                <hr />
                <small>Ubicaci칩n Actual: <strong>@documento.IdOficinaActualNavigation?.Nombre</strong> | Estado: @documento.IdEstadoActualNavigation?.Nombre</small>
            </div>

            <EditForm Model="nuevoMovimiento" OnValidSubmit="GuardarPase">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Oficina Destino:</label>
                        <InputSelect @bind-Value="nuevoMovimiento.IdOficinaDestino" class="form-control">
                            <option value="0">-- Seleccione Destino --</option>
                            @foreach (var ofi in oficinas)
                            {
                                @if (ofi.IdOficina != documento.IdOficinaActual)
                                {
                                    <option value="@ofi.IdOficina">@ofi.Nombre</option>
                                }
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Nuevo Estado:</label>
                        <InputSelect @bind-Value="nuevoEstadoId" class="form-control">
                            @foreach (var est in estados)
                            {
                                <option value="@est.IdEstado">@est.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Instrucciones / Comentario:</label>
                    <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase" class="form-control" rows="3" placeholder="Ej: Para su intervenci칩n..." />
                </div>

                @if (cantidadEnExpediente > 1)
                {
                    <div class="alert alert-warning">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="moverTodoElExpediente" id="chkMoverTodo">
                            <label class="form-check-label fw-bold" for="chkMoverTodo">
                                Mover todo el expediente (@cantidadEnExpediente documentos vinculados)
                            </label>
                        </div>
                        <small>Si desmarcas esto, solo mover치s el documento actual y separar치s el expediente.</small>
                    </div>
                }

                <div class="d-flex justify-content-end gap-2">
                    <a href="documentos" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-send"></i> Confirmar Pase
                    </button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private MaeDocumento? documento;
    private readonly TraMovimiento nuevoMovimiento = new();
    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();
    private int nuevoEstadoId;
    private int usuarioLogueadoId = 1;
    private int cantidadEnExpediente;
    private bool moverTodoElExpediente = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var usuarioIdClaim = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
        if (int.TryParse(usuarioIdClaim, out var uid))
        {
            usuarioLogueadoId = uid;
        }

        documento = await RepoDocs.GetQueryable("IdOficinaActualNavigation,IdEstadoActualNavigation")
                                  .FirstOrDefaultAsync(d => d.IdDocumento == Id);

        if (documento is not null)
        {
            nuevoEstadoId = documento.IdEstadoActual;
            oficinas = await RepoOficinas.GetAllAsync();
            estados = await RepoEstados.GetAllAsync();

            cantidadEnExpediente = await RepoDocs.GetQueryable()
                .Where(d => d.IdHiloConversacion == documento.IdHiloConversacion)
                .CountAsync();
        }
    }

    private async Task GuardarPase()
    {
        if (documento is null || nuevoMovimiento.IdOficinaDestino == 0)
        {
            return;
        }

        List<MaeDocumento> documentosAMover;

        if (moverTodoElExpediente)
        {
            documentosAMover = await RepoDocs.GetQueryable("IdTipoNavigation,IdOficinaActualNavigation,IdEstadoActualNavigation")
                .Where(d => d.IdHiloConversacion == documento.IdHiloConversacion)
                .ToListAsync();
        }
        else
        {
            documentosAMover = [documento];
        }

        foreach (var doc in documentosAMover)
        {
            var mov = new TraMovimiento
            {
                IdDocumento = doc.IdDocumento,
                IdOficinaOrigen = doc.IdOficinaActual,
                IdOficinaDestino = nuevoMovimiento.IdOficinaDestino,
                FechaMovimiento = DateTime.Now,
                IdUsuarioResponsable = usuarioLogueadoId,
                IdEstadoEnEseMomento = nuevoEstadoId,
                ObservacionPase = string.IsNullOrWhiteSpace(nuevoMovimiento.ObservacionPase)
                    ? (moverTodoElExpediente ? "Movimiento en bloque de expediente." : null)
                    : nuevoMovimiento.ObservacionPase + (moverTodoElExpediente ? " (Movimiento en bloque)" : string.Empty)
            };

            await RepoMovimientos.AddAsync(mov);

            doc.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
            doc.IdEstadoActual = nuevoEstadoId;

            doc.IdEstadoActualNavigation = null!;
            doc.IdOficinaActualNavigation = null!;
            doc.IdTipoNavigation = null!;

            await RepoDocs.UpdateAsync(doc);
        }

        Navegador.NavigateTo("documentos");
    }
}
