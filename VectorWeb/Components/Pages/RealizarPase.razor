@page "/documentos/pase/{Id:long}"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatEstado> RepoEstados
@inject IRepository<EventosSistema> RepoEventos
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject SecretariaDbContext DbContext
@rendermode InteractiveServer

<div class="card shadow">
    <div class="card-header bg-warning text-dark">
        <h3><i class="bi bi-arrow-right-circle"></i> Realizar Pase</h3>
    </div>
    <div class="card-body">
        @if (cargando)
        {
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary ms-2 me-2" role="status"></div>
                <span>Analizando paquete de documentos...</span>
            </div>
        }
        else if (mensajeError != null)
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> @mensajeError
                <br />
                <a href="documentos" class="btn btn-secondary mt-2">Volver a la Bandeja</a>
            </div>
        }
        else
        {
            <EditForm Model="nuevoMovimiento" OnValidSubmit="GuardarPase">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-5">
                        <div class="card bg-light mb-3">
                            <div class="card-header fw-bold"> Resumen del Paquete</div>
                            <div class="card-body small">
                                @if (docPadre != null)
                                {
                                    <h6 class="text-primary fw-bold">EXPEDIENTE PRINCIPAL (PADRE)</h6>
                                    <p class="mb-1">
                                        <strong>@docPadre.NumeroOficial</strong><br />
                                        @docPadre.Asunto
                                    </p>
                                    <span class="badge bg-secondary">Fojas Acumuladas: @docPadre.Fojas</span>
                                    <hr />
                                }

                                @if (documentosAdjuntos.Any())
                                {
                                    <h6 class="text-secondary fw-bold"> ADJUNTOS (@documentosAdjuntos.Count)</h6>
                                    <ul class="list-unstyled">
                                        @foreach (var adj in documentosAdjuntos)
                                        {
                                            <li class="mb-1">
                                                <i class="bi bi-paperclip"></i> @adj.NumeroOficial <br />
                                                <span class="text-muted fst-italic">(@adj.Asunto)</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted">(Sin documentos adjuntos)</p>
                                }

                                <div class="alert alert-info mt-2 mb-0 py-2">
                                    <strong>Total a enviar:</strong> @documentosAEnviar.Count documento(s).
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Oficina Destino:</label>
                            <InputSelect @bind-Value="nuevoMovimiento.IdOficinaDestino" class="form-control form-select-lg">
                                <option value="0">-- Seleccione Destino --</option>
                                @foreach (var ofi in oficinas)
                                {
                                    <option value="@ofi.IdOficina">@ofi.Nombre</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => nuevoMovimiento.IdOficinaDestino)" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nuevo Estado:</label>
                                <InputSelect @bind-Value="nuevoEstadoId" class="form-control">
                                    @foreach (var est in estados)
                                    {
                                        <option value="@est.IdEstado">@est.Nombre</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-success">
                                    <i class="bi bi-files"></i> Fojas Agregadas:
                                </label>
                                <InputNumber @bind-Value="fojasAgregadas" class="form-control" min="0" />
                                <small class="text-muted">Se sumar谩n al expediente principal.</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Observaci贸n / Instrucciones:</label>
                            <InputTextArea @bind-Value="nuevoMovimiento.ObservacionPase" class="form-control" rows="4" 
                                           placeholder="Se remite para su conocimiento, consideraci贸n y fines pertinentes..." />
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="documentos" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-success px-4 fw-bold">
                                <i class="bi bi-send-check"></i> CONFIRMAR PASE
                            </button>
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public long Id { get; set; }

    private bool cargando = true;
    private string? mensajeError;

    // Listas de datos
    private List<CatOficina> oficinas = new();
    private List<CatEstado> estados = new();

    // L贸gica del Paquete (frmPase.vb)
    private List<MaeDocumento> documentosAEnviar = new();
    private List<MaeDocumento> documentosAdjuntos = new();
    private MaeDocumento? docPadre;

    // Modelo del formulario
    private TraMovimiento nuevoMovimiento = new();
    private int nuevoEstadoId = 2; // Por defecto: 2 = En Tr谩mite / Enviado (Seg煤n frmPase.vb)
    private int fojasAgregadas = 0;
    private int usuarioLogueadoId = 1;
    private int idOficinaUsuario = 0;
    private bool usuarioSinOficinaAsignada;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargando = true;

            // 1. Obtener usuario y su oficina
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var claimId = user.FindFirstValue(ClaimTypes.NameIdentifier);
            var claimOficina = user.FindFirst("IdOficina")?.Value;

            if (int.TryParse(claimId, out var uid)) usuarioLogueadoId = uid;
            if (int.TryParse(claimOficina, out var oid)) idOficinaUsuario = oid;
            usuarioSinOficinaAsignada = idOficinaUsuario <= 0;

            // 2. Cargar combos
            var queryOficinas = RepoOficinas.GetQueryable();
            if (!usuarioSinOficinaAsignada)
            {
                queryOficinas = queryOficinas.Where(o => o.IdOficina != idOficinaUsuario); // No mostrar mi propia oficina
            }

            oficinas = await queryOficinas
                .OrderBy(o => o.Nombre)
                .ToListAsync();

            estados = (await RepoEstados.GetAllAsync()).ToList();

            // 3. ANALIZAR PAQUETE (L贸gica de frmPase.vb -> AnalizarPaquete)
            await AnalizarPaqueteAsync();
            
            // 4. Texto por defecto (como en frmPase.vb)
            nuevoMovimiento.ObservacionPase = "Se remite para su conocimiento, consideraci贸n y fines pertinentes.";
        }
        catch (Exception ex)
        {
            mensajeError = "Error inicializando: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task AnalizarPaqueteAsync()
    {
        // Traemos el documento base que clicke贸 el usuario
        var docBase = await RepoDocs.GetQueryable().FirstOrDefaultAsync(d => d.IdDocumento == Id);

        if (docBase == null)
        {
            mensajeError = "El documento solicitado no existe.";
            return;
        }

        if (idOficinaUsuario == 0)
        {
            idOficinaUsuario = docBase.IdOficinaActual;
        }

        // Validar que est茅 en mi oficina
        if (!usuarioSinOficinaAsignada && docBase.IdOficinaActual != idOficinaUsuario)
        {
            mensajeError = $"Este documento no est谩 en tu oficina. Est谩 en: {docBase.IdOficinaActualNavigation?.Nombre ?? "Otra"}";
            return;
        }

        var guidFamilia = docBase.IdHiloConversacion;

        // TRAEMOS TODA LA FAMILIA QUE EST CONMIGO (Igual que frmPase.vb)
        // Condici贸n: Mismo Hilo + Misma Oficina + Activo (Estado != 5)
        var queryFamilia = RepoDocs.GetQueryable("IdTipoNavigation")
            .Where(d => d.IdHiloConversacion == guidFamilia && d.IdEstadoActual != 5);

        if (!usuarioSinOficinaAsignada)
        {
            queryFamilia = queryFamilia.Where(d => d.IdOficinaActual == idOficinaUsuario);
        }

        documentosAEnviar = await queryFamilia.ToListAsync();

        if (!documentosAEnviar.Any())
        {
            var queryDocumentoIndividual = RepoDocs.GetQueryable("IdTipoNavigation")
                .Where(d => d.IdDocumento == Id && d.IdEstadoActual != 5);

            if (!usuarioSinOficinaAsignada)
            {
                queryDocumentoIndividual = queryDocumentoIndividual.Where(d => d.IdOficinaActual == idOficinaUsuario);
            }

            documentosAEnviar = await queryDocumentoIndividual.ToListAsync();
        }

        if (!documentosAEnviar.Any())
        {
            mensajeError = "No hay documentos disponibles para enviar en este expediente.";
            return;
        }

        // IDENTIFICAMOS AL PADRE (JEFE)
        docPadre = documentosAEnviar.FirstOrDefault(d => d.IdDocumentoPadre == null);

        // Si no encontramos padre (caso raro de hu茅rfanos), tomamos el m谩s antiguo
        if (docPadre == null)
        {
            docPadre = documentosAEnviar.OrderBy(d => d.FechaCreacion).FirstOrDefault();
        }

        // Separamos los adjuntos para la vista
        if (docPadre != null)
        {
            documentosAdjuntos = documentosAEnviar.Where(d => d.IdDocumento != docPadre.IdDocumento).ToList();
        }
    }

    private async Task GuardarPase()
    {
        if (nuevoMovimiento.IdOficinaDestino == 0) return;

        var nombreDestino = oficinas.FirstOrDefault(o => o.IdOficina == nuevoMovimiento.IdOficinaDestino)?.Nombre ?? "Desconocido";
        var documentosProcesados = 0;

        await using var transaction = await DbContext.Database.BeginTransactionAsync();

        try
        {
            // Ejecuci贸n del Pase Masivo (Igual que frmPase.vb -> btnConfirmar_Click)
            foreach (var doc in documentosAEnviar)
            {
                var oficinaOrigenMovimiento = doc.IdOficinaActual;

                // 1. Actualizamos ubicaci贸n y estado
                doc.IdOficinaActual = nuevoMovimiento.IdOficinaDestino;
                doc.IdEstadoActual = nuevoEstadoId;

                // Limpiamos navegaciones para evitar conflictos de EF
                doc.IdEstadoActualNavigation = null!;
                doc.IdOficinaActualNavigation = null!;
                doc.IdTipoNavigation = null!;

                // 2. Sumamos fojas (SOLO AL PADRE, como en VB.NET)
                if (docPadre != null && doc.IdDocumento == docPadre.IdDocumento && fojasAgregadas > 0)
                {
                    // Basado en frmPase.vb l铆nea 395: doc.Fojas += fojasNuevas
                    doc.Fojas = (doc.Fojas ?? 0) + fojasAgregadas;
                }

                // 3. Generamos Historial
                var mov = new TraMovimiento
                {
                    IdDocumento = doc.IdDocumento,
                    IdOficinaOrigen = usuarioSinOficinaAsignada ? oficinaOrigenMovimiento : idOficinaUsuario,
                    IdOficinaDestino = nuevoMovimiento.IdOficinaDestino,
                    FechaMovimiento = DateTime.Now,
                    IdUsuarioResponsable = usuarioLogueadoId,
                    IdEstadoEnEseMomento = nuevoEstadoId,
                    ObservacionPase = nuevoMovimiento.ObservacionPase
                };

                await RepoMovimientos.AddAsync(mov);
                await RepoDocs.UpdateAsync(doc);
                documentosProcesados++;
            }

            var evento = new EventosSistema
            {
                UsuarioId = usuarioLogueadoId,
                FechaEvento = DateTime.Now,
                Modulo = "PASE",
                Descripcion = $"Pase de {documentosProcesados} documento(s) a {nombreDestino}. " +
                              $"Observaci贸n: {nuevoMovimiento.ObservacionPase}. " +
                              $"Fojas agregadas: {fojasAgregadas}."
            };

            await RepoEventos.AddAsync(evento);
            await transaction.CommitAsync();

            Navegador.NavigateTo("documentos");
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            mensajeError = "Error cr铆tico al realizar el pase: " + ex.Message;
        }
    }
}
