@page "/reclusos/editar/{Id:int}"
@page "/reclusos/nuevo"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "reclusos.gestionar")]
@using VectorWeb.Models
@using VectorWeb.Repositories
@using Microsoft.AspNetCore.Components.Forms
@inject IRepository<MaeRecluso> Repositorio
@inject NavigationManager Navegador
@rendermode InteractiveServer

<h3>@(Id == 0 ? "Nuevo Recluso" : "Editar Recluso")</h3>

@if (miRecluso == null)
{
    <p><em>Cargando datos...</em></p>
}
else
{
    <EditForm EditContext="editContextRecluso" OnSubmit="IgnorarSubmitRecluso">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label>Nombre Completo:</label>
            <InputText class="form-control" @bind-Value="miRecluso.NombreCompleto" />
        </div>

        <div class="mb-3">
            <label>Documento:</label>
            <InputText class="form-control" @bind-Value="miRecluso.Documento" />
        </div>

        <div class="mb-3 form-check">
            <InputCheckbox class="form-check-input" @bind-Value="ActivoBool" />
            <label class="form-check-label">¿Está Activo?</label>
        </div>

        <button type="button" class="btn btn-primary" @onclick="GuardarDesdeBoton">Guardar</button>
        <a href="/reclusos" class="btn btn-secondary">Cancelar</a>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private MaeRecluso? miRecluso;
    private EditContext? editContextRecluso;

    private bool ActivoBool
    {
        get => miRecluso?.Activo ?? false;
        set
        {
            if (miRecluso is not null)
            {
                miRecluso.Activo = value;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (Id == 0)
        {
            miRecluso = new MaeRecluso { Activo = true };
        }
        else
        {
            miRecluso = await Repositorio.GetByIdAsync(Id);
        }

        if (miRecluso is not null)
        {
            editContextRecluso = new EditContext(miRecluso);
        }
    }

    private async Task GuardarDesdeBoton()
    {
        if (editContextRecluso is null || !editContextRecluso.Validate())
        {
            return;
        }

        await Guardar();
    }

    private Task IgnorarSubmitRecluso(EditContext _)
    {
        // Evita guardado automático al presionar Enter dentro del formulario.
        return Task.CompletedTask;
    }

    private async Task Guardar()
    {
        if (miRecluso is null)
        {
            return;
        }

        if (Id == 0)
        {
            await Repositorio.AddAsync(miRecluso);
        }
        else
        {
            await Repositorio.UpdateAsync(miRecluso);
        }

        Navegador.NavigateTo("/reclusos");
    }
}
