@page "/documentos/recorrido/{Id:long}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.ver")]
@using Microsoft.EntityFrameworkCore
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@rendermode InteractiveServer

<PageTitle>Recorrido por Oficinas - Vector</PageTitle>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
        <div>
            <h2 class="h3 fw-bold mb-1"><i class="bi bi-diagram-3 text-primary me-2"></i>Recorrido del Expediente</h2>
            @if (documento is not null)
            {
                <p class="text-muted mb-0">@DocumentoFormatoHelper.FormatearDocumento(documento) - @documento.Asunto</p>
            }
        </div>
        <div class="d-flex gap-2">
            <a href="documentos/historial/@Id" class="btn btn-outline-info">
                <i class="bi bi-clock-history me-1"></i> Historial
            </a>
            <a href="documentos" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Cargando recorrido...</p>
        </div>
    }
    else if (noEncontrado || documento is null)
    {
        <div class="alert alert-warning">No se encontró el expediente solicitado.</div>
    }
    else
    {
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase fw-bold text-muted">Filtrar por destino</label>
                        <select class="form-select" @bind="filtroDestino">
                            <option value="">Todos los destinos</option>
                            @foreach (var destino in destinosDisponibles)
                            {
                                <option value="@destino">@destino</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-uppercase fw-bold text-muted">Buscar recorrido</label>
                        <input class="form-control"
                               placeholder="Origen, destino u observación..."
                               @bind="filtroTexto"
                               @bind:event="oninput" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-uppercase fw-bold text-muted">Desde</label>
                        <input type="date" class="form-control" @bind="filtroDesde" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-uppercase fw-bold text-muted">Hasta</label>
                        <input type="date" class="form-control" @bind="filtroHasta" />
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive rounded shadow-sm border">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Resumen</th>
                        <th>Documentos involucrados</th>
                        <th>Recorrido</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!MovimientosFiltrados.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">No hay movimientos para los filtros seleccionados.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in MovimientosFiltrados.Select((mov, idx) => new { mov, idx }))
                        {
                            <tr>
                                <td class="fw-bold">@(item.idx + 1)</td>
                                <td>
                                    <div class="fw-semibold">@item.mov.ResumenUsuario</div>
                                </td>
                                <td>
                                    @foreach (var doc in item.mov.Documentos)
                                    {
                                        <span class="badge bg-light text-dark border me-1 mb-1">@doc</span>
                                    }
                                </td>
                                <td>
                                    <span class="fw-semibold text-secondary">@item.mov.OficinaOrigen</span>
                                    <i class="bi bi-arrow-right mx-2 text-primary"></i>
                                    <span class="fw-bold text-success">@item.mov.OficinaDestino</span>
                                </td>
                                <td>@item.mov.FechaMovimiento.ToString("dd/MM/yyyy")</td>
                                <td>@item.mov.FechaMovimiento.ToString("HH:mm")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter] public long Id { get; set; }

    private MaeDocumento? documento;
    private List<EventoExpedienteSimplificado> movimientos = [];
    private bool cargando = true;
    private bool noEncontrado;

    private string filtroDestino = string.Empty;
    private string filtroTexto = string.Empty;
    private DateTime? filtroDesde;
    private DateTime? filtroHasta;

    private List<string> destinosDisponibles = [];

    private IEnumerable<EventoExpedienteSimplificado> MovimientosFiltrados => movimientos
        .Where(m => string.IsNullOrWhiteSpace(filtroDestino) ||
                    string.Equals(m.OficinaDestino, filtroDestino, StringComparison.OrdinalIgnoreCase))
        .Where(m => string.IsNullOrWhiteSpace(filtroTexto) ||
                    ($"{string.Join(" ", m.Documentos)} {m.ResumenUsuario} {m.OficinaOrigen} {m.OficinaDestino} {m.ObservacionOriginal}".Contains(filtroTexto, StringComparison.OrdinalIgnoreCase)))
        .Where(m => !filtroDesde.HasValue || m.FechaMovimiento.Date >= filtroDesde.Value.Date)
        .Where(m => !filtroHasta.HasValue || m.FechaMovimiento.Date <= filtroHasta.Value.Date)
        .OrderByDescending(m => m.FechaMovimiento)
        .ThenByDescending(m => m.UltimoIdMovimiento);

    protected override async Task OnParametersSetAsync()
    {
        cargando = true;
        noEncontrado = false;
        movimientos.Clear();

        try
        {
            // BLINDAJE 1: Obtener el documento base
            var docs = await RepoDocs.GetFilteredAsync(d => d.IdDocumento == Id, "IdTipoNavigation,IdEstadoActualNavigation");
            documento = docs.FirstOrDefault();

            if (documento is null)
            {
                noEncontrado = true;
                cargando = false;
                return;
            }

            // BLINDAJE 2: Obtener IDs de la familia (hilo)
            var familia = await RepoDocs.GetFilteredAsync(d => d.IdHiloConversacion == documento.IdHiloConversacion);
            var idsEnHilo = familia.Select(d => d.IdDocumento).ToList();

            // BLINDAJE 3: Obtener movimientos con navegación cargada
            var movs = await RepoMovimientos.GetFilteredAsync(
                m => idsEnHilo.Contains(m.IdDocumento),
                "IdDocumentoNavigation.IdTipoNavigation,IdOficinaOrigenNavigation,IdOficinaDestinoNavigation"
            );

            movimientos = ExpedienteMovimientoSimplificador.ConstruirEventos(movs, documento.IdDocumento);

            // Cargar lista de destinos para el filtro desplegable
            destinosDisponibles = movimientos
                .Select(m => m.OficinaDestino)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n)
                .Cast<string>()
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en recorrido: {ex.Message}");
            noEncontrado = true;
        }
        finally
        {
            cargando = false;
        }
    }


}
