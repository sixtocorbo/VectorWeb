@page "/documentos"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Timers
@using VectorWeb.Models
@inject IDbContextFactory<SecretariaDbContext> DbContextFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@rendermode InteractiveServer
@implements IDisposable

<h3>
    <i class="bi bi-inbox"></i> Oficina: <strong>@nombreOficinaUsuario</strong>
</h3>

<div class="row g-2 mb-3 align-items-end">
    <div class="col-md-6">
        <a href="documentos/nuevo" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Nuevo Ingreso
        </a>
    </div>
    <div class="col-md-6 text-end">
        <div class="form-check form-switch d-inline-block office-switch">
            <input id="verTodoOficinas" class="form-check-input" type="checkbox" @bind="verTodo" @bind:after="CargarDocumentos">
            <label class="form-check-label" for="verTodoOficinas">Ver documentos de otras oficinas</label>
        </div>
    </div>
</div>

<div class="controls-panel mb-3">
    <div class="row g-3 align-items-end">
        <div class="col-lg-8">
            <label for="buscadorDocumentos" class="form-label fw-semibold">Buscador en bandeja</label>
            <div class="search-input-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input id="buscadorDocumentos"
                       class="form-control search-input"
                       placeholder="Buscar por número, asunto, tipo, oficina o estado"
                       @bind="FiltroBusqueda"
                       @bind:event="oninput" />
            </div>
            <small class="text-muted d-block mt-1">Podés escribir varias palabras en cualquier orden; se buscarán en todos los campos.</small>
        </div>
        <div class="col-sm-6 col-lg-4">
            <label for="tamanoPagina" class="form-label fw-semibold">Resultados por página</label>
            <select id="tamanoPagina" class="form-select" @bind="TamanoPagina" @bind:after="OnTamanoPaginaChanged">
                @foreach (var opcion in opcionesTamanoPagina)
                {
                    <option value="@opcion">@opcion</option>
                }
            </select>
        </div>
    </div>
</div>

<div class="status-legend mb-3">
    <span class="badge bg-danger me-2">Rojo</span>
    <span class="me-3">Trámite vencido o de atención urgente.</span>
    <span class="badge bg-info me-2">Azul</span>
    <span>Trámite en plazo o en curso normal.</span>
</div>

@if (listaDocs is null)
{
    <p><em>Cargando bandeja...</em></p>
}
else
{
    @if (!DocumentosPaginados.Any())
    {
        <p><em>No se encontraron documentos con los filtros actuales.</em></p>
    }

    <table class="table table-striped table-hover" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th style="width: 120px;">Estado</th>
                <th style="width: 95px;">Fecha</th>
                <th style="width: 170px;">Nro. / Tipo</th>
                <th>Asunto</th>
                <th style="width: 170px;">Ubicación</th>
                <th style="width: 200px;" class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var doc in DocumentosPaginados)
            {
                <tr>
                    <td>
                        <span class="badge @(EsRojo(doc.EstadoSemaforo) ? "bg-danger" : "bg-info") text-truncate" style="max-width: 100%;" title="@doc.IdEstadoActualNavigation?.Nombre">
                            @doc.IdEstadoActualNavigation?.Nombre
                        </span>
                    </td>
                    <td class="small text-nowrap">@doc.FechaCreacion?.ToString("dd/MM/yy")</td>
                    <td>
                        <div class="fw-semibold small text-truncate" title="@doc.NumeroOficial">@doc.NumeroOficial</div>
                        <div class="text-muted small text-truncate" title="@doc.IdTipoNavigation?.Nombre">@doc.IdTipoNavigation?.Nombre</div>
                        @if (doc.IdDocumentoPadre.HasValue)
                        {
                            var referenciaPadre = ObtenerReferenciaPadre(doc.IdDocumentoPadre.Value);
                            <a href="documentos/historial/@doc.IdDocumentoPadre"
                               class="badge bg-warning text-dark mt-1 text-decoration-none"
                               title="Documento hijo de @referenciaPadre. Abrir historial de movimientos del padre.">
                                Hijo de @referenciaPadre
                            </a>
                        }
                        else if (cantidadHijosPorPadre.TryGetValue(doc.IdDocumento, out var cantidadHijos))
                        {
                            <a href="documentos/historial/@doc.IdDocumento"
                               class="badge bg-primary mt-1 text-decoration-none"
                               title="Documento padre con @cantidadHijos documento(s) hijo(s). Abrir historial de movimientos.">
                                Padre (@cantidadHijos)
                            </a>
                        }
                    </td>
                    <td class="text-truncate" title="@doc.Asunto">@doc.Asunto</td>
                    <td title="@doc.IdOficinaActualNavigation?.Nombre">
                        @if (doc.IdOficinaActual == idOficinaUsuario)
                        {
                            <span class="badge bg-success">EN TU BANDEJA</span>
                        }
                        else
                        {
                            <span class="small text-truncate d-inline-block" style="max-width: 100%;">@doc.IdOficinaActualNavigation?.Nombre</span>
                        }
                    </td>
                    <td class="text-end text-nowrap">
                        <button class="btn btn-warning btn-sm text-dark ms-1"
                                title="Dar pase del documento. El sistema detecta automáticamente si el documento está en tu oficina o en una remota."
                                @onclick="() => IrAPase(doc)">
                            <i class="bi bi-arrow-right-circle"></i> Dar pase
                        </button>

                        <a href="documentos/historial/@doc.IdDocumento" class="btn btn-info btn-sm text-white ms-1" title="Ver movimientos">
                            <i class="bi bi-clock-history"></i> Historial
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex flex-column align-items-center gap-2 mt-3">
        <div class="btn-group" role="group" aria-label="Paginación">
            <button class="btn btn-outline-secondary" @onclick="PaginaAnterior" disabled="@(PaginaActualEfectiva == 1)">Anterior</button>
            <button class="btn btn-outline-secondary disabled">Página @PaginaActualEfectiva de @TotalPaginas</button>
            <button class="btn btn-outline-secondary" @onclick="PaginaSiguiente" disabled="@(PaginaActualEfectiva >= TotalPaginas)">Siguiente</button>
        </div>
        <small class="text-muted">Mostrando @DesdeRegistro a @HastaRegistro de @TotalRegistros documento(s)</small>
    </div>
}

@code {
    private List<MaeDocumento>? listaDocs;
    private Dictionary<long, int> cantidadHijosPorPadre = [];
    private Dictionary<long, string> referenciasPadrePorId = [];
    private Timer? timerBusqueda;
    private string filtroBusqueda = string.Empty;
    private int paginaActual = 1;
    private int tamanoPagina = 10;
    private int idOficinaUsuario;
    private string nombreOficinaUsuario = "Mi Oficina";
    private bool verTodo;
    private static readonly int[] opcionesTamanoPagina = [10, 20, 50];

    private IEnumerable<MaeDocumento> DocumentosPaginados => listaDocs ?? [];

    private int TotalRegistros { get; set; }
    private int TotalPaginas => Math.Max(1, (int)Math.Ceiling(TotalRegistros / (double)tamanoPagina));
    private int PaginaActualEfectiva => Math.Max(1, Math.Min(paginaActual, TotalPaginas));
    private int DesdeRegistro => TotalRegistros == 0 ? 0 : ((PaginaActualEfectiva - 1) * tamanoPagina) + 1;
    private int HastaRegistro => Math.Min(PaginaActualEfectiva * tamanoPagina, TotalRegistros);

    private string FiltroBusqueda
    {
        get => filtroBusqueda;
        set
        {
            if (filtroBusqueda == value)
            {
                return;
            }

            filtroBusqueda = value;
            paginaActual = 1;
            ReiniciarTemporizadorBusqueda();
        }
    }

    private int TamanoPagina
    {
        get => tamanoPagina;
        set
        {
            if (tamanoPagina == value)
            {
                return;
            }

            tamanoPagina = value;
            paginaActual = 1;
        }
    }

    private Task OnTamanoPaginaChanged() => CargarDocumentos();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var claimOficina = user.FindFirst("IdOficina")?.Value;
            if (int.TryParse(claimOficina, out var oficinaId))
            {
                idOficinaUsuario = oficinaId;

                if (idOficinaUsuario > 0)
                {
                    await using var dbContext = await DbContextFactory.CreateDbContextAsync();
                    var oficina = await dbContext.CatOficinas
                        .AsNoTracking()
                        .FirstOrDefaultAsync(o => o.IdOficina == oficinaId);
                    nombreOficinaUsuario = oficina?.Nombre ?? $"Mi Oficina ({oficinaId})";
                }
                else
                {
                    nombreOficinaUsuario = "Todas las oficinas";
                    verTodo = true;
                }
            }
            else
            {
                nombreOficinaUsuario = user.FindFirstValue(ClaimTypes.Name) ?? "Mi Oficina";
            }
        }

        await CargarDocumentos();
    }

    private async Task CargarDocumentos()
    {
        await using var dbContext = await DbContextFactory.CreateDbContextAsync();

        var query = dbContext.MaeDocumentos
            .AsNoTracking()
            .Include(d => d.IdTipoNavigation)
            .Include(d => d.IdOficinaActualNavigation)
            .Include(d => d.IdEstadoActualNavigation)
            .AsQueryable();

        if (!verTodo && idOficinaUsuario > 0)
        {
            query = query.Where(d => d.IdOficinaActual == idOficinaUsuario);
        }

        query = AplicarFiltroBusqueda(query);

        TotalRegistros = await query.CountAsync();

        if (paginaActual > TotalPaginas)
        {
            paginaActual = TotalPaginas;
        }

        listaDocs = await query
            .OrderByDescending(d => d.FechaCreacion)
            .Skip((PaginaActualEfectiva - 1) * tamanoPagina)
            .Take(tamanoPagina)
            .ToListAsync();

        var idsPagina = listaDocs.Select(d => d.IdDocumento).ToList();
        var idsPadrePagina = listaDocs
            .Where(d => d.IdDocumentoPadre.HasValue)
            .Select(d => d.IdDocumentoPadre!.Value)
            .Distinct()
            .ToList();

        if (idsPadrePagina.Count > 0)
        {
            referenciasPadrePorId = await dbContext.MaeDocumentos
                .AsNoTracking()
                .Where(d => idsPadrePagina.Contains(d.IdDocumento))
                .Include(d => d.IdTipoNavigation)
                .Select(d => new
                {
                    d.IdDocumento,
                    Numero = d.NumeroOficial,
                    Tipo = d.IdTipoNavigation != null ? d.IdTipoNavigation.Nombre : null,
                })
                .ToDictionaryAsync(
                    x => x.IdDocumento,
                    x => ConstruirReferenciaPadre(x.Tipo, x.Numero, x.IdDocumento));
        }
        else
        {
            referenciasPadrePorId = [];
        }

        if (idsPagina.Count == 0)
        {
            cantidadHijosPorPadre = [];
            StateHasChanged();
            return;
        }

        var conteoHijos = await dbContext.MaeDocumentos
            .AsNoTracking()
            .Where(d => d.IdDocumentoPadre.HasValue && idsPagina.Contains(d.IdDocumentoPadre.Value))
            .GroupBy(d => d.IdDocumentoPadre!.Value)
            .Select(g => new { IdPadre = g.Key, Cantidad = g.Count() })
            .ToListAsync();

        cantidadHijosPorPadre = conteoHijos
            .ToDictionary(x => x.IdPadre, x => x.Cantidad);

        StateHasChanged();
    }

    private void ReiniciarTemporizadorBusqueda()
    {
        timerBusqueda?.Stop();
        timerBusqueda?.Dispose();

        var nuevoTimer = new Timer(500)
        {
            AutoReset = false,
        };

        nuevoTimer.Elapsed += (_, _) =>
        {
            _ = InvokeAsync(async () =>
            {
                try
                {
                    if (!ReferenceEquals(timerBusqueda, nuevoTimer))
                    {
                        return;
                    }

                    await CargarDocumentos();
                }
                catch (Exception ex)
                {
                    Console.Error.WriteLine($"Error en búsqueda de documentos: {ex.Message}");
                }
                finally
                {
                    if (ReferenceEquals(timerBusqueda, nuevoTimer))
                    {
                        timerBusqueda?.Dispose();
                        timerBusqueda = null;
                    }
                }
            });
        };

        timerBusqueda = nuevoTimer;
        nuevoTimer.Start();
    }

    public void Dispose()
    {
        timerBusqueda?.Stop();
        timerBusqueda?.Dispose();
        timerBusqueda = null;
    }

    private IQueryable<MaeDocumento> AplicarFiltroBusqueda(IQueryable<MaeDocumento> query)
    {
        var terminos = filtroBusqueda
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        foreach (var termino in terminos)
        {
            var patron = $"%{termino}%";
            query = query.Where(doc =>
                EF.Functions.Like(doc.NumeroOficial ?? string.Empty, patron)
                || EF.Functions.Like(doc.Asunto ?? string.Empty, patron)
                || EF.Functions.Like(doc.IdTipoNavigation!.Nombre ?? string.Empty, patron)
                || EF.Functions.Like(doc.IdOficinaActualNavigation!.Nombre ?? string.Empty, patron)
                || EF.Functions.Like(doc.IdEstadoActualNavigation!.Nombre ?? string.Empty, patron));
        }

        return query;
    }

    private async Task PaginaAnterior()
    {
        if (PaginaActualEfectiva > 1)
        {
            paginaActual = PaginaActualEfectiva - 1;
            await CargarDocumentos();
        }
    }

    private async Task PaginaSiguiente()
    {
        if (PaginaActualEfectiva < TotalPaginas)
        {
            paginaActual = PaginaActualEfectiva + 1;
            await CargarDocumentos();
        }
    }

    private static bool EsRojo(string? estadoSemaforo)
        => string.Equals(estadoSemaforo, "ROJO", StringComparison.OrdinalIgnoreCase);

    private string ObtenerReferenciaPadre(long idPadre)
        => referenciasPadrePorId.TryGetValue(idPadre, out var referencia)
            ? referencia
            : $"#{idPadre}";

    private static string ConstruirReferenciaPadre(string? tipo, string? numero, long idPadre)
    {
        var partes = new[] { tipo, numero }
            .Where(parte => !string.IsNullOrWhiteSpace(parte))
            .Select(parte => parte!.Trim())
            .ToList();

        return partes.Count > 0
            ? string.Join(' ', partes)
            : $"#{idPadre}";
    }

    private void IrAPase(MaeDocumento doc)
    {
        Navegador.NavigateTo($"documentos/pase/{doc.IdDocumento}");
    }

}
