@page "/documentos"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.ver")]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Timers
@using VectorWeb.Models
@using VectorWeb.Services
@inject IDbContextFactory<SecretariaDbContext> DbContextFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject DocumentosService DocumentoService
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Bandeja de Documentos - Vector</PageTitle>

<style>
    /* Estructura mejorada */
    .page-header {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border-left: 6px solid #0d6efd;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden; /* Para que el radio se aplique a la tabla */
    }

    /* Control de tabla - Quitamos fixed para evitar que se encimen */
    .table {
        margin-bottom: 0;
        font-size: 0.88rem;
    }

        .table thead th {
            background-color: #f1f4f8;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.03em;
            padding: 1rem 0.75rem;
            border-bottom: 2px solid #dee2e6;
        }

    /* Celdas de texto con control de desbordamiento */
    .asunto-cell {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-width: 200px;
        max-width: 300px;
        line-height: 1.4;
        white-space: normal; /* Permite el quiebre de línea */
    }

    .descripcion-cell {
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #6c757d;
    }

    /* Buscador estilizado */
    .search-input-wrapper {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
    }

    .search-input {
        padding-left: 45px !important;
        height: 45px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
        transition: all 0.2s;
    }

        .search-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
        }

    /* Badges de estado */
    .badge-status {
        padding: 0.5em 0.8em;
        border-radius: 50rem; /* Pill style */
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
    }

    /* Botones de acción compactos */
    .btn-action {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
</style>

<div class="container-fluid py-4">
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item small"><a href="#">Sistema</a></li>
                    <li class="breadcrumb-item active small" aria-current="page">Documentos</li>
                </ol>
            </nav>
            <h3 class="mb-0 fw-bold text-dark">
                <i class="bi bi-inbox-fill text-primary me-2"></i>
                @nombreOficinaUsuario
            </h3>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="card border-0 bg-white shadow-sm px-3 py-2 rounded-4">
                <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Pendientes</div>
                <div class="h5 mb-0 fw-bold text-primary">@totalExpedientesPendientes</div>
            </div>
            <a href="documentos/nuevo" class="btn btn-primary btn-lg shadow px-4 rounded-pill fw-bold">
                <i class="bi bi-plus-lg me-1"></i> Nuevo Ingreso
            </a>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 rounded-4">
        <div class="card-body p-4">
            <div class="row g-4 align-items-end">
                <div class="col-lg-6">
                    <label class="form-label fw-bold small text-muted">Buscador inteligente</label>
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input class="form-control search-input shadow-none"
                               placeholder="Buscar por número, ID de ingreso, asunto o descripción..."
                               @bind="FiltroBusqueda"
                               @bind:event="oninput" />
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Registros</label>
                    <select class="form-select border-light bg-light fw-bold" @bind="TamanoPagina" @bind:after="OnTamanoPaginaChanged">
                        @foreach (var opcion in opcionesTamanoPagina)
                        {
                            <option value="@opcion">Mostrar @opcion</option>
                        }
                    </select>
                </div>

                <div class="col-md-3 d-flex align-items-center justify-content-md-end pb-2">
                    <div class="form-check form-switch custom-switch">
                        <input class="form-check-input" type="checkbox" id="swGlobal" @bind="mostrarSoloMiBandeja" @bind:after="OnToggleVistaChanged">
                        <label class="form-check-label fw-bold small" for="swGlobal">Mi bandeja</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex align-items-center gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm rounded-pill @(string.IsNullOrEmpty(filtroSemaforo) ? "btn-dark shadow" : "btn-outline-secondary")"
                @onclick="() => FiltrarPorEstado(null)">
            <i class="bi bi-list-task me-1"></i> Todos
        </button>

        <button class="btn btn-sm rounded-pill @(EsSemaforoActivo("ROJO") ? "btn-danger shadow" : "btn-outline-danger")"
                @onclick='() => FiltrarPorEstado("ROJO")'>
            <i class="bi bi-fire me-1"></i> Urgentes
            <span class="badge bg-white text-danger ms-1">@totalRojo</span>
        </button>

        <button class="btn btn-sm rounded-pill @(EsSemaforoActivo("AMARILLO") ? "btn-warning shadow" : "btn-outline-warning text-dark")"
                @onclick='() => FiltrarPorEstado("AMARILLO")'>
            <i class="bi bi-clock-history me-1"></i> En Riesgo
            <span class="badge bg-dark text-warning ms-1">@totalAmarillo</span>
        </button>

        <button class="btn btn-sm rounded-pill @(EsSemaforoActivo("VERDE") ? "btn-success shadow" : "btn-outline-success")"
                @onclick='() => FiltrarPorEstado("VERDE")'>
            <i class="bi bi-check-all me-1"></i> En Plazo
            <span class="badge bg-white text-success ms-1">@totalVerde</span>
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(mensajeError))
    {
        <div class="alert alert-danger shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@mensajeError
        </div>
    }

    @if (procesandoEliminacion)
    {
        <div class="alert alert-warning py-2" role="status">
            <span class="spinner-border spinner-border-sm me-2"></span>Eliminando documento y vinculaciones...
        </div>
    }

    @if (listaDocs is null)
    {
        <div class="text-center py-5">
            <div class="spinner-grow text-primary" role="status"></div>
            <p class="mt-3 text-muted fw-bold">Organizando tus documentos...</p>
        </div>
    }
    else
    {
        <div class="table-container shadow-sm border">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 130px;">Estado</th>
                            <th style="width: 100px;">Fecha</th>
                            <th style="width: 160px;">Identificación</th>
                            <th style="width: 140px;">Vinculación</th>
                            <th>Asunto / Descripción</th>
                            <th style="width: 150px;">Ubicación</th>
                            <th class="text-end" style="width: 320px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var doc in DocumentosPaginados)
                        {
                            <tr>
                                <td>
                                    <span class="badge badge-status @ObtenerClaseSemaforo(doc.EstadoSemaforo)" title="@doc.IdEstadoActualNavigation?.Nombre">
                                        @doc.IdEstadoActualNavigation?.Nombre
                                    </span>
                                </td>
                                <td class="text-muted fw-medium">@doc.FechaCreacion?.ToString("dd MMM yyyy")</td>
                                <td>
                                    <div class="fw-bold text-primary mb-0">@doc.NumeroOficial</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">@doc.IdTipoNavigation?.Nombre</div>
                                </td>
                                <td>
                                    @if (doc.IdDocumentoPadre.HasValue)
                                    {
                                        <div class="badge bg-light text-dark border fw-normal py-1 px-2" title="Hijo de: @ObtenerReferenciaPadre(doc.IdDocumentoPadre.Value)">
                                            <i class="bi bi-link-45deg"></i> Hijo (@doc.IdDocumentoPadre.Value)
                                        </div>
                                    }
                                    @if (cantidadHijosPorPadre.TryGetValue(doc.IdDocumento, out var cantHijos) && cantHijos > 0)
                                    {
                                        <div class="badge bg-primary-subtle text-primary border border-primary-subtle py-1 px-2 mt-1">
                                            <i class="bi bi-diagram-2"></i> Padre (@cantHijos)
                                        </div>
                                    }
                                </td>
                                <td>
                                    <div class="asunto-cell fw-semibold" title="@doc.Asunto">@doc.Asunto</div>
                                    @if (!string.IsNullOrWhiteSpace(doc.Descripcion))
                                    {
                                        <div class="descripcion-cell mt-1" title="@doc.Descripcion">@doc.Descripcion</div>
                                    }
                                </td>
                                <td>
                                    @if (doc.IdOficinaActual == idOficinaUsuario)
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success-subtle px-2">MI BANDEJA</span>
                                    }
                                    else
                                    {
                                        <div class="text-truncate small fw-medium" style="max-width: 140px;" title="@doc.IdOficinaActualNavigation?.Nombre">
                                            <i class="bi bi-building text-muted"></i> @doc.IdOficinaActualNavigation?.Nombre
                                        </div>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-1 flex-wrap">
                                        <button class="btn btn-sm btn-outline-warning" @onclick="() => IrAPase(doc)"><i class="bi bi-send"></i> Pase</button>
                                        <a class="btn btn-sm btn-outline-info" href="documentos/historial/@doc.IdDocumento"><i class="bi bi-clock-history"></i> Historial</a>
                                        <a class="btn btn-sm btn-outline-secondary" href="documentos/recorrido/@doc.IdDocumento"><i class="bi bi-geo-alt"></i> Recorrido</a>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => IrAEditar(doc.IdDocumento)"><i class="bi bi-pencil-square"></i> Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmarEliminacion(doc.IdDocumento)"><i class="bi bi-trash"></i> Eliminar total</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="text-muted small">
                    Mostrando <strong>@DesdeRegistro</strong> a <strong>@HastaRegistro</strong> de <strong>@TotalRegistros</strong> resultados
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0 shadow-sm">
                        <li class="page-item @(PaginaActualEfectiva == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="PaginaAnterior">Anterior</button>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link bg-white text-dark fw-bold">@PaginaActualEfectiva / @TotalPaginas</span>
                        </li>
                        <li class="page-item @(PaginaActualEfectiva >= TotalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="PaginaSiguiente">Siguiente</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@if (mostrarModalResumenEliminacion && resumenEliminacionActual is not null)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="modal-header text-bg-danger border-bottom-0 p-4">
                    <h5 class="modal-title fw-bold fs-4 d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-3 fs-3"></i> Confirmar eliminación total
                    </h5>
                    <button type="button" class="btn-close btn-close-white" aria-label="Close" @onclick="CancelarEliminacion" disabled="@procesandoEliminacion"></button>
                </div>
                
                <div class="modal-body p-4 bg-light">
                    <div class="bg-white p-3 rounded-3 shadow-sm mb-4 border-start border-danger border-4">
                        <h6 class="fw-bold mb-1">
                            Documento a eliminar: 
                            <strong>@(string.IsNullOrWhiteSpace(resumenEliminacionActual.NumeroOficial) ? $"Documento #{resumenEliminacionActual.IdDocumento}" : resumenEliminacionActual.NumeroOficial)</strong>
                        </h6>
                        @if (!string.IsNullOrWhiteSpace(resumenEliminacionActual.Asunto))
                        {
                            <p class="text-muted small mb-0">Asunto: @resumenEliminacionActual.Asunto</p>
                        }
                    </div>

                    <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center mb-4" role="alert">
                        <i class="bi bi-shield-exclamation fs-3 me-3 text-warning"></i>
                        <div>
                            <strong>¡Atención!</strong> Esta acción es irreversible y eliminará el documento junto con <strong>todos</strong> sus elementos relacionados.
                        </div>
                    </div>

                    <h6 class="fw-bold text-muted text-uppercase small mb-3">Elementos afectados:</h6>
                    
                    <ul class="list-group list-group-flush shadow-sm rounded-3">
                        <li class="list-group-item p-0 border-bottom">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-4 py-3"
                                    @onclick='() => ToggleDetalleEliminacion("documentos-totales")'>
                                <span class="fw-medium"><i class="bi bi-file-earmark-text me-3 text-primary fs-5"></i>Documentos totales</span>
                                <span class="d-flex align-items-center gap-3">
                                    <span class="badge bg-primary rounded-pill fs-6 px-3">@resumenEliminacionActual.TotalDocumentos</span>
                                    <i class="bi text-muted @(EstaDetalleExpandido("documentos-totales") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("documentos-totales"))
                            {
                                <div class="px-4 py-3 bg-white border-top small text-secondary">
                                    <div class="fw-semibold text-dark">
                                        Principal: @(string.IsNullOrWhiteSpace(resumenEliminacionActual.NumeroOficial) ? $"Documento #{resumenEliminacionActual.IdDocumento}" : resumenEliminacionActual.NumeroOficial)
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(resumenEliminacionActual.Asunto))
                                    {
                                        <div class="mb-2">Asunto: @resumenEliminacionActual.Asunto</div>
                                    }
                                    @if (resumenEliminacionActual.DocumentosHijos.Count > 0)
                                    {
                                        <hr class="my-2 text-light" />
                                        @foreach (var hijo in resumenEliminacionActual.DocumentosHijos)
                                        {
                                            <div>• Hijo: @(string.IsNullOrWhiteSpace(hijo.NumeroOficial) ? $"Documento #{hijo.IdDocumento}" : hijo.NumeroOficial) - Asunto: @(string.IsNullOrWhiteSpace(hijo.Asunto) ? "Sin asunto" : hijo.Asunto)</div>
                                        }
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0 border-bottom">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-4 py-3"
                                    @onclick='() => ToggleDetalleEliminacion("documentos-hijos")'>
                                <span class="fw-medium"><i class="bi bi-diagram-2 me-3 text-secondary fs-5"></i>Documentos hijos</span>
                                <span class="d-flex align-items-center gap-3">
                                    <span class="badge bg-secondary rounded-pill fs-6 px-3">@resumenEliminacionActual.TotalDocumentosHijos</span>
                                    <i class="bi text-muted @(EstaDetalleExpandido("documentos-hijos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("documentos-hijos"))
                            {
                                <div class="px-4 py-3 bg-white border-top small text-secondary">
                                    @if (resumenEliminacionActual.DocumentosHijos.Count == 0)
                                    {
                                        <div class="fst-italic">Sin documentos hijos.</div>
                                    }
                                    else
                                    {
                                        @foreach (var hijo in resumenEliminacionActual.DocumentosHijos)
                                        {
                                            <div class="mb-2 pb-2 border-bottom border-light">
                                                <div class="fw-semibold text-dark">@(string.IsNullOrWhiteSpace(hijo.NumeroOficial) ? $"Documento #{hijo.IdDocumento}" : hijo.NumeroOficial)</div>
                                                @if (!string.IsNullOrWhiteSpace(hijo.Asunto))
                                                {
                                                    <div>Asunto: @hijo.Asunto</div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0 border-bottom">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-4 py-3"
                                    @onclick='() => ToggleDetalleEliminacion("movimientos")'>
                                <span class="fw-medium"><i class="bi bi-send me-3 text-warning fs-5"></i>Pases / movimientos</span>
                                <span class="d-flex align-items-center gap-3">
                                    <span class="badge bg-warning text-dark rounded-pill fs-6 px-3">@resumenEliminacionActual.TotalPases</span>
                                    <i class="bi text-muted @(EstaDetalleExpandido("movimientos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("movimientos"))
                            {
                                <div class="px-4 py-3 bg-white border-top small">
                                    @if (resumenEliminacionActual.Movimientos.Count == 0)
                                    {
                                        <div class="text-secondary fst-italic">Sin movimientos.</div>
                                    }
                                    else
                                    {
                                        <div class="table-responsive border rounded-3">
                                            <table class="table table-sm table-striped table-hover align-middle mb-0">
                                                <thead class="table-light text-secondary">
                                                    <tr>
                                                        <th>ID</th><th>Doc</th><th>Fecha</th><th>Origen</th><th>Destino</th><th>Observación</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var movimiento in resumenEliminacionActual.Movimientos)
                                                    {
                                                        <tr>
                                                            <td>#@movimiento.IdMovimiento</td>
                                                            <td>#@movimiento.IdDocumento</td>
                                                            <td class="text-nowrap">@(movimiento.FechaMovimiento?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                                                            <td>@movimiento.OficinaOrigen</td>
                                                            <td>@movimiento.OficinaDestino</td>
                                                            <td><span class="text-truncate d-inline-block" style="max-width: 150px;" title="@movimiento.Observacion">@(string.IsNullOrWhiteSpace(movimiento.Observacion) ? "-" : movimiento.Observacion)</span></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0 border-bottom">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-4 py-3"
                                    @onclick='() => ToggleDetalleEliminacion("adjuntos")'>
                                <span class="fw-medium"><i class="bi bi-paperclip me-3 text-info fs-5"></i>Adjuntos</span>
                                <span class="d-flex align-items-center gap-3">
                                    <span class="badge bg-info text-dark rounded-pill fs-6 px-3">@resumenEliminacionActual.TotalAdjuntos</span>
                                    <i class="bi text-muted @(EstaDetalleExpandido("adjuntos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("adjuntos"))
                            {
                                <div class="px-4 py-3 bg-white border-top small text-secondary">
                                    @if (resumenEliminacionActual.Adjuntos.Count == 0)
                                    {
                                        <div class="fst-italic">Sin adjuntos.</div>
                                    }
                                    else
                                    {
                                        <ul class="list-unstyled mb-0">
                                        @foreach (var adjunto in resumenEliminacionActual.Adjuntos)
                                        {
                                            <li class="mb-1"><i class="bi bi-file-earmark me-2"></i>#@adjunto.IdAdjunto · Doc #@adjunto.IdDocumento · <strong class="text-dark">@adjunto.DisplayName</strong> · @adjunto.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</li>
                                        }
                                        </ul>
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0 border-bottom">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-4 py-3"
                                    @onclick='() => ToggleDetalleEliminacion("vinculos")'>
                                <span class="fw-medium"><i class="bi bi-link-45deg me-3 text-dark fs-5"></i>Vínculos de respaldo</span>
                                <span class="d-flex align-items-center gap-3">
                                    <span class="badge bg-dark rounded-pill fs-6 px-3">@resumenEliminacionActual.TotalVinculos</span>
                                    <i class="bi text-muted @(EstaDetalleExpandido("vinculos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("vinculos"))
                            {
                                <div class="px-4 py-3 bg-white border-top small text-secondary">
                                    @if (resumenEliminacionActual.VinculosRespaldo.Count == 0)
                                    {
                                        <div class="fst-italic">Sin vínculos de respaldo.</div>
                                    }
                                    else
                                    {
                                        <ul class="list-unstyled mb-0">
                                        @foreach (var vinculo in resumenEliminacionActual.VinculosRespaldo)
                                        {
                                            <li class="mb-1">Vínculo #@vinculo.IdSalidaDocumentoRespaldo · Salida #@vinculo.IdSalida · Doc #@vinculo.IdDocumento · @vinculo.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</li>
                                        }
                                        </ul>
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-4 py-3"
                                    @onclick='() => ToggleDetalleEliminacion("salidas")'>
                                <span class="fw-medium"><i class="bi bi-box-arrow-in-right me-3 text-danger fs-5"></i>Salidas afectadas</span>
                                <span class="d-flex align-items-center gap-3">
                                    <span class="badge bg-danger rounded-pill fs-6 px-3">@resumenEliminacionActual.TotalSalidasAfectadas</span>
                                    <i class="bi text-muted @(EstaDetalleExpandido("salidas") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("salidas"))
                            {
                                <div class="px-4 py-3 bg-white border-top small text-secondary">
                                    @if (resumenEliminacionActual.SalidasAfectadas.Count == 0)
                                    {
                                        <div class="fst-italic">Sin salidas afectadas.</div>
                                    }
                                    else
                                    {
                                        <ul class="list-unstyled mb-0">
                                        @foreach (var salida in resumenEliminacionActual.SalidasAfectadas)
                                        {
                                            <li class="mb-2 pb-1 border-bottom border-light">
                                                <i class="bi bi-door-open me-2"></i>Salida #@salida.IdSalida · Resp: #@salida.IdDocumentoRespaldo<br/>
                                                <span class="ms-4">@salida.LugarTrabajo · @salida.FechaInicio.ToString("dd/MM/yyyy") - @salida.FechaVencimiento.ToString("dd/MM/yyyy")</span> · 
                                                <span class="badge @(salida.Activo == true ? "bg-success" : "bg-secondary")">@(salida.Activo == true ? "Activa" : "Inactiva")</span>
                                            </li>
                                        }
                                        </ul>
                                    }
                                </div>
                            }
                        </li>
                    </ul>
                </div>

                <div class="modal-footer bg-light border-top-0 p-4 pt-2">
                    <button class="btn btn-light fw-bold px-4 rounded-pill border shadow-sm" @onclick="CancelarEliminacion" disabled="@procesandoEliminacion">Cancelar</button>
                    <button class="btn btn-danger fw-bold px-4 rounded-pill shadow-sm d-flex align-items-center gap-2" @onclick="EjecutarEliminacion" disabled="@procesandoEliminacion">
                        @if (procesandoEliminacion)
                        {
                            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                            <span role="status">Eliminando...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash3-fill"></i> <span>Confirmar Eliminación Definitiva</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    private List<MaeDocumento>? listaDocs;
    private Dictionary<long, int> cantidadHijosPorPadre = [];
    private Dictionary<long, string> referenciasPadrePorId = [];
    private Timer? timerBusqueda;
    private string filtroBusqueda = string.Empty;
    private int paginaActual = 1;
    private int tamanoPagina = 10;
    private int idOficinaUsuario;
    private string nombreOficinaUsuario = "Mi Oficina";
    private int totalExpedientesPendientes;
    private bool mostrarSoloMiBandeja = true;
    private string? filtroSemaforo;
    private int totalRojo;
    private int totalAmarillo;
    private int totalVerde;
    private bool procesandoEliminacion;
    private bool mostrarModalResumenEliminacion;
    private string? mensajeError;
    private ResumenEliminacionDocumento? resumenEliminacionActual;
    private readonly HashSet<string> detallesEliminacionExpandidos = [];
    private const int DiasRiesgoSemaforo = 3;
    private const string CollationBusquedaSinAcentos = "Modern_Spanish_CI_AI";
    private static readonly int[] opcionesTamanoPagina = [10, 20, 50, 100];

    private IEnumerable<MaeDocumento> DocumentosPaginados => listaDocs ?? [];
    private int TotalRegistros { get; set; }
    private int TotalPaginas => Math.Max(1, (int)Math.Ceiling(TotalRegistros / (double)tamanoPagina));
    private int PaginaActualEfectiva => Math.Max(1, Math.Min(paginaActual, TotalPaginas));
    private int DesdeRegistro => TotalRegistros == 0 ? 0 : ((PaginaActualEfectiva - 1) * tamanoPagina) + 1;
    private int HastaRegistro => Math.Min(PaginaActualEfectiva * tamanoPagina, TotalRegistros);

    private string FiltroBusqueda
    {
        get => filtroBusqueda;
        set { if (filtroBusqueda == value) return; filtroBusqueda = value; paginaActual = 1; ReiniciarTemporizadorBusqueda(); }
    }

    private int TamanoPagina
    {
        get => tamanoPagina;
        set { if (tamanoPagina == value) return; tamanoPagina = value; paginaActual = 1; }
    }

    private Task OnTamanoPaginaChanged() => CargarDocumentos();

    private Task OnToggleVistaChanged()
    {
        paginaActual = 1;
        return CargarDocumentos();
    }

    private bool EsSemaforoActivo(string estado) => string.Equals(filtroSemaforo, estado, StringComparison.OrdinalIgnoreCase);

    private async Task FiltrarPorEstado(string? estado)
    {
        filtroSemaforo = estado;
        paginaActual = 1;
        await CargarDocumentos();
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var claimOficina = user.FindFirst("IdOficina")?.Value;
            if (int.TryParse(claimOficina, out var ofId))
            {
                idOficinaUsuario = ofId;
                await using var db = await DbContextFactory.CreateDbContextAsync();
                var of = await db.CatOficinas.AsNoTracking().FirstOrDefaultAsync(o => o.IdOficina == idOficinaUsuario);
                nombreOficinaUsuario = of?.Nombre ?? $"Oficina {idOficinaUsuario}";
                if (idOficinaUsuario <= 0) mostrarSoloMiBandeja = false;
            }
        }
        await CargarDocumentos();
    }

    private async Task CargarDocumentos()
    {
        await using var db = await DbContextFactory.CreateDbContextAsync();

        // 1. Definimos la consulta base: SÓLO documentos RAÍZ (sin padre)
        var qBase = db.MaeDocumentos.AsNoTracking()
            .Where(d => d.IdDocumentoPadre == null)
            .Include(d => d.IdTipoNavigation)
            .Include(d => d.IdOficinaActualNavigation)
            .Include(d => d.IdEstadoActualNavigation)
            .AsQueryable();

        // 2. Filtro por Oficina
        if (mostrarSoloMiBandeja && idOficinaUsuario > 0)
        {
            qBase = qBase.Where(d => d.IdOficinaActual == idOficinaUsuario);
        }

        totalExpedientesPendientes = await qBase.CountAsync();
        var qConBusqueda = AplicarFiltroBusqueda(qBase);

        var fechaHoy = DateTime.Today;
        var fechaRiesgo = fechaHoy.AddDays(DiasRiesgoSemaforo);

        totalRojo = await qConBusqueda.CountAsync(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value < fechaHoy);
        totalAmarillo = await qConBusqueda.CountAsync(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value >= fechaHoy && d.FechaVencimiento.Value <= fechaRiesgo);
        totalVerde = await qConBusqueda.CountAsync(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value > fechaRiesgo);

        var q = AplicarFiltroSemaforo(qConBusqueda, fechaHoy, fechaRiesgo);

        TotalRegistros = await q.CountAsync();
        if (paginaActual > TotalPaginas) paginaActual = TotalPaginas;

        listaDocs = await q.OrderByDescending(d => d.FechaCreacion)
                           .ThenByDescending(d => d.IdDocumento)
                           .Skip((PaginaActualEfectiva - 1) * tamanoPagina)
                           .Take(tamanoPagina)
                           .ToListAsync();

        var idsVisibles = listaDocs.Select(d => d.IdDocumento).ToList();

        if (idsVisibles.Any())
        {
            var conteos = await db.MaeDocumentos.AsNoTracking()
                .Where(d => d.IdDocumentoPadre.HasValue && idsVisibles.Contains(d.IdDocumentoPadre.Value))
                .GroupBy(d => d.IdDocumentoPadre!.Value)
                .Select(g => new { IdPadre = g.Key, Cantidad = g.Count() })
                .ToListAsync();

            cantidadHijosPorPadre = conteos.ToDictionary(k => k.IdPadre, v => v.Cantidad);
            referenciasPadrePorId.Clear();
        }
        else
        {
            cantidadHijosPorPadre.Clear();
            referenciasPadrePorId.Clear();
        }

        StateHasChanged();
    }

    private void ReiniciarTemporizadorBusqueda()
    {
        timerBusqueda?.Stop(); timerBusqueda?.Dispose();
        var nT = new Timer(500) { AutoReset = false };
        nT.Elapsed += (_, _) => { _ = InvokeAsync(async () => { await CargarDocumentos(); }); };
        timerBusqueda = nT; nT.Start();
    }

    private IQueryable<MaeDocumento> AplicarFiltroBusqueda(IQueryable<MaeDocumento> q)
    {
        if (string.IsNullOrWhiteSpace(filtroBusqueda)) return q;
        var tms = filtroBusqueda.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        foreach (var t in tms)
        {
            var p = $"%{t}%";
            var esNumero = long.TryParse(t, out var idDocumentoBuscado);

            q = q.Where(d =>
                (esNumero && d.IdDocumento == idDocumentoBuscado)
                || (d.NumeroOficial != null && EF.Functions.Like(EF.Functions.Collate(d.NumeroOficial, CollationBusquedaSinAcentos), p))
                || (d.NumeroInterno != null && EF.Functions.Like(EF.Functions.Collate(d.NumeroInterno, CollationBusquedaSinAcentos), p))
                || (d.Asunto != null && EF.Functions.Like(EF.Functions.Collate(d.Asunto, CollationBusquedaSinAcentos), p))
                || (d.Descripcion != null && EF.Functions.Like(EF.Functions.Collate(d.Descripcion, CollationBusquedaSinAcentos), p))
                || (d.IdTipoNavigation != null && d.IdTipoNavigation.Nombre != null && EF.Functions.Like(EF.Functions.Collate(d.IdTipoNavigation.Nombre, CollationBusquedaSinAcentos), p))
                || (d.IdOficinaActualNavigation != null && d.IdOficinaActualNavigation.Nombre != null && EF.Functions.Like(EF.Functions.Collate(d.IdOficinaActualNavigation.Nombre, CollationBusquedaSinAcentos), p))
                || (d.IdEstadoActualNavigation != null && d.IdEstadoActualNavigation.Nombre != null && EF.Functions.Like(EF.Functions.Collate(d.IdEstadoActualNavigation.Nombre, CollationBusquedaSinAcentos), p)));
        }
        return q;
    }

    private IQueryable<MaeDocumento> AplicarFiltroSemaforo(IQueryable<MaeDocumento> q, DateTime fechaHoy, DateTime fechaRiesgo)
    {
        if (string.IsNullOrWhiteSpace(filtroSemaforo)) return q;

        return filtroSemaforo.ToUpperInvariant() switch
        {
            "ROJO" => q.Where(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value < fechaHoy),
            "AMARILLO" => q.Where(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value >= fechaHoy && d.FechaVencimiento.Value <= fechaRiesgo),
            "VERDE" => q.Where(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value > fechaRiesgo),
            _ => q
        };
    }

    private async Task ConfirmarEliminacion(long idDocumento)
    {
        mensajeError = null;
        procesandoEliminacion = false;
        resumenEliminacionActual = await DocumentoService.ObtenerResumenEliminacionAsync(idDocumento);

        if (resumenEliminacionActual is null)
        {
            mensajeError = "No se pudo obtener el resumen del documento a eliminar.";
            return;
        }

        detallesEliminacionExpandidos.Clear();
        mostrarModalResumenEliminacion = true;
    }

    private void CancelarEliminacion()
    {
        if (procesandoEliminacion) return;
        mostrarModalResumenEliminacion = false;
        resumenEliminacionActual = null;
        detallesEliminacionExpandidos.Clear();
    }

    private async Task EjecutarEliminacion()
    {
        if (resumenEliminacionActual is null) return;

        procesandoEliminacion = true;
        mensajeError = null;
        StateHasChanged();

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var idUsuario = int.TryParse(user.FindFirstValue(ClaimTypes.NameIdentifier), out var uid) ? uid : 1;

            var resultado = await DocumentoService.EliminarDocumentoTotalAsync(resumenEliminacionActual.IdDocumento, idUsuario);
            if (!resultado.Exitoso)
            {
                mensajeError = resultado.Mensaje;
                return;
            }

            mostrarModalResumenEliminacion = false;
            resumenEliminacionActual = null;
            detallesEliminacionExpandidos.Clear();
            await CargarDocumentos();
        }
        finally
        {
            procesandoEliminacion = false;
            StateHasChanged();
        }
    }

    private void ToggleDetalleEliminacion(string clave)
    {
        if (!detallesEliminacionExpandidos.Add(clave))
        {
            detallesEliminacionExpandidos.Remove(clave);
        }
    }

    private bool EstaDetalleExpandido(string clave) => detallesEliminacionExpandidos.Contains(clave);

    private void IrAEditar(long id) => Navegador.NavigateTo($"documentos/editar/{id}");

    private async Task PaginaAnterior() { if (PaginaActualEfectiva > 1) { paginaActual--; await CargarDocumentos(); } }
    private async Task PaginaSiguiente() { if (PaginaActualEfectiva < TotalPaginas) { paginaActual++; await CargarDocumentos(); } }
    
    private static string ObtenerClaseSemaforo(string? estado) => (estado ?? string.Empty).ToUpperInvariant() switch
    {
        "ROJO" => "bg-danger text-white",
        "AMARILLO" => "bg-warning text-dark",
        "VERDE" => "bg-success text-white",
        _ => "bg-secondary text-white"
    };

    private string ObtenerReferenciaPadre(long id) => referenciasPadrePorId.TryGetValue(id, out var r) ? r : $"#{id}";
    private void IrAPase(MaeDocumento d) => Navegador.NavigateTo($"documentos/pase/{d.IdDocumento}");
    
    public void Dispose() => timerBusqueda?.Dispose();
}
@* @page "/documentos"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.ver")]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Timers
@using VectorWeb.Models
@using VectorWeb.Services
@inject IDbContextFactory<SecretariaDbContext> DbContextFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject DocumentosService DocumentoService
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Bandeja de Documentos - Vector</PageTitle>

<style>
    /* Estructura mejorada */
    .page-header {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border-left: 6px solid #0d6efd;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden; /* Para que el radio se aplique a la tabla */
    }

    /* Control de tabla - Quitamos fixed para evitar que se encimen */
    .table {
        margin-bottom: 0;
        font-size: 0.88rem;
    }

        .table thead th {
            background-color: #f1f4f8;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.03em;
            padding: 1rem 0.75rem;
            border-bottom: 2px solid #dee2e6;
        }

    /* Celdas de texto con control de desbordamiento */
    .asunto-cell {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-width: 200px;
        max-width: 300px;
        line-height: 1.4;
        white-space: normal; /* Permite el quiebre de línea */
    }

    .descripcion-cell {
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #6c757d;
    }

    /* Buscador estilizado */
    .search-input-wrapper {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
    }

    .search-input {
        padding-left: 45px !important;
        height: 45px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
        transition: all 0.2s;
    }

        .search-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
        }

    /* Badges de estado */
    .badge-status {
        padding: 0.5em 0.8em;
        border-radius: 50rem; /* Pill style */
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
    }

    /* Botones de acción compactos */
    .btn-action {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
</style>

<div class="container-fluid py-4">
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item small"><a href="#">Sistema</a></li>
                    <li class="breadcrumb-item active small" aria-current="page">Documentos</li>
                </ol>
            </nav>
            <h3 class="mb-0 fw-bold text-dark">
                <i class="bi bi-inbox-fill text-primary me-2"></i>
                @nombreOficinaUsuario
            </h3>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="card border-0 bg-white shadow-sm px-3 py-2 rounded-4">
                <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Pendientes</div>
                <div class="h5 mb-0 fw-bold text-primary">@totalExpedientesPendientes</div>
            </div>
            <a href="documentos/nuevo" class="btn btn-primary btn-lg shadow px-4 rounded-pill fw-bold">
                <i class="bi bi-plus-lg me-1"></i> Nuevo Ingreso
            </a>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 rounded-4">
        <div class="card-body p-4">
            <div class="row g-4 align-items-end">
                <div class="col-lg-6">
                    <label class="form-label fw-bold small text-muted">Buscador inteligente</label>
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input class="form-control search-input shadow-none"
                               placeholder="Buscar por número, ID de ingreso, asunto o descripción..."
                               @bind="FiltroBusqueda"
                               @bind:event="oninput" />
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Registros</label>
                    <select class="form-select border-light bg-light fw-bold" @bind="TamanoPagina" @bind:after="OnTamanoPaginaChanged">
                        @foreach (var opcion in opcionesTamanoPagina)
                        {
                            <option value="@opcion">Mostrar @opcion</option>
                        }
                    </select>
                </div>

                <div class="col-md-3 d-flex align-items-center justify-content-md-end pb-2">
                    <div class="form-check form-switch custom-switch">
                        <input class="form-check-input" type="checkbox" id="swGlobal" @bind="mostrarSoloMiBandeja" @bind:after="OnToggleVistaChanged">
                        <label class="form-check-label fw-bold small" for="swGlobal">Mi bandeja</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex align-items-center gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm rounded-pill @(string.IsNullOrEmpty(filtroSemaforo) ? "btn-dark shadow" : "btn-outline-secondary")"
                @onclick="() => FiltrarPorEstado(null)">
            <i class="bi bi-list-task me-1"></i> Todos
        </button>

        <button class="btn btn-sm rounded-pill @(EsSemaforoActivo("ROJO") ? "btn-danger shadow" : "btn-outline-danger")"
                @onclick='() => FiltrarPorEstado("ROJO")'>
            <i class="bi bi-fire me-1"></i> Urgentes
            <span class="badge bg-white text-danger ms-1">@totalRojo</span>
        </button>

        <button class="btn btn-sm rounded-pill @(EsSemaforoActivo("AMARILLO") ? "btn-warning shadow" : "btn-outline-warning text-dark")"
                @onclick='() => FiltrarPorEstado("AMARILLO")'>
            <i class="bi bi-clock-history me-1"></i> En Riesgo
            <span class="badge bg-dark text-warning ms-1">@totalAmarillo</span>
        </button>

        <button class="btn btn-sm rounded-pill @(EsSemaforoActivo("VERDE") ? "btn-success shadow" : "btn-outline-success")"
                @onclick='() => FiltrarPorEstado("VERDE")'>
            <i class="bi bi-check-all me-1"></i> En Plazo
            <span class="badge bg-white text-success ms-1">@totalVerde</span>
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(mensajeError))
    {
        <div class="alert alert-danger shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@mensajeError
        </div>
    }

    @if (procesandoEliminacion)
    {
        <div class="alert alert-warning py-2" role="status">
            <span class="spinner-border spinner-border-sm me-2"></span>Eliminando documento y vinculaciones...
        </div>
    }

    @if (listaDocs is null)
    {
        <div class="text-center py-5">
            <div class="spinner-grow text-primary" role="status"></div>
            <p class="mt-3 text-muted fw-bold">Organizando tus documentos...</p>
        </div>
    }
    else
    {
        <div class="table-container shadow-sm border">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 130px;">Estado</th>
                            <th style="width: 100px;">Fecha</th>
                            <th style="width: 160px;">Identificación</th>
                            <th style="width: 140px;">Vinculación</th>
                            <th>Asunto / Descripción</th>
                            <th style="width: 150px;">Ubicación</th>
                            <th class="text-end" style="width: 320px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var doc in DocumentosPaginados)
                        {
                            <tr>
                                <td>
                                    <span class="badge badge-status @ObtenerClaseSemaforo(doc.EstadoSemaforo)" title="@doc.IdEstadoActualNavigation?.Nombre">
                                        @doc.IdEstadoActualNavigation?.Nombre
                                    </span>
                                </td>
                                <td class="text-muted fw-medium">@doc.FechaCreacion?.ToString("dd MMM yyyy")</td>
                                <td>
                                    <div class="fw-bold text-primary mb-0">@doc.NumeroOficial</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">@doc.IdTipoNavigation?.Nombre</div>
                                </td>
                                <td>
                                    @if (doc.IdDocumentoPadre.HasValue)
                                    {
                                        <div class="badge bg-light text-dark border fw-normal py-1 px-2" title="Hijo de: @ObtenerReferenciaPadre(doc.IdDocumentoPadre.Value)">
                                            <i class="bi bi-link-45deg"></i> Hijo (@doc.IdDocumentoPadre.Value)
                                        </div>
                                    }
                                    @if (cantidadHijosPorPadre.TryGetValue(doc.IdDocumento, out var cantHijos) && cantHijos > 0)
                                    {
                                        <div class="badge bg-primary-subtle text-primary border border-primary-subtle py-1 px-2 mt-1">
                                            <i class="bi bi-diagram-2"></i> Padre (@cantHijos)
                                        </div>
                                    }
                                </td>
                                <td>
                                    <div class="asunto-cell fw-semibold" title="@doc.Asunto">@doc.Asunto</div>
                                    @if (!string.IsNullOrWhiteSpace(doc.Descripcion))
                                    {
                                        <div class="descripcion-cell mt-1" title="@doc.Descripcion">@doc.Descripcion</div>
                                    }
                                </td>
                                <td>
                                    @if (doc.IdOficinaActual == idOficinaUsuario)
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success-subtle px-2">MI BANDEJA</span>
                                    }
                                    else
                                    {
                                        <div class="text-truncate small fw-medium" style="max-width: 140px;" title="@doc.IdOficinaActualNavigation?.Nombre">
                                            <i class="bi bi-building text-muted"></i> @doc.IdOficinaActualNavigation?.Nombre
                                        </div>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-1 flex-wrap">
                                        <button class="btn btn-sm btn-outline-warning" @onclick="() => IrAPase(doc)"><i class="bi bi-send"></i> Pase</button>
                                        <a class="btn btn-sm btn-outline-info" href="documentos/historial/@doc.IdDocumento"><i class="bi bi-clock-history"></i> Historial</a>
                                        <a class="btn btn-sm btn-outline-secondary" href="documentos/recorrido/@doc.IdDocumento"><i class="bi bi-geo-alt"></i> Recorrido</a>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => IrAEditar(doc.IdDocumento)"><i class="bi bi-pencil-square"></i> Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmarEliminacion(doc.IdDocumento)"><i class="bi bi-trash"></i> Eliminar total</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="text-muted small">
                    Mostrando <strong>@DesdeRegistro</strong> a <strong>@HastaRegistro</strong> de <strong>@TotalRegistros</strong> resultados
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0 shadow-sm">
                        <li class="page-item @(PaginaActualEfectiva == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="PaginaAnterior">Anterior</button>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link bg-white text-dark fw-bold">@PaginaActualEfectiva / @TotalPaginas</span>
                        </li>
                        <li class="page-item @(PaginaActualEfectiva >= TotalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="PaginaSiguiente">Siguiente</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@if (mostrarModalResumenEliminacion && resumenEliminacionActual is not null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar eliminación total</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelarEliminacion" disabled="@procesandoEliminacion"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Se eliminará el documento <strong>#@resumenEliminacionActual.IdDocumento</strong>@(!string.IsNullOrWhiteSpace(resumenEliminacionActual.NumeroOficial) ? $" ({resumenEliminacionActual.NumeroOficial})" : string.Empty).</p>
                    @if (!string.IsNullOrWhiteSpace(resumenEliminacionActual.Asunto))
                    {
                        <p class="text-muted small mb-3">Asunto: @resumenEliminacionActual.Asunto</p>
                    }

                    <div class="alert alert-warning mb-3" role="alert">
                        <i class="bi bi-shield-exclamation me-2"></i>Esta acción es irreversible y también eliminará todos los elementos relacionados.
                    </div>

                    <ul class="list-group">
                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-3 py-2"
                                    @onclick='() => ToggleDetalleEliminacion("documentos-totales")'>
                                <span><i class="bi bi-file-earmark-text me-2 text-primary"></i>Documentos totales</span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge bg-primary rounded-pill">@resumenEliminacionActual.TotalDocumentos</span>
                                    <i class="bi @(EstaDetalleExpandido("documentos-totales") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("documentos-totales"))
                            {
                                <div class="border-top px-3 py-2 bg-light small">
                                    <div class="fw-semibold">Documento principal #@resumenEliminacionActual.IdDocumento@(!string.IsNullOrWhiteSpace(resumenEliminacionActual.NumeroOficial) ? $" ({resumenEliminacionActual.NumeroOficial})" : string.Empty)</div>
                                    @if (!string.IsNullOrWhiteSpace(resumenEliminacionActual.Asunto))
                                    {
                                        <div class="text-muted">Asunto: @resumenEliminacionActual.Asunto</div>
                                    }
                                    @if (resumenEliminacionActual.DocumentosHijos.Count > 0)
                                    {
                                        <hr class="my-2" />
                                        @foreach (var hijo in resumenEliminacionActual.DocumentosHijos)
                                        {
                                            <div>• Hijo #@hijo.IdDocumento@(!string.IsNullOrWhiteSpace(hijo.NumeroOficial) ? $" ({hijo.NumeroOficial})" : string.Empty)</div>
                                        }
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-3 py-2"
                                    @onclick='() => ToggleDetalleEliminacion("documentos-hijos")'>
                                <span><i class="bi bi-diagram-2 me-2 text-secondary"></i>Documentos hijos</span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge bg-secondary rounded-pill">@resumenEliminacionActual.TotalDocumentosHijos</span>
                                    <i class="bi @(EstaDetalleExpandido("documentos-hijos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("documentos-hijos"))
                            {
                                <div class="border-top px-3 py-2 bg-light small">
                                    @if (resumenEliminacionActual.DocumentosHijos.Count == 0)
                                    {
                                        <div class="text-muted">Sin documentos hijos.</div>
                                    }
                                    else
                                    {
                                        @foreach (var hijo in resumenEliminacionActual.DocumentosHijos)
                                        {
                                            <div class="mb-1">
                                                <div class="fw-semibold">#@hijo.IdDocumento@(!string.IsNullOrWhiteSpace(hijo.NumeroOficial) ? $" ({hijo.NumeroOficial})" : string.Empty)</div>
                                                @if (!string.IsNullOrWhiteSpace(hijo.Asunto))
                                                {
                                                    <div class="text-muted">Asunto: @hijo.Asunto</div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-3 py-2"
                                    @onclick='() => ToggleDetalleEliminacion("movimientos")'>
                                <span><i class="bi bi-send me-2 text-warning"></i>Pases / movimientos</span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge bg-warning text-dark rounded-pill">@resumenEliminacionActual.TotalPases</span>
                                    <i class="bi @(EstaDetalleExpandido("movimientos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("movimientos"))
                            {
                                <div class="border-top px-3 py-2 bg-light small">
                                    @if (resumenEliminacionActual.Movimientos.Count == 0)
                                    {
                                        <div class="text-muted">Sin movimientos.</div>
                                    }
                                    else
                                    {
                                        <div class="table-responsive border rounded bg-white">
                                            <table class="table table-sm table-striped align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th><th>Documento</th><th>Fecha</th><th>Origen</th><th>Destino</th><th>Observación</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var movimiento in resumenEliminacionActual.Movimientos)
                                                    {
                                                        <tr>
                                                            <td>#@movimiento.IdMovimiento</td>
                                                            <td>#@movimiento.IdDocumento</td>
                                                            <td>@(movimiento.FechaMovimiento?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                                                            <td>@movimiento.OficinaOrigen</td>
                                                            <td>@movimiento.OficinaDestino</td>
                                                            <td>@(string.IsNullOrWhiteSpace(movimiento.Observacion) ? "-" : movimiento.Observacion)</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-3 py-2"
                                    @onclick='() => ToggleDetalleEliminacion("adjuntos")'>
                                <span><i class="bi bi-paperclip me-2 text-info"></i>Adjuntos</span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge bg-info text-dark rounded-pill">@resumenEliminacionActual.TotalAdjuntos</span>
                                    <i class="bi @(EstaDetalleExpandido("adjuntos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("adjuntos"))
                            {
                                <div class="border-top px-3 py-2 bg-light small">
                                    @if (resumenEliminacionActual.Adjuntos.Count == 0)
                                    {
                                        <div class="text-muted">Sin adjuntos.</div>
                                    }
                                    else
                                    {
                                        @foreach (var adjunto in resumenEliminacionActual.Adjuntos)
                                        {
                                            <div>• #@adjunto.IdAdjunto · Doc #@adjunto.IdDocumento · @adjunto.DisplayName · @adjunto.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</div>
                                        }
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-3 py-2"
                                    @onclick='() => ToggleDetalleEliminacion("vinculos")'>
                                <span><i class="bi bi-link-45deg me-2 text-dark"></i>Vínculos de respaldo</span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge bg-dark rounded-pill">@resumenEliminacionActual.TotalVinculos</span>
                                    <i class="bi @(EstaDetalleExpandido("vinculos") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("vinculos"))
                            {
                                <div class="border-top px-3 py-2 bg-light small">
                                    @if (resumenEliminacionActual.VinculosRespaldo.Count == 0)
                                    {
                                        <div class="text-muted">Sin vínculos de respaldo.</div>
                                    }
                                    else
                                    {
                                        @foreach (var vinculo in resumenEliminacionActual.VinculosRespaldo)
                                        {
                                            <div>• Vínculo #@vinculo.IdSalidaDocumentoRespaldo · Salida #@vinculo.IdSalida · Doc #@vinculo.IdDocumento · @vinculo.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</div>
                                        }
                                    }
                                </div>
                            }
                        </li>

                        <li class="list-group-item p-0">
                            <button type="button" class="btn btn-link text-decoration-none text-dark w-100 d-flex justify-content-between align-items-center px-3 py-2"
                                    @onclick='() => ToggleDetalleEliminacion("salidas")'>
                                <span><i class="bi bi-box-arrow-in-right me-2 text-danger"></i>Salidas afectadas</span>
                                <span class="d-flex align-items-center gap-2">
                                    <span class="badge bg-danger rounded-pill">@resumenEliminacionActual.TotalSalidasAfectadas</span>
                                    <i class="bi @(EstaDetalleExpandido("salidas") ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                </span>
                            </button>
                            @if (EstaDetalleExpandido("salidas"))
                            {
                                <div class="border-top px-3 py-2 bg-light small">
                                    @if (resumenEliminacionActual.SalidasAfectadas.Count == 0)
                                    {
                                        <div class="text-muted">Sin salidas afectadas.</div>
                                    }
                                    else
                                    {
                                        @foreach (var salida in resumenEliminacionActual.SalidasAfectadas)
                                        {
                                            <div class="mb-1">• Salida #@salida.IdSalida · Resp: #@salida.IdDocumentoRespaldo · @salida.LugarTrabajo · @salida.FechaInicio.ToString("dd/MM/yyyy") - @salida.FechaVencimiento.ToString("dd/MM/yyyy") · @(salida.Activo == true ? "Activa" : "Inactiva")</div>
                                        }
                                    }
                                </div>
                            }
                        </li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="CancelarEliminacion" disabled="@procesandoEliminacion">Cancelar</button>
                    <button class="btn btn-danger" @onclick="EjecutarEliminacion" disabled="@procesandoEliminacion">
                        @if (procesandoEliminacion)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Sí, eliminar todo
                    </button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    // ... (El bloque @code se mantiene igual, no hay cambios en la lógica)
    private List<MaeDocumento>? listaDocs;
    private Dictionary<long, int> cantidadHijosPorPadre = [];
    private Dictionary<long, string> referenciasPadrePorId = [];
    private Timer? timerBusqueda;
    private string filtroBusqueda = string.Empty;
    private int paginaActual = 1;
    private int tamanoPagina = 10;
    private int idOficinaUsuario;
    private string nombreOficinaUsuario = "Mi Oficina";
    private int totalExpedientesPendientes;
    private bool mostrarSoloMiBandeja = true;
    private string? filtroSemaforo;
    private int totalRojo;
    private int totalAmarillo;
    private int totalVerde;
    private bool procesandoEliminacion;
    private bool mostrarModalResumenEliminacion;
    private string? mensajeError;
    private ResumenEliminacionDocumento? resumenEliminacionActual;
    private readonly HashSet<string> detallesEliminacionExpandidos = [];
    private const int DiasRiesgoSemaforo = 3;
    private const string CollationBusquedaSinAcentos = "Modern_Spanish_CI_AI";
    private static readonly int[] opcionesTamanoPagina = [10, 20, 50, 100];

    private IEnumerable<MaeDocumento> DocumentosPaginados => listaDocs ?? [];
    private int TotalRegistros { get; set; }
    private int TotalPaginas => Math.Max(1, (int)Math.Ceiling(TotalRegistros / (double)tamanoPagina));
    private int PaginaActualEfectiva => Math.Max(1, Math.Min(paginaActual, TotalPaginas));
    private int DesdeRegistro => TotalRegistros == 0 ? 0 : ((PaginaActualEfectiva - 1) * tamanoPagina) + 1;
    private int HastaRegistro => Math.Min(PaginaActualEfectiva * tamanoPagina, TotalRegistros);

    private string FiltroBusqueda
    {
        get => filtroBusqueda;
        set { if (filtroBusqueda == value) return; filtroBusqueda = value; paginaActual = 1; ReiniciarTemporizadorBusqueda(); }
    }

    private int TamanoPagina
    {
        get => tamanoPagina;
        set { if (tamanoPagina == value) return; tamanoPagina = value; paginaActual = 1; }
    }

    private Task OnTamanoPaginaChanged() => CargarDocumentos();

    private Task OnToggleVistaChanged()
    {
        paginaActual = 1;
        return CargarDocumentos();
    }

    private bool EsSemaforoActivo(string estado) => string.Equals(filtroSemaforo, estado, StringComparison.OrdinalIgnoreCase);

    private async Task FiltrarPorEstado(string? estado)
    {
        filtroSemaforo = estado;
        paginaActual = 1;
        await CargarDocumentos();
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var claimOficina = user.FindFirst("IdOficina")?.Value;
            if (int.TryParse(claimOficina, out var ofId))
            {
                idOficinaUsuario = ofId;
                await using var db = await DbContextFactory.CreateDbContextAsync();
                var of = await db.CatOficinas.AsNoTracking().FirstOrDefaultAsync(o => o.IdOficina == idOficinaUsuario);
                nombreOficinaUsuario = of?.Nombre ?? $"Oficina {idOficinaUsuario}";
                if (idOficinaUsuario <= 0) mostrarSoloMiBandeja = false;
            }
        }
        await CargarDocumentos();
    }

    private async Task CargarDocumentos()
    {
        await using var db = await DbContextFactory.CreateDbContextAsync();

        // 1. Definimos la consulta base: SÓLO documentos RAÍZ (sin padre)
        // Esto asegura que no contemos actuaciones sueltas en los totales.
        var qBase = db.MaeDocumentos.AsNoTracking()
            .Where(d => d.IdDocumentoPadre == null)
            .Include(d => d.IdTipoNavigation)
            .Include(d => d.IdOficinaActualNavigation)
            .Include(d => d.IdEstadoActualNavigation)
            .AsQueryable();

        // 2. Filtro por Oficina (si está activo "Mi Bandeja")
        if (mostrarSoloMiBandeja && idOficinaUsuario > 0)
        {
            qBase = qBase.Where(d => d.IdOficinaActual == idOficinaUsuario);
        }

        // El recuento total ahora es coherente (Solo padres/independientes)
        totalExpedientesPendientes = await qBase.CountAsync();

        // 3. Aplicamos la lógica de búsqueda (si el usuario escribió algo)
        var qConBusqueda = AplicarFiltroBusqueda(qBase);

        var fechaHoy = DateTime.Today;
        var fechaRiesgo = fechaHoy.AddDays(DiasRiesgoSemaforo);

        // 4. RECUENTOS DEL SEMÁFORO (Basados exclusivamente en documentos raíz filtrados)
        totalRojo = await qConBusqueda.CountAsync(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value < fechaHoy);
        totalAmarillo = await qConBusqueda.CountAsync(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value >= fechaHoy && d.FechaVencimiento.Value <= fechaRiesgo);
        totalVerde = await qConBusqueda.CountAsync(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value > fechaRiesgo);

        // 5. Aplicamos el filtro del Semáforo seleccionado por el usuario (si eligió alguno)
        var q = AplicarFiltroSemaforo(qConBusqueda, fechaHoy, fechaRiesgo);

        // 6. Paginación
        TotalRegistros = await q.CountAsync();
        if (paginaActual > TotalPaginas) paginaActual = TotalPaginas;

        // 7. Ejecución de la consulta final para la lista
        listaDocs = await q.OrderByDescending(d => d.FechaCreacion)
                           .ThenByDescending(d => d.IdDocumento)
                           .Skip((PaginaActualEfectiva - 1) * tamanoPagina)
                           .Take(tamanoPagina)
                           .ToListAsync();

        // 8. Lógica de referencias y conteo de hijos (para los iconos de la tabla)
        var idsVisibles = listaDocs.Select(d => d.IdDocumento).ToList();

        if (idsVisibles.Any())
        {
            // Contamos cuántos hijos tiene cada uno de los documentos que estamos mostrando
            var conteos = await db.MaeDocumentos.AsNoTracking()
                .Where(d => d.IdDocumentoPadre.HasValue && idsVisibles.Contains(d.IdDocumentoPadre.Value))
                .GroupBy(d => d.IdDocumentoPadre!.Value)
                .Select(g => new { IdPadre = g.Key, Cantidad = g.Count() })
                .ToListAsync();

            cantidadHijosPorPadre = conteos.ToDictionary(k => k.IdPadre, v => v.Cantidad);

            // Limpiamos referencias de padres ya que en esta vista nosotros SOMOS los padres (o independientes)
            referenciasPadrePorId.Clear();
        }
        else
        {
            cantidadHijosPorPadre.Clear();
            referenciasPadrePorId.Clear();
        }

        StateHasChanged();
    }
    private void ReiniciarTemporizadorBusqueda()
    {
        timerBusqueda?.Stop(); timerBusqueda?.Dispose();
        var nT = new Timer(500) { AutoReset = false };
        nT.Elapsed += (_, _) => { _ = InvokeAsync(async () => { await CargarDocumentos(); }); };
        timerBusqueda = nT; nT.Start();
    }

    private IQueryable<MaeDocumento> AplicarFiltroBusqueda(IQueryable<MaeDocumento> q)
    {
        if (string.IsNullOrWhiteSpace(filtroBusqueda)) return q;
        var tms = filtroBusqueda.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        foreach (var t in tms)
        {
            var p = $"%{t}%";
            var esNumero = long.TryParse(t, out var idDocumentoBuscado);

            q = q.Where(d =>
                (esNumero && d.IdDocumento == idDocumentoBuscado)
                || (d.NumeroOficial != null && EF.Functions.Like(EF.Functions.Collate(d.NumeroOficial, CollationBusquedaSinAcentos), p))
                || (d.NumeroInterno != null && EF.Functions.Like(EF.Functions.Collate(d.NumeroInterno, CollationBusquedaSinAcentos), p))
                || (d.Asunto != null && EF.Functions.Like(EF.Functions.Collate(d.Asunto, CollationBusquedaSinAcentos), p))
                || (d.Descripcion != null && EF.Functions.Like(EF.Functions.Collate(d.Descripcion, CollationBusquedaSinAcentos), p))
                || (d.IdTipoNavigation != null && d.IdTipoNavigation.Nombre != null && EF.Functions.Like(EF.Functions.Collate(d.IdTipoNavigation.Nombre, CollationBusquedaSinAcentos), p))
                || (d.IdOficinaActualNavigation != null && d.IdOficinaActualNavigation.Nombre != null && EF.Functions.Like(EF.Functions.Collate(d.IdOficinaActualNavigation.Nombre, CollationBusquedaSinAcentos), p))
                || (d.IdEstadoActualNavigation != null && d.IdEstadoActualNavigation.Nombre != null && EF.Functions.Like(EF.Functions.Collate(d.IdEstadoActualNavigation.Nombre, CollationBusquedaSinAcentos), p)));
        }
        return q;
    }

    private IQueryable<MaeDocumento> AplicarFiltroSemaforo(IQueryable<MaeDocumento> q, DateTime fechaHoy, DateTime fechaRiesgo)
    {
        if (string.IsNullOrWhiteSpace(filtroSemaforo)) return q;

        return filtroSemaforo.ToUpperInvariant() switch
        {
            "ROJO" => q.Where(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value < fechaHoy),
            "AMARILLO" => q.Where(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value >= fechaHoy && d.FechaVencimiento.Value <= fechaRiesgo),
            "VERDE" => q.Where(d => d.FechaVencimiento.HasValue && d.FechaVencimiento.Value > fechaRiesgo),
            _ => q
        };
    }
    private async Task ConfirmarEliminacion(long idDocumento)
    {
        mensajeError = null;
        procesandoEliminacion = false;
        resumenEliminacionActual = await DocumentoService.ObtenerResumenEliminacionAsync(idDocumento);

        if (resumenEliminacionActual is null)
        {
            mensajeError = "No se pudo obtener el resumen del documento a eliminar.";
            return;
        }

        detallesEliminacionExpandidos.Clear();
        mostrarModalResumenEliminacion = true;
    }

    private void CancelarEliminacion()
    {
        if (procesandoEliminacion) return;
        mostrarModalResumenEliminacion = false;
        resumenEliminacionActual = null;
        detallesEliminacionExpandidos.Clear();
    }

    private async Task EjecutarEliminacion()
    {
        if (resumenEliminacionActual is null) return;

        procesandoEliminacion = true;
        mensajeError = null;
        StateHasChanged();

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var idUsuario = int.TryParse(user.FindFirstValue(ClaimTypes.NameIdentifier), out var uid) ? uid : 1;

            var resultado = await DocumentoService.EliminarDocumentoTotalAsync(resumenEliminacionActual.IdDocumento, idUsuario);
            if (!resultado.Exitoso)
            {
                mensajeError = resultado.Mensaje;
                return;
            }

            mostrarModalResumenEliminacion = false;
            resumenEliminacionActual = null;
            detallesEliminacionExpandidos.Clear();
            await CargarDocumentos();
        }
        finally
        {
            procesandoEliminacion = false;
            StateHasChanged();
        }
    }


    private void ToggleDetalleEliminacion(string clave)
    {
        if (!detallesEliminacionExpandidos.Add(clave))
        {
            detallesEliminacionExpandidos.Remove(clave);
        }
    }

    private bool EstaDetalleExpandido(string clave) => detallesEliminacionExpandidos.Contains(clave);

    private void IrAEditar(long id) => Navegador.NavigateTo($"documentos/editar/{id}");

    private async Task PaginaAnterior() { if (PaginaActualEfectiva > 1) { paginaActual--; await CargarDocumentos(); } }
    private async Task PaginaSiguiente() { if (PaginaActualEfectiva < TotalPaginas) { paginaActual++; await CargarDocumentos(); } }
    private static string ObtenerClaseSemaforo(string? estado) => (estado ?? string.Empty).ToUpperInvariant() switch
    {
        "ROJO" => "bg-danger text-white",
        "AMARILLO" => "bg-warning text-dark",
        "VERDE" => "bg-success text-white",
        _ => "bg-secondary text-white"
    };
    private string ObtenerReferenciaPadre(long id) => referenciasPadrePorId.TryGetValue(id, out var r) ? r : $"#{id}";
    private void IrAPase(MaeDocumento d) => Navegador.NavigateTo($"documentos/pase/{d.IdDocumento}");
    public void Dispose() => timerBusqueda?.Dispose();
}
 *@