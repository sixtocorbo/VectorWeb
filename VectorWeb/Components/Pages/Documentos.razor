@page "/documentos"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<CatOficina> RepoOficinas
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@rendermode InteractiveServer

<h3>
    <i class="bi bi-inbox"></i> Oficina: <strong>@nombreOficinaUsuario</strong>
</h3>

<div class="row g-2 mb-3 align-items-end">
    <div class="col-md-6">
        <a href="documentos/nuevo" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Nuevo Ingreso
        </a>
    </div>
    <div class="col-md-6 text-end">
        <div class="form-check form-switch d-inline-block">
            <input id="verTodoOficinas" class="form-check-input" type="checkbox" @bind="verTodo" @bind:after="CargarDocumentos">
            <label class="form-check-label" for="verTodoOficinas">Ver documentos de otras oficinas</label>
        </div>
    </div>
</div>

<div class="row g-2 mb-3 align-items-end">
    <div class="col-md-6">
        <label for="buscadorDocumentos" class="form-label">Buscador en bandeja</label>
        <input id="buscadorDocumentos"
               class="form-control"
               placeholder="Buscar por número, asunto, tipo, oficina o estado"
               @bind="FiltroBusqueda"
               @bind:event="oninput" />
        <small class="text-muted">Podés escribir varias palabras en cualquier orden; se buscarán en todos los campos.</small>
    </div>
    <div class="col-md-3">
        <label for="tamanoPagina" class="form-label">Resultados por página</label>
        <select id="tamanoPagina" class="form-select" @bind="TamanoPagina">
            @foreach (var opcion in opcionesTamanoPagina)
            {
                <option value="@opcion">@opcion</option>
            }
        </select>
    </div>
</div>

<div class="mb-3">
    <span class="badge bg-danger me-2">Rojo</span>
    <span class="me-3">Trámite vencido o de atención urgente.</span>
    <span class="badge bg-info me-2">Azul</span>
    <span>Trámite en plazo o en curso normal.</span>
</div>

@if (listaDocs is null)
{
    <p><em>Cargando bandeja...</em></p>
}
else
{
    @if (!DocumentosPaginados.Any())
    {
        <p><em>No se encontraron documentos con los filtros actuales.</em></p>
    }

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Fecha creación</th>
                <th>Nro. Oficial</th>
                <th>Asunto</th>
                <th>Tipo</th>
                <th>Ubicación Actual</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var doc in DocumentosPaginados)
            {
                <tr>
                    <td>@doc.FechaCreacion?.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@doc.NumeroOficial</td>
                    <td>@doc.Asunto</td>
                    <td>@doc.IdTipoNavigation?.Nombre</td>
                    <td>
                        @if (doc.IdOficinaActual == idOficinaUsuario)
                        {
                            <span class="badge bg-success">EN TU BANDEJA</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@doc.IdOficinaActualNavigation?.Nombre</span>
                        }
                    </td>
                    <td>
                        <span class="badge @(EsRojo(doc.EstadoSemaforo) ? "bg-danger" : "bg-info")">
                            @doc.IdEstadoActualNavigation?.Nombre
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm text-dark ms-1"
                                title="Dar pase del documento. El sistema detecta automáticamente si el documento está en tu oficina o en una remota."
                                @onclick="() => IrAPase(doc)">
                            <i class="bi bi-arrow-right-circle"></i> Pase
                        </button>

                        <a href="documentos/historial/@doc.IdDocumento" class="btn btn-info btn-sm text-white ms-1" title="Ver movimientos">
                            <i class="bi bi-clock-history"></i>
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">Mostrando @DesdeRegistro a @HastaRegistro de @TotalRegistros documento(s)</small>
        <div class="btn-group" role="group" aria-label="Paginación">
            <button class="btn btn-outline-secondary" @onclick="PaginaAnterior" disabled="@(PaginaActualEfectiva == 1)">Anterior</button>
            <button class="btn btn-outline-secondary disabled">Página @PaginaActualEfectiva de @TotalPaginas</button>
            <button class="btn btn-outline-secondary" @onclick="PaginaSiguiente" disabled="@(PaginaActualEfectiva >= TotalPaginas)">Siguiente</button>
        </div>
    </div>
}

@code {
    private List<MaeDocumento>? listaDocs;
    private string filtroBusqueda = string.Empty;
    private int paginaActual = 1;
    private int tamanoPagina = 10;
    private int idOficinaUsuario;
    private string nombreOficinaUsuario = "Mi Oficina";
    private bool verTodo;
    private static readonly int[] opcionesTamanoPagina = [10, 20, 50];

    private IEnumerable<MaeDocumento> DocumentosFiltrados
    {
        get
        {
            if (listaDocs is null)
            {
                return [];
            }

            var terminos = filtroBusqueda
                .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

            return listaDocs.Where(doc => terminos.All(termino =>
                ConstruirIndiceBusqueda(doc).Contains(termino, StringComparison.OrdinalIgnoreCase)));
        }
    }

    private IEnumerable<MaeDocumento> DocumentosPaginados
        => DocumentosFiltrados
            .Skip((PaginaActualEfectiva - 1) * tamanoPagina)
            .Take(tamanoPagina);

    private int TotalRegistros => DocumentosFiltrados.Count();
    private int TotalPaginas => Math.Max(1, (int)Math.Ceiling(TotalRegistros / (double)tamanoPagina));
    private int PaginaActualEfectiva => Math.Min(paginaActual, TotalPaginas);
    private int DesdeRegistro => TotalRegistros == 0 ? 0 : ((PaginaActualEfectiva - 1) * tamanoPagina) + 1;
    private int HastaRegistro => Math.Min(PaginaActualEfectiva * tamanoPagina, TotalRegistros);

    private string FiltroBusqueda
    {
        get => filtroBusqueda;
        set
        {
            if (filtroBusqueda == value)
            {
                return;
            }

            filtroBusqueda = value;
            paginaActual = 1;
        }
    }

    private int TamanoPagina
    {
        get => tamanoPagina;
        set
        {
            if (tamanoPagina == value)
            {
                return;
            }

            tamanoPagina = value;
            paginaActual = 1;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var claimOficina = user.FindFirst("IdOficina")?.Value;
            if (int.TryParse(claimOficina, out var oficinaId))
            {
                idOficinaUsuario = oficinaId;

                if (idOficinaUsuario > 0)
                {
                    var oficina = await RepoOficinas.GetQueryable().FirstOrDefaultAsync(o => o.IdOficina == oficinaId);
                    nombreOficinaUsuario = oficina?.Nombre ?? $"Mi Oficina ({oficinaId})";
                }
                else
                {
                    nombreOficinaUsuario = "Todas las oficinas";
                    verTodo = true;
                }
            }
            else
            {
                nombreOficinaUsuario = user.FindFirstValue(ClaimTypes.Name) ?? "Mi Oficina";
            }
        }

        await CargarDocumentos();
    }

    private Task CargarDocumentos()
    {
        var query = RepoDocs.GetQueryable("IdTipoNavigation,IdOficinaActualNavigation,IdEstadoActualNavigation");

        if (!verTodo && idOficinaUsuario > 0)
        {
            query = query.Where(d => d.IdOficinaActual == idOficinaUsuario);
        }

        listaDocs = query
            .OrderByDescending(d => d.FechaCreacion)
            .ToList();

        paginaActual = 1;
        return Task.CompletedTask;
    }

    private static string ConstruirIndiceBusqueda(MaeDocumento doc)
        => string.Join(' ',
            doc.NumeroOficial,
            doc.Asunto,
            doc.Descripcion,
            doc.IdTipoNavigation?.Nombre,
            doc.IdOficinaActualNavigation?.Nombre,
            doc.IdEstadoActualNavigation?.Nombre,
            doc.EstadoSemaforo,
            doc.NumeroInterno,
            doc.FechaCreacion?.ToString("dd/MM/yyyy"));

    private void PaginaAnterior()
    {
        if (PaginaActualEfectiva > 1)
        {
            paginaActual = PaginaActualEfectiva - 1;
        }
    }

    private void PaginaSiguiente()
    {
        if (PaginaActualEfectiva < TotalPaginas)
        {
            paginaActual = PaginaActualEfectiva + 1;
        }
    }

    private static bool EsRojo(string? estadoSemaforo)
        => string.Equals(estadoSemaforo, "ROJO", StringComparison.OrdinalIgnoreCase)
        || string.Equals(estadoSemaforo, "Rojo", StringComparison.OrdinalIgnoreCase);

    private void IrAPase(MaeDocumento doc)
    {
        Navegador.NavigateTo($"documentos/pase/{doc.IdDocumento}");
    }

}
