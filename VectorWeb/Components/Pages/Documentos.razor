@page "/documentos"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.ver")]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Timers
@using VectorWeb.Models
@inject IDbContextFactory<SecretariaDbContext> DbContextFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navegador
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Bandeja de Documentos - Vector</PageTitle>

<style>
    /* 1. Estructura y contenedores */
    .page-header {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-left: 5px solid #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .search-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 1rem;
    }

    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #eee;
        width: 100%;
    }

    /* 2. Control de tabla */
    .table {
        width: 100% !important;
        table-layout: fixed;
        margin-bottom: 0;
    }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            color: #495057;
            padding: 0.75rem;
            background: #f1f4f8;
            border: none;
        }

        .table tbody td {
            padding: 0.75rem;
            vertical-align: middle;
            font-size: 0.85rem;
            border-bottom: 1px solid #f8f9fa;
        }

    /* Definición de anchos fijos para que las leyendas tengan espacio */
    .col-estado {
        width: 120px;
    }

    .col-fecha {
        width: 95px;
    }

    .col-id {
        width: 160px;
    }

    .col-ubicacion {
        width: 150px;
    }

    .col-vinculo {
        width: 160px;
    }

    .col-acciones {
        width: 250px;
    }
    /* Espacio vital para las 4 leyendas */

    /* El Asunto es flexible */
    .asunto-cell {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
        line-height: 1.4;
    }

    .search-input-wrapper {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .search-input {
        padding-left: 35px !important;
        border-radius: 8px;
    }

    .badge-status {
        padding: 0.4em 0.6em;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.75rem;
        display: block;
        text-align: center;
        width: 100%;
        shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Botones con leyendas visibles */
    .btn-action-text {
        font-size: 0.75rem;
        font-weight: bold;
    }
</style>

<div class="container-fluid py-3">
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h3 class="mb-0">
            <i class="bi bi-inbox-fill text-primary me-2"></i>Oficina: <strong>@nombreOficinaUsuario</strong>
        </h3>
        <a href="documentos/nuevo" class="btn btn-success shadow-sm fw-bold">
            <i class="bi bi-plus-circle"></i> Nuevo Ingreso
        </a>
    </div>

    <div class="card search-card">
        <div class="card-body p-3">
            <div class="row g-3 align-items-end">
                <div class="col-lg-7">
                    <label for="buscadorDocumentos" class="form-label fw-semibold small text-uppercase text-muted">Buscador en bandeja</label>
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input id="buscadorDocumentos"
                               class="form-control search-input shadow-none"
                               placeholder="Buscar por número, asunto, tipo, oficina o estado..."
                               @bind="FiltroBusqueda"
                               @bind:event="oninput" />
                    </div>
                </div>
                <div class="col-6 col-md-3 col-lg-3 text-end pb-1">
                    <div class="form-check form-switch d-inline-block">
                        <input id="verTodoOficinas" class="form-check-input" type="checkbox" @bind="verTodo" @bind:after="CargarDocumentos">
                        <label class="form-check-label small fw-bold" for="verTodoOficinas" style="cursor: pointer;">
                            <i class="bi bi-buildings"></i> Ver Global
                        </label>
                    </div>
                </div>
                <div class="col-6 col-md-3 col-lg-2 pb-1">
                    <label for="tamanoPagina" class="form-label fw-semibold small text-uppercase text-muted">Registros</label>
                    <select id="tamanoPagina" class="form-select form-select-sm border-0 bg-light fw-bold" @bind="TamanoPagina" @bind:after="OnTamanoPaginaChanged">
                        @foreach (var opcion in opcionesTamanoPagina)
                        {
                            <option value="@opcion">@opcion filas</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex gap-3 mb-3 small fw-bold">
        <span class="text-danger"><i class="bi bi-circle-fill"></i> URGENTE</span>
        <span class="text-info"><i class="bi bi-circle-fill"></i> EN PLAZO</span>
    </div>

    @if (listaDocs is null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted fw-bold">Sincronizando bandeja...</p>
        </div>
    }
    else
    {
        <div class="table-container shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th class="col-estado">Estado</th>
                            <th class="col-fecha">Fecha</th>
                            <th class="col-id">Identificación</th>
                            <th class="col-vinculo">Vinculación</th>
                            <th>Asunto</th>
                            <th class="col-ubicacion">Ubicación</th>
                            <th class="col-acciones text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var doc in DocumentosPaginados)
                        {
                            <tr>
                                <td>
                                    <span class="badge badge-status @(EsRojo(doc.EstadoSemaforo) ? "bg-danger" : "bg-info")" title="@doc.IdEstadoActualNavigation?.Nombre">
                                        @doc.IdEstadoActualNavigation?.Nombre
                                    </span>
                                </td>
                                <td class="small fw-bold text-dark">@doc.FechaCreacion?.ToString("dd/MM/yy")</td>
                                <td>
                                    <div class="fw-bold text-primary" style="font-size: 0.8rem;">@doc.NumeroOficial</div>
                                    <div class="text-muted small">@doc.IdTipoNavigation?.Nombre</div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        @if (doc.IdDocumentoPadre.HasValue)
                                        {
                                            <span class="badge bg-secondary text-white fw-normal border"
                                                  title="Este documento depende de otro">
                                                <i class="bi bi-arrow-return-right me-1"></i>
                                                Hijo (@ObtenerReferenciaPadre(doc.IdDocumentoPadre.Value))
                                            </span>
                                        }

                                        @if (cantidadHijosPorPadre.TryGetValue(doc.IdDocumento, out var cantHijos) && cantHijos > 0)
                                        {
                                            <span class="badge bg-primary-subtle text-primary border border-primary fw-bold"
                                                  title="Este documento tiene hijos vinculados">
                                                <i class="bi bi-diagram-3 me-1"></i>
                                                Padre (@cantHijos)
                                            </span>
                                        }

                                        @if (!doc.IdDocumentoPadre.HasValue &&
                                            (!cantidadHijosPorPadre.ContainsKey(doc.IdDocumento) || cantidadHijosPorPadre[doc.IdDocumento] == 0))
                                        {
                                            <span class="text-muted small">-</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="asunto-cell" title="@doc.Asunto">@doc.Asunto</div>
                                </td>
                                <td>
                                    @if (doc.IdOficinaActual == idOficinaUsuario)
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success w-100 py-1" style="font-size: 0.7rem;">TU BANDEJA</span>
                                    }
                                    else
                                    {
                                        <span class="small text-muted d-inline-block text-truncate fw-medium" style="max-width: 100%;">
                                            <i class="bi bi-building"></i> @doc.IdOficinaActualNavigation?.Nombre
                                        </span>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="btn-group shadow-sm">
                                        <button class="btn btn-warning btn-sm btn-action-text text-dark" @onclick="() => IrAPase(doc)" title="Dar Pase">
                                            <i class="bi bi-arrow-right-circle"></i> Pase
                                        </button>
                                        <a href="documentos/historial/@doc.IdDocumento" class="btn btn-info btn-sm btn-action-text text-white" title="Historial">
                                            <i class="bi bi-clock-history"></i> Historial
                                        </a>
                                        <button class="btn btn-primary btn-sm btn-action-text" @onclick="() => IrAEditar(doc.IdDocumento)" title="Editar">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </button>
                                        <button class="btn btn-danger btn-sm btn-action-text" @onclick="() => EliminarDocumento(doc.IdDocumento)" title="Eliminar">
                                            <i class="bi bi-trash"></i> Borrar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center flex-wrap gap-3">
                <small class="text-muted fw-bold">Mostrando @DesdeRegistro - @HastaRegistro de @TotalRegistros</small>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-sm btn-outline-secondary fw-bold" @onclick="PaginaAnterior" disabled="@(PaginaActualEfectiva == 1)">Anterior</button>
                    <span class="btn btn-sm btn-white border disabled px-3 fw-bold">@PaginaActualEfectiva / @TotalPaginas</span>
                    <button class="btn btn-sm btn-outline-secondary fw-bold" @onclick="PaginaSiguiente" disabled="@(PaginaActualEfectiva >= TotalPaginas)">Siguiente</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<MaeDocumento>? listaDocs;
    private Dictionary<long, int> cantidadHijosPorPadre = [];
    private Dictionary<long, string> referenciasPadrePorId = [];
    private Timer? timerBusqueda;
    private string filtroBusqueda = string.Empty;
    private int paginaActual = 1;
    private int tamanoPagina = 10;
    private int idOficinaUsuario;
    private string nombreOficinaUsuario = "Mi Oficina";
    private bool verTodo;
    private static readonly int[] opcionesTamanoPagina = [10, 20, 50, 100];

    private IEnumerable<MaeDocumento> DocumentosPaginados => listaDocs ?? [];
    private int TotalRegistros { get; set; }
    private int TotalPaginas => Math.Max(1, (int)Math.Ceiling(TotalRegistros / (double)tamanoPagina));
    private int PaginaActualEfectiva => Math.Max(1, Math.Min(paginaActual, TotalPaginas));
    private int DesdeRegistro => TotalRegistros == 0 ? 0 : ((PaginaActualEfectiva - 1) * tamanoPagina) + 1;
    private int HastaRegistro => Math.Min(PaginaActualEfectiva * tamanoPagina, TotalRegistros);

    private string FiltroBusqueda
    {
        get => filtroBusqueda;
        set { if (filtroBusqueda == value) return; filtroBusqueda = value; paginaActual = 1; ReiniciarTemporizadorBusqueda(); }
    }

    private int TamanoPagina
    {
        get => tamanoPagina;
        set { if (tamanoPagina == value) return; tamanoPagina = value; paginaActual = 1; }
    }

    private Task OnTamanoPaginaChanged() => CargarDocumentos();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var claimOficina = user.FindFirst("IdOficina")?.Value;
            if (int.TryParse(claimOficina, out var ofId))
            {
                idOficinaUsuario = ofId;
                await using var db = await DbContextFactory.CreateDbContextAsync();
                var of = await db.CatOficinas.AsNoTracking().FirstOrDefaultAsync(o => o.IdOficina == idOficinaUsuario);
                nombreOficinaUsuario = of?.Nombre ?? $"Oficina {idOficinaUsuario}";
                if (idOficinaUsuario <= 0) verTodo = true;
            }
        }
        await CargarDocumentos();
    }

    private async Task CargarDocumentos()
    {
        await using var db = await DbContextFactory.CreateDbContextAsync();
        var q = db.MaeDocumentos.AsNoTracking()
            .Include(d => d.IdTipoNavigation).Include(d => d.IdOficinaActualNavigation).Include(d => d.IdEstadoActualNavigation).AsQueryable();

        if (!verTodo && idOficinaUsuario > 0) q = q.Where(d => d.IdOficinaActual == idOficinaUsuario);
        q = AplicarFiltroBusqueda(q);
        TotalRegistros = await q.CountAsync();
        if (paginaActual > TotalPaginas) paginaActual = TotalPaginas;

        listaDocs = await q.OrderByDescending(d => d.FechaCreacion).Skip((PaginaActualEfectiva - 1) * tamanoPagina).Take(tamanoPagina).ToListAsync();

        var idsPadre = listaDocs.Where(d => d.IdDocumentoPadre.HasValue).Select(d => d.IdDocumentoPadre!.Value).Distinct().ToList();
        if (idsPadre.Any())
        {
            referenciasPadrePorId = await db.MaeDocumentos.AsNoTracking().Where(d => idsPadre.Contains(d.IdDocumento)).Include(d => d.IdTipoNavigation)
                .Select(d => new { d.IdDocumento, n = d.NumeroOficial, t = d.IdTipoNavigation != null ? d.IdTipoNavigation.Nombre : null })
                .ToDictionaryAsync(x => x.IdDocumento, x => (x.t + " " + x.n).Trim());
        }
        else
        {
            referenciasPadrePorId.Clear();
        }

        var idsVisibles = listaDocs.Select(d => d.IdDocumento).ToList();
        if (idsVisibles.Any())
        {
            var conteos = await db.MaeDocumentos.AsNoTracking()
                .Where(d => d.IdDocumentoPadre.HasValue && idsVisibles.Contains(d.IdDocumentoPadre.Value))
                .GroupBy(d => d.IdDocumentoPadre!.Value)
                .Select(g => new { IdPadre = g.Key, Cantidad = g.Count() })
                .ToListAsync();

            cantidadHijosPorPadre = conteos.ToDictionary(k => k.IdPadre, v => v.Cantidad);
        }
        else
        {
            cantidadHijosPorPadre.Clear();
        }

        StateHasChanged();
    }

    private void ReiniciarTemporizadorBusqueda()
    {
        timerBusqueda?.Stop(); timerBusqueda?.Dispose();
        var nT = new Timer(500) { AutoReset = false };
        nT.Elapsed += (_, _) => { _ = InvokeAsync(async () => { await CargarDocumentos(); }); };
        timerBusqueda = nT; nT.Start();
    }

    private IQueryable<MaeDocumento> AplicarFiltroBusqueda(IQueryable<MaeDocumento> q)
    {
        if (string.IsNullOrWhiteSpace(filtroBusqueda)) return q;
        var tms = filtroBusqueda.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        foreach (var t in tms)
        {
            var p = $"%{t}%";
            q = q.Where(d => EF.Functions.Like(d.NumeroOficial ?? "", p) || EF.Functions.Like(d.Asunto ?? "", p) || EF.Functions.Like(d.IdTipoNavigation.Nombre ?? "", p) || EF.Functions.Like(d.IdOficinaActualNavigation.Nombre ?? "", p) || EF.Functions.Like(d.IdEstadoActualNavigation.Nombre ?? "", p));
        }
        return q;
    }

    private void IrAEditar(long id) => Navegador.NavigateTo($"documentos/editar/{id}");

    private async Task EliminarDocumento(long id)
    {
        bool conf = await JS.InvokeAsync<bool>("confirm", "¿Confirmar eliminación permanente?");
        if (!conf) return;

        await using var db = await DbContextFactory.CreateDbContextAsync();

        var doc = await db.MaeDocumentos.FindAsync(id);
        if (doc is null) return;

        // Evita excepciones de clave foránea y muestra una validación amigable.
        var tieneMovimientos = await db.TraMovimientos.AsNoTracking().AnyAsync(m => m.IdDocumento == id);
        var tieneAdjuntos = await db.TraAdjuntoDocumentos.AsNoTracking().AnyAsync(a => a.IdDocumento == id);
        var esPadre = await db.MaeDocumentos.AsNoTracking().AnyAsync(d => d.IdDocumentoPadre == id);
        var esRespaldoSalida = await db.TraSalidasLaboralesDocumentoRespaldos.AsNoTracking().AnyAsync(r => r.IdDocumento == id);

        if (tieneMovimientos || tieneAdjuntos || esPadre || esRespaldoSalida)
        {
            await JS.InvokeVoidAsync("alert", "No se puede eliminar el documento porque tiene información relacionada (historial, adjuntos, vínculos o respaldos).");
            return;
        }

        db.MaeDocumentos.Remove(doc);
        await db.SaveChangesAsync();
        await CargarDocumentos();
    }

    private async Task PaginaAnterior() { if (PaginaActualEfectiva > 1) { paginaActual--; await CargarDocumentos(); } }
    private async Task PaginaSiguiente() { if (PaginaActualEfectiva < TotalPaginas) { paginaActual++; await CargarDocumentos(); } }
    private static bool EsRojo(string? s) => string.Equals(s, "ROJO", StringComparison.OrdinalIgnoreCase);
    private string ObtenerReferenciaPadre(long id) => referenciasPadrePorId.TryGetValue(id, out var r) ? r : $"#{id}";
    private void IrAPase(MaeDocumento d) => Navegador.NavigateTo($"documentos/pase/{d.IdDocumento}");
    public void Dispose() => timerBusqueda?.Dispose();
}
