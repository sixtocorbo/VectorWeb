@page "/configuracion/plazos-documentos"
@attribute [Authorize(Policy = "configuracion.rangos")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<CfgTiemposRespuestum> RepoPlazos
@inject IRepository<CatTipoDocumento> RepoTipos
@rendermode InteractiveServer

<PageTitle>Plazos por Tipo de Documento - Vector</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1 fw-bold"><i class="bi bi-hourglass-split text-primary me-2"></i>Plazos por Tipo de Documento</h3>
        <p class="text-muted mb-0 small">Configura los tiempos de vencimiento automático para la generación de documentos.</p>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(mensajeExito))
{
    <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>@mensajeExito
        <button type="button" class="btn-close" @onclick="LimpiarMensajes" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div class="alert alert-warning alert-dismissible fade show shadow-sm" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>@mensajeError
        <button type="button" class="btn-close" @onclick="LimpiarMensajes" aria-label="Close"></button>
    </div>
}

@if (idFilaEnEdicion == 0)
{
    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <h6 class="card-title fw-bold text-secondary mb-3"><i class="bi bi-plus-circle-dotted me-2"></i>Agregar Nueva Regla</h6>

            <EditForm Model="nuevoPlazo" OnValidSubmit="AgregarAsync">
                <DataAnnotationsValidator />

                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-uppercase text-muted">Tipo de documento</label>
                        <InputSelect class="form-select" @bind-Value="nuevoPlazo.IdTipoDocumento">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var tipo in tipos)
                            {
                                <option value="@tipo.IdTipo">@tipo.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Prioridad</label>
                        <InputText class="form-control" @bind-Value="nuevoPlazo.Prioridad" placeholder="Ej: URGENTE" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Días máximos</label>
                        <InputNumber class="form-control" @bind-Value="nuevoPlazo.DiasMaximos" min="0" />

                        @* --- AVISO DINÁMICO (NUEVO) --- *@
                        @{
                            var aviso = ObtenerLeyendaPlazo(nuevoPlazo.DiasMaximos);
                        }
                        @if (!string.IsNullOrEmpty(aviso.Texto))
                        {
                            <small class="d-block mt-1 @aviso.ClaseColor" style="font-size: 0.75rem;">
                                <i class="bi bi-info-circle me-1"></i>@aviso.Texto
                            </small>
                        }
                    </div>
                    <div class="col-md-2 d-grid">
                        <button class="btn btn-primary" type="submit" disabled="@guardando">
                            @if (guardando)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <i class="bi bi-plus-lg me-1"></i>
                                <span>Agregar</span>
                            }
                        </button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
}

<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3">
        <h6 class="mb-0 fw-bold"><i class="bi bi-list-check me-2"></i>Reglas Existentes</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-uppercase small">
                    <tr>
                        <th class="ps-4">Tipo de Documento</th>
                        <th style="width:250px">Prioridad</th>
                        <th style="width:250px">Días Máximos</th>
                        <th style="width:220px" class="text-end pe-4">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!plazos.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No hay plazos configurados aún.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var p in plazos)
                        {
                            // MODO EDICIÓN
                            @if (idFilaEnEdicion == p.IdConfig)
                            {
                                <tr class="table-active border-start border-primary border-4">
                                    <td class="ps-4">
                                        <select class="form-select form-select-sm" @bind="filaEdicion.IdTipoDocumento">
                                            @foreach (var t in tipos)
                                            {
                                                <option value="@t.IdTipo">@t.Nombre</option>
                                            }
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm"
                                               @bind="filaEdicion.Prioridad" placeholder="Prioridad" />
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm"
                                               @bind="filaEdicion.DiasMaximos" min="0" />

                                        @* --- AVISO DINÁMICO EN EDICIÓN --- *@
                                        @{
                                            var avisoEdit = ObtenerLeyendaPlazo(filaEdicion.DiasMaximos);
                                        }
                                        @if (!string.IsNullOrEmpty(avisoEdit.Texto))
                                        {
                                            <div class="@avisoEdit.ClaseColor small mt-1" style="font-size: 0.7rem;">
                                                @avisoEdit.Texto
                                            </div>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-success btn-sm d-flex align-items-center"
                                                    @onclick="GuardarEdicionAsync" disabled="@guardando">
                                                <i class="bi bi-check-lg me-1"></i> Guardar
                                            </button>
                                            <button class="btn btn-secondary btn-sm d-flex align-items-center"
                                                    @onclick="CancelarEdicion" disabled="@guardando">
                                                <i class="bi bi-x-lg me-1"></i> Cancelar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                            // MODO LECTURA
                            else
                            {
                                <tr>
                                    <td class="ps-4 fw-medium text-primary">
                                        @NombreTipo(p.IdTipoDocumento)
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">@p.Prioridad</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold">@p.DiasMaximos</span> <span class="text-muted small">días</span>

                                        @* --- BADGE INFORMATIVO --- *@
                                        @if (p.DiasMaximos < 30)
                                        {
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info ms-2" style="font-size: 0.65rem;">HÁBILES</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning bg-opacity-10 text-dark border border-warning ms-2" style="font-size: 0.65rem;">CORRIDOS</span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-outline-primary btn-sm d-flex align-items-center"
                                                    @onclick="() => IniciarEdicion(p)"
                                                    disabled="@(idFilaEnEdicion != 0 || guardando)">
                                                <i class="bi bi-pencil-square me-1"></i> Editar
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm d-flex align-items-center"
                                                    @onclick="() => EliminarAsync(p)"
                                                    disabled="@(idFilaEnEdicion != 0 || guardando)">
                                                <i class="bi bi-trash me-1"></i> Borrar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<CfgTiemposRespuestum> plazos = new();
    private List<CatTipoDocumento> tipos = new();

    // Modelo para crear nuevo
    private CfgTiemposRespuestum nuevoPlazo = new() { Prioridad = "NORMAL", DiasMaximos = 5 };

    // Variables para control de edición de fila
    private int idFilaEnEdicion = 0; // 0 significa ninguna
    private CfgTiemposRespuestum filaEdicion = new(); // Copia temporal para editar

    private bool guardando;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarAsync();
    }

    private async Task CargarAsync()
    {
        try
        {
            var tiposTask = RepoTipos.GetAllAsync();
            var plazosTask = RepoPlazos.GetQueryable("IdTipoDocumentoNavigation")
                .OrderBy(x => x.IdTipoDocumento)
                .ThenBy(x => x.Prioridad)
                .ToListAsync();

            await Task.WhenAll(tiposTask, plazosTask);

            tipos = (await tiposTask).OrderBy(t => t.Nombre).ToList();
            plazos = await plazosTask;
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar datos: {ex.Message}";
        }
    }

    private string NombreTipo(int idTipo)
        => tipos.FirstOrDefault(t => t.IdTipo == idTipo)?.Nombre ?? $"ID: {idTipo}";

    // --- LÓGICA DE AGREGAR ---
    private async Task AgregarAsync()
    {
        LimpiarMensajes();

        if (!ValidarModelo(nuevoPlazo)) return;
        if (EsDuplicado(nuevoPlazo))
        {
            mensajeError = "Ya existe una configuración para ese tipo y prioridad.";
            return;
        }

        guardando = true;
        try
        {
            var entidad = new CfgTiemposRespuestum
            {
                IdTipoDocumento = nuevoPlazo.IdTipoDocumento,
                Prioridad = nuevoPlazo.Prioridad.Trim().ToUpperInvariant(),
                DiasMaximos = nuevoPlazo.DiasMaximos,
                HorasMaximas = nuevoPlazo.HorasMaximas
            };

            await RepoPlazos.AddAsync(entidad);

            nuevoPlazo = new CfgTiemposRespuestum { Prioridad = "NORMAL", DiasMaximos = 5 };
            await CargarAsync();
            mensajeExito = "Regla agregada correctamente.";
        }
        catch (Exception ex)
        {
            mensajeError = $"No se pudo agregar: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    // --- LÓGICA DE EDICIÓN ---
    private void IniciarEdicion(CfgTiemposRespuestum item)
    {
        LimpiarMensajes();
        idFilaEnEdicion = item.IdConfig;

        // Creamos una COPIA para editar, así no afectamos la lista visual hasta guardar
        filaEdicion = new CfgTiemposRespuestum
        {
            IdConfig = item.IdConfig,
            IdTipoDocumento = item.IdTipoDocumento,
            Prioridad = item.Prioridad,
            DiasMaximos = item.DiasMaximos,
            HorasMaximas = item.HorasMaximas
        };
    }

    private void CancelarEdicion()
    {
        idFilaEnEdicion = 0;
        filaEdicion = new();
        LimpiarMensajes();
    }

    private async Task GuardarEdicionAsync()
    {
        LimpiarMensajes();

        if (!ValidarModelo(filaEdicion)) return;

        // Verificamos duplicados excluyendo el propio ID que estamos editando
        if (EsDuplicado(filaEdicion, excluirId: filaEdicion.IdConfig))
        {
            mensajeError = "Conflicto: Ya existe otra regla con este tipo y prioridad.";
            return;
        }

        guardando = true;
        try
        {
            // Buscamos la entidad original (o usamos Repo para update directo)
            // Aquí enviamos la copia con los datos nuevos
            filaEdicion.Prioridad = filaEdicion.Prioridad.Trim().ToUpperInvariant();

            await RepoPlazos.UpdateAsync(filaEdicion);

            mensajeExito = "Cambios guardados exitosamente.";
            idFilaEnEdicion = 0; // Salir de edición
            await CargarAsync(); // Recargar lista
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    // --- LÓGICA DE ELIMINAR ---
    private async Task EliminarAsync(CfgTiemposRespuestum fila)
    {
        LimpiarMensajes();

        // Aquí podrías agregar un JS Confirm si lo deseas

        guardando = true;
        try
        {
            await RepoPlazos.DeleteAsync(fila.IdConfig);
            plazos.Remove(fila);
            mensajeExito = "Regla eliminada correctamente.";
        }
        catch (Exception ex)
        {
            mensajeError = $"No se pudo eliminar: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    // --- VALIDACIONES COMUNES ---
    private bool ValidarModelo(CfgTiemposRespuestum modelo)
    {
        if (modelo.IdTipoDocumento <= 0)
        {
            mensajeError = "Seleccione un tipo de documento.";
            return false;
        }
        if (string.IsNullOrWhiteSpace(modelo.Prioridad))
        {
            mensajeError = "La prioridad es obligatoria.";
            return false;
        }
        if (modelo.DiasMaximos < 0)
        {
            mensajeError = "Los días máximos no pueden ser negativos.";
            return false;
        }
        return true;
    }

    private bool EsDuplicado(CfgTiemposRespuestum modelo, int excluirId = 0)
    {
        var prioridad = modelo.Prioridad?.Trim();
        return plazos.Any(x => x.IdConfig != excluirId &&
                               x.IdTipoDocumento == modelo.IdTipoDocumento &&
                               string.Equals(x.Prioridad?.Trim(), prioridad, StringComparison.OrdinalIgnoreCase));
    }

    private void LimpiarMensajes()
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
    }

    // --- NUEVO: MÉTODO AUXILIAR PARA LA LEYENDA DEL DECRETO 500 ---
    private (string Texto, string ClaseColor) ObtenerLeyendaPlazo(int dias)
    {
        if (dias <= 0) return ("", "");

        if (dias < 30)
        {
            return ($"Se contarán como DÍAS HÁBILES (Decreto 500).", "text-info");
        }
        else
        {
            return ($"Se contarán como DÍAS CORRIDOS (Decreto 500).", "text-warning fw-bold");
        }
    }
}