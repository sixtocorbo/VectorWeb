@page "/configuracion/respaldo-bd"
@attribute [Authorize(Policy = "seguridad.usuarios_roles")]
@using Microsoft.AspNetCore.Authorization
@using VectorWeb.Services
@inject DatabaseBackupService BackupService
@rendermode InteractiveServer

<PageTitle>Respaldo de Base de Datos - Vector</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1 fw-bold"><i class="bi bi-database-fill-lock text-primary me-2"></i>Respaldo de Base de Datos</h3>
        <p class="text-muted mb-0 small">Genera un archivo <code>.bak</code> de la base de datos actual para recuperaci√≥n ante incidentes.</p>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            El respaldo se ejecuta en SQL Server y guarda el archivo en la carpeta configurada del servidor.
        </div>

        @if (!string.IsNullOrWhiteSpace(mensajeError))
        {
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>@mensajeError
            </div>
        }

        @if (resultado is not null)
        {
            <div class="alert alert-success" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                Respaldo generado para <strong>@resultado.DatabaseName</strong>.<br />
                <span class="small">Archivo: <code>@resultado.BackupPath</code></span><br />
                <span class="small">Fecha: @resultado.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</span>
            </div>
        }

        <button class="btn btn-primary" @onclick="GenerarRespaldoAsync" disabled="@procesando">
            @if (procesando)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Generando respaldo...</span>
            }
            else
            {
                <i class="bi bi-download me-2"></i>
                <span>Crear respaldo ahora</span>
            }
        </button>
    </div>
</div>

@code {
    private bool procesando;
    private string mensajeError = string.Empty;
    private DatabaseBackupResult? resultado;

    private async Task GenerarRespaldoAsync()
    {
        mensajeError = string.Empty;
        resultado = null;
        procesando = true;

        try
        {
            resultado = await BackupService.CreateBackupAsync();
        }
        catch (Exception ex)
        {
            mensajeError = ex.Message;
        }
        finally
        {
            procesando = false;
        }
    }
}
