@page "/configuracion/auditoria-permisos"
@attribute [Authorize(Policy = "seguridad.usuarios_roles")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<SegAuditoriaPermiso> RepoAuditoria
@rendermode InteractiveServer

<h3 class="mb-3"><i class="bi bi-clipboard-data"></i> Auditoría de permisos denegados</h3>

<div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Usuario/Rol/Permiso</label>
                <input class="form-control" @bind="filtroTexto" @bind:event="oninput" placeholder="Buscar..." />
            </div>
            <div class="col-md-3">
                <label class="form-label">Desde</label>
                <input class="form-control" type="date" @bind="fechaDesdeTexto" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Hasta</label>
                <input class="form-control" type="date" @bind="fechaHastaTexto" />
            </div>
            <div class="col-md-2 d-grid">
                <button class="btn btn-primary" @onclick="CargarAsync">
                    <i class="bi bi-arrow-clockwise me-2"></i>Filtrar
                </button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div class="alert alert-warning">@mensajeError</div>
}

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Permiso requerido</th>
                        <th>Módulo</th>
                        <th>Ruta</th>
                    </tr>
                </thead>
                <tbody>
                    @if (cargando)
                    {
                        <tr>
                            <td colspan="6" class="text-center p-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    }
                    else if (registros.Count == 0)
                    {
                        <tr>
                            <td colspan="6" class="text-center p-4 text-muted">Sin resultados.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in registros)
                        {
                            <tr>
                                <td>@item.FechaEvento.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                <td>@(item.UsuarioNombre ?? "desconocido")</td>
                                <td>@(item.Rol ?? "sin_rol")</td>
                                <td><code>@item.PermisoRequerido</code></td>
                                <td>@(item.Modulo ?? "-")</td>
                                <td>@(item.Ruta ?? "-")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private readonly List<SegAuditoriaPermiso> registros = [];
    private bool cargando;
    private string filtroTexto = string.Empty;
    private string? fechaDesdeTexto;
    private string? fechaHastaTexto;
    private string mensajeError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarAsync();
    }

    private async Task CargarAsync()
    {
        try
        {
            cargando = true;
            mensajeError = string.Empty;

            var query = RepoAuditoria.GetQueryable();

            if (!string.IsNullOrWhiteSpace(filtroTexto))
            {
                var texto = filtroTexto.Trim();
                query = query.Where(x =>
                    (x.UsuarioNombre != null && x.UsuarioNombre.Contains(texto)) ||
                    (x.Rol != null && x.Rol.Contains(texto)) ||
                    x.PermisoRequerido.Contains(texto));
            }

            if (DateTime.TryParse(fechaDesdeTexto, out var fechaDesde))
            {
                query = query.Where(x => x.FechaEvento >= fechaDesde.Date);
            }

            if (DateTime.TryParse(fechaHastaTexto, out var fechaHasta))
            {
                var hastaExclusivo = fechaHasta.Date.AddDays(1);
                query = query.Where(x => x.FechaEvento < hastaExclusivo);
            }

            var resultado = await query
                .OrderByDescending(x => x.FechaEvento)
                .Take(300)
                .ToListAsync();

            registros.Clear();
            registros.AddRange(resultado);
        }
        catch (Exception ex)
        {
            mensajeError = $"No se pudo cargar la auditoría: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }
}
