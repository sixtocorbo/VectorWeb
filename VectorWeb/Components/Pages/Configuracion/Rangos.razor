@page "/configuracion/rangos"
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@inject NumeracionRangoService RangoService
@inject IRepository<CatTipoDocumento> RepoTipos
@inject IRepository<CatOficina> RepoOficinas
@rendermode InteractiveServer

<h3>Gestión de Rangos de Documentos</h3>

@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div class="alert alert-danger" role="alert">@mensajeError</div>
}

@if (!string.IsNullOrWhiteSpace(mensajeOk))
{
    <div class="alert alert-success" role="alert">@mensajeOk</div>
}

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-primary" @onclick="AbrirNuevoRango">Nuevo Rango</button>
    <button class="btn btn-outline-primary" @onclick="AbrirNuevoCupo">Nuevo Cupo</button>
</div>

<table class="table table-striped table-sm">
    <thead>
        <tr>
            <th>Tipo</th>
            <th>Oficina</th>
            <th>Año</th>
            <th>Serie (auto)</th>
            <th>Desde</th>
            <th>Hasta</th>
            <th>Último</th>
            <th>Activo</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var rango in listaRangos)
        {
            <tr>
                <td>@(rango.IdTipoNavigation?.Nombre ?? $"Tipo {rango.IdTipo}")</td>
                <td>@(rango.IdOficinaNavigation?.Nombre ?? "Global")</td>
                <td>@rango.Anio</td>
                <td>@rango.NombreRango</td>
                <td>@rango.NumeroInicio</td>
                <td>@rango.NumeroFin</td>
                <td>@rango.UltimoUtilizado</td>
                <td>@(rango.Activo ? "Sí" : "No")</td>
                <td>
                    <button class="btn btn-sm btn-secondary" @onclick="() => Editar(rango)">Editar</button>
                    <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => EliminarRango(rango)">Eliminar</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Bitácora de cupos y rangos</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="RecargarBitacora">Actualizar</button>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Entidad</th>
                        <th>Acción</th>
                        <th>Tipo</th>
                        <th>Oficina</th>
                        <th>Año</th>
                        <th>Detalle</th>
                    </tr>
                </thead>
                <tbody>
                    @if (bitacora.Count == 0)
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted">No hay eventos registrados.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var evento in bitacora)
                        {
                            <tr>
                                <td>@evento.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@evento.Entidad</td>
                                <td>@evento.Accion</td>
                                <td>@(evento.IdTipoNavigation?.Nombre ?? $"Tipo {evento.IdTipo}")</td>
                                <td>@(evento.IdOficinaNavigation?.Nombre ?? "Global")</td>
                                <td>@evento.Anio</td>
                                <td>@evento.Detalle</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title mb-3">Libro mayor de cupos</h5>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Año</th>
                        <th>Cupo</th>
                        <th>Consumido</th>
                        <th>Disponible</th>
                        <th>Última gestión</th>
                    </tr>
                </thead>
                <tbody>
                    @if (libroMayorCupos.Count == 0)
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">No hay cupos registrados.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in libroMayorCupos)
                        {
                            <tr>
                                <td>@item.Tipo</td>
                                <td>@item.Anio</td>
                                <td>@item.Cantidad</td>
                                <td>@item.Consumido</td>
                                <td>@item.Disponible</td>
                                <td>@item.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (mostrarModal)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configurar Rango</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(mensajeErrorModalRango))
                    {
                        <div class="alert alert-danger" role="alert">@mensajeErrorModalRango</div>
                    }

                    <EditForm Model="rangoActual" OnValidSubmit="Guardar">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Tipo de Documento</label>
                                <InputSelect @bind-Value="rangoActual.IdTipo" class="form-control">
                                    <option value="0">-- Seleccione --</option>
                                    @foreach (var tipo in tipos)
                                    {
                                        <option value="@tipo.IdTipo">@tipo.Nombre</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Oficina (opcional)</label>
                                <InputSelect @bind-Value="OficinaSeleccionada" class="form-control">
                                    <option value="">Global (todas)</option>
                                    @foreach (var oficina in oficinas)
                                    {
                                        <option value="@oficina.IdOficina.ToString()">@oficina.Nombre</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Año</label>
                            <InputNumber @bind-Value="rangoActual.Anio" class="form-control" />
                            <small class="text-muted">El nombre del rango se genera automáticamente.</small>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <label>Desde</label>
                                <InputNumber @bind-Value="rangoActual.NumeroInicio" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label>Hasta</label>
                                <InputNumber @bind-Value="rangoActual.NumeroFin" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label>Último utilizado</label>
                                <InputNumber @bind-Value="rangoActual.UltimoUtilizado" class="form-control" />
                            </div>
                        </div>

                        <div class="mb-3 form-check mt-3">
                            <InputCheckbox @bind-Value="rangoActual.Activo" class="form-check-input" />
                            <label class="form-check-label">Activo</label>
                        </div>

                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@if (mostrarModalCupo)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configurar Cupo</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalCupo"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(mensajeErrorModalCupo))
                    {
                        <div class="alert alert-danger" role="alert">@mensajeErrorModalCupo</div>
                    }

                    <div class="mb-3">
                        <label>Tipo de Documento</label>
                        <InputSelect @bind-Value="cupoTipoSeleccionado" class="form-control" @onchange="OnCupoFiltroCambio">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var tipo in tipos)
                            {
                                <option value="@tipo.IdTipo">@tipo.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="mb-3">
                        <label>Año</label>
                        <InputNumber @bind-Value="cupoAnio" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Cantidad de cupo</label>
                        <InputNumber @bind-Value="cupoCantidad" class="form-control" />
                    </div>
                    @if (cupoTipoSeleccionado > 0)
                    {
                        <small class="text-muted d-block mb-3">Consumido en rangos activos: @cupoConsumido de @cupoCantidad (año @cupoAnio).</small>
                    }
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" @onclick="GuardarCupo">Guardar cupo</button>
                        <button type="button" class="btn btn-secondary" @onclick="CerrarModalCupo">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<MaeNumeracionRango> listaRangos = new();
    private List<CatTipoDocumento> tipos = new();
    private List<CatOficina> oficinas = new();
    private MaeNumeracionRango rangoActual = new();
    private bool mostrarModal;
    private string mensajeError = string.Empty;
    private string mensajeOk = string.Empty;
    private string mensajeErrorModalRango = string.Empty;
    private string mensajeErrorModalCupo = string.Empty;
    private int cupoTipoSeleccionado;
    private int cupoAnio = DateTime.Now.Year;
    private int cupoCantidad;
    private int cupoConsumido;
    private List<MaeNumeracionBitacora> bitacora = new();
    private bool mostrarModalCupo;
    private List<CupoLibroMayorItem> libroMayorCupos = new();

    private string OficinaSeleccionada
    {
        get => rangoActual.IdOficina?.ToString() ?? string.Empty;
        set
        {
            if (int.TryParse(value, out var idOficina))
            {
                rangoActual.IdOficina = idOficina;
            }
            else
            {
                rangoActual.IdOficina = null;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarCatalogos();
        await CargarRangos();
        await CargarDatosCupoAsync();
        await CargarLibroMayorCuposAsync();
        await RecargarBitacora();
    }

    private async Task CargarLibroMayorCuposAsync()
    {
        libroMayorCupos = await RangoService.ObtenerLibroMayorCuposAsync();
    }

    private async Task CargarCatalogos()
    {
        tipos = (await RepoTipos.GetAllAsync()).OrderBy(t => t.Nombre).ToList();
        oficinas = (await RepoOficinas.GetAllAsync()).OrderBy(o => o.Nombre).ToList();
    }

    private async Task CargarRangos()
    {
        listaRangos = await RangoService.ObtenerRangosAsync();
    }

    private async Task RecargarBitacora()
    {
        bitacora = await RangoService.ObtenerBitacoraAsync();
    }

    private async Task CargarDatosCupoAsync()
    {
        if (cupoTipoSeleccionado <= 0 || cupoAnio <= 0)
        {
            cupoCantidad = 0;
            cupoConsumido = 0;
            return;
        }

        cupoCantidad = await RangoService.ObtenerCantidadCupoAsync(cupoTipoSeleccionado, cupoAnio) ?? 0;
        cupoConsumido = await RangoService.ObtenerConsumoAcumuladoAsync(cupoTipoSeleccionado, cupoAnio);
    }

    private async Task OnCupoFiltroCambio(ChangeEventArgs _)
    {
        await CargarDatosCupoAsync();
    }

    private async Task GuardarCupo()
    {
        mensajeError = string.Empty;
        mensajeOk = string.Empty;
        mensajeErrorModalCupo = string.Empty;

        if (cupoTipoSeleccionado <= 0)
        {
            mensajeErrorModalCupo = "Debe seleccionar un tipo de documento para configurar el cupo.";
            return;
        }

        if (cupoAnio < 2000 || cupoAnio > 2100)
        {
            mensajeErrorModalCupo = "Debe indicar un año válido para el cupo.";
            return;
        }

        if (cupoCantidad < 0)
        {
            mensajeErrorModalCupo = "La cantidad de cupo no puede ser negativa.";
            return;
        }

        if (cupoCantidad < cupoConsumido)
        {
            mensajeErrorModalCupo = $"El cupo no puede ser menor al consumo actual ({cupoConsumido}).";
            return;
        }

        var resultado = await RangoService.GuardarCupoAsync(cupoTipoSeleccionado, cupoAnio, cupoCantidad);
        if (!resultado.Exitoso)
        {
            mensajeErrorModalCupo = resultado.Mensaje;
            return;
        }

        mensajeOk = "Cupo guardado correctamente.";
        await CargarDatosCupoAsync();
        await CargarLibroMayorCuposAsync();
        await RecargarBitacora();
        mostrarModalCupo = false;
    }

    private void AbrirNuevoCupo()
    {
        mensajeError = string.Empty;
        mensajeOk = string.Empty;
        mensajeErrorModalCupo = string.Empty;
        mostrarModalCupo = true;
    }

    private void AbrirNuevoRango()
    {
        mensajeError = string.Empty;
        mensajeOk = string.Empty;
        mensajeErrorModalRango = string.Empty;
        rangoActual = new MaeNumeracionRango
        {
            NombreRango = "AUTO",
            NumeroInicio = 1,
            NumeroFin = 999999,
            UltimoUtilizado = 0,
            Activo = true,
            Anio = DateTime.Now.Year
        };
        mostrarModal = true;
    }

    private void Editar(MaeNumeracionRango rango)
    {
        mensajeError = string.Empty;
        mensajeOk = string.Empty;
        mensajeErrorModalRango = string.Empty;
        rangoActual = new MaeNumeracionRango
        {
            IdRango = rango.IdRango,
            IdTipo = rango.IdTipo,
            NombreRango = rango.NombreRango,
            NumeroInicio = rango.NumeroInicio,
            NumeroFin = rango.NumeroFin,
            UltimoUtilizado = rango.UltimoUtilizado,
            Activo = rango.Activo,
            FechaCreacion = rango.FechaCreacion,
            IdOficina = rango.IdOficina,
            Anio = rango.Anio
        };

        cupoTipoSeleccionado = rango.IdTipo;
        cupoAnio = rango.Anio;
        _ = CargarDatosCupoAsync();
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        mensajeErrorModalRango = string.Empty;
    }

    private void CerrarModalCupo()
    {
        mostrarModalCupo = false;
        mensajeErrorModalCupo = string.Empty;
    }

    private async Task Guardar()
    {
        mensajeError = string.Empty;
        mensajeOk = string.Empty;
        mensajeErrorModalRango = string.Empty;

        if (rangoActual.IdTipo <= 0)
        {
            mensajeErrorModalRango = "Debe seleccionar un tipo de documento.";
            return;
        }


        if (rangoActual.NumeroInicio <= 0 || rangoActual.NumeroFin <= 0)
        {
            mensajeErrorModalRango = "Los valores de rango deben ser mayores a cero.";
            return;
        }

        if (rangoActual.NumeroInicio > rangoActual.NumeroFin)
        {
            mensajeErrorModalRango = "El número inicial no puede ser mayor al número final.";
            return;
        }

        if (rangoActual.UltimoUtilizado < rangoActual.NumeroInicio - 1 || rangoActual.UltimoUtilizado > rangoActual.NumeroFin)
        {
            mensajeErrorModalRango = "El último utilizado debe estar entre (desde - 1) y hasta.";
            return;
        }

        if (rangoActual.Anio < 2000 || rangoActual.Anio > 2100)
        {
            mensajeErrorModalRango = "Debe indicar un año válido para el rango.";
            return;
        }

        var resultado = await RangoService.GuardarRangoAsync(rangoActual);
        if (!resultado.Exitoso)
        {
            mensajeErrorModalRango = resultado.Mensaje;
            return;
        }
        mostrarModal = false;
        mensajeOk = "Rango guardado correctamente.";
        await CargarRangos();
        await CargarDatosCupoAsync();
        await CargarLibroMayorCuposAsync();
        await RecargarBitacora();
    }

    private async Task EliminarRango(MaeNumeracionRango rango)
    {
        mensajeError = string.Empty;
        mensajeOk = string.Empty;

        var resultado = await RangoService.EliminarRangoAsync(rango.IdRango);
        if (!resultado.Exitoso)
        {
            mensajeError = resultado.Mensaje;
            return;
        }

        mensajeOk = "Rango eliminado correctamente.";
        await CargarRangos();
        await CargarDatosCupoAsync();
        await CargarLibroMayorCuposAsync();
        await RecargarBitacora();
    }

}
