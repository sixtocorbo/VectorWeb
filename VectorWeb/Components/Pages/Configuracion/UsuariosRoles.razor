@page "/configuracion/usuarios"
@attribute [Authorize]
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<CatUsuario> RepoUsuarios
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CfgSistemaParametro> RepoParametros
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>Seguridad: Usuarios y Roles</h3>

@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @mensajeError
        <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(mensajeExito))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @mensajeExito
        <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
    </div>
}

<div class="card mb-4">
    <div class="card-header fw-bold">Mantenimiento de Roles</div>
    <div class="card-body">
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <input class="form-control" placeholder="Ej: SUPERVISOR" @bind="nuevoRol" />
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="AgregarRol">
                    <i class="bi bi-plus-lg"></i> Agregar rol
                </button>
            </div>
        </div>

        <div class="mt-3 d-flex flex-wrap gap-2">
            @foreach (var rol in rolesDisponibles.OrderBy(r => r))
            {
                <span class="badge bg-secondary fs-6">
                    @rol
                    @if (!RolEnUso(rol))
                    {
                        <button class="btn btn-sm text-white p-0 ms-2"
                                title="Eliminar rol"
                                style="line-height:1"
                                @onclick="() => EliminarRol(rol)">
                            ×
                        </button>
                    }
                </span>
            }
        </div>
        <small class="text-muted d-block mt-2">Solo puedes eliminar roles que no tengan usuarios asignados.</small>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header fw-bold">Crear nuevo usuario</div>
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-3">
                <label class="form-label">Nombre completo</label>
                <input class="form-control" @bind="nuevoNombre" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Usuario login</label>
                <input class="form-control" @bind="nuevoLogin" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Clave</label>
                <input type="password" class="form-control" @bind="nuevoPassword" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Rol</label>
                <select class="form-select" @bind="nuevoRolAsignado">
                    @foreach (var rol in rolesDisponibles.OrderBy(r => r))
                    {
                        <option value="@rol">@rol</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Oficina</label>
                <select class="form-select" @bind="nuevaOficinaId">
                    <option value="">-- Sin oficina --</option>
                    @foreach (var oficina in oficinas.OrderBy(o => o.Nombre))
                    {
                        <option value="@oficina.IdOficina">@oficina.Nombre</option>
                    }
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-success w-100" @onclick="CrearUsuario">
                    <i class="bi bi-save"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <input class="form-control" placeholder="Buscar por nombre, login o rol" @bind="busqueda" @bind:event="oninput" />
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Login</th>
                <th>Rol</th>
                <th>Oficina</th>
                <th>Activo</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var usuario in UsuariosFiltrados)
            {
                <tr>
                    @if (editandoId == usuario.IdUsuario)
                    {
                        <td><input class="form-control form-control-sm" @bind="edicionNombre" /></td>
                        <td><input class="form-control form-control-sm" @bind="edicionLogin" /></td>
                        <td>
                            <select class="form-select form-select-sm" @bind="edicionRol">
                                @foreach (var rol in rolesDisponibles.OrderBy(r => r))
                                {
                                    <option value="@rol">@rol</option>
                                }
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" @bind="edicionOficinaId">
                                <option value="">-- Sin oficina --</option>
                                @foreach (var oficina in oficinas.OrderBy(o => o.Nombre))
                                {
                                    <option value="@oficina.IdOficina">@oficina.Nombre</option>
                                }
                            </select>
                        </td>
                        <td>
                            <input class="form-check-input" type="checkbox" @bind="edicionActivo" />
                        </td>
                        <td class="text-end">
                            <div class="input-group input-group-sm justify-content-end">
                                <input class="form-control" type="password" placeholder="Nueva clave (opcional)" @bind="edicionPassword" />
                                <button class="btn btn-success" @onclick="() => GuardarEdicion(usuario.IdUsuario)"><i class="bi bi-check"></i></button>
                                <button class="btn btn-outline-secondary" @onclick="CancelarEdicion"><i class="bi bi-x"></i></button>
                            </div>
                        </td>
                    }
                    else
                    {
                        <td>@usuario.NombreCompleto</td>
                        <td>@usuario.UsuarioLogin</td>
                        <td><span class="badge bg-dark">@RolMostrar(usuario.Rol)</span></td>
                        <td>@NombreOficina(usuario.IdOficina)</td>
                        <td>
                            <span class="badge @(usuario.Activo == true ? "bg-success" : "bg-secondary")">
                                @(usuario.Activo == true ? "Sí" : "No")
                            </span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-outline-primary btn-sm me-1" @onclick="() => IniciarEdicion(usuario)">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" @onclick="() => ToggleActivo(usuario)">
                                <i class="bi @(usuario.Activo == true ? "bi-person-x" : "bi-person-check")"></i>
                            </button>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private const string ParametroRoles = "SEGURIDAD_ROLES_HABILITADOS";

    private List<CatUsuario> usuarios = new();
    private List<CatOficina> oficinas = new();
    private HashSet<string> rolesDisponibles = new(StringComparer.OrdinalIgnoreCase);

    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string busqueda = string.Empty;

    // Nuevo usuario
    private string nuevoNombre = string.Empty;
    private string nuevoLogin = string.Empty;
    private string nuevoPassword = string.Empty;
    private string nuevoRolAsignado = "OPERADOR";
    private int? nuevaOficinaId;

    // Mantenimiento de roles
    private string nuevoRol = string.Empty;

    // Edición
    private int? editandoId;
    private string edicionNombre = string.Empty;
    private string edicionLogin = string.Empty;
    private string edicionRol = string.Empty;
    private bool edicionActivo;
    private int? edicionOficinaId;
    private string edicionPassword = string.Empty;

    private IEnumerable<CatUsuario> UsuariosFiltrados => usuarios
        .Where(u =>
            string.IsNullOrWhiteSpace(busqueda) ||
            u.NombreCompleto.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
            u.UsuarioLogin.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
            RolMostrar(u.Rol).Contains(busqueda, StringComparison.OrdinalIgnoreCase))
        .OrderBy(u => u.NombreCompleto);

    protected override async Task OnInitializedAsync() => await CargarTodo();

    private async Task CargarTodo()
    {
        usuarios = (await RepoUsuarios.GetAllAsync()).OrderBy(u => u.NombreCompleto).ToList();
        oficinas = (await RepoOficinas.GetAllAsync()).OrderBy(o => o.Nombre).ToList();
        await CargarRolesAsync();

        if (!rolesDisponibles.Contains(nuevoRolAsignado))
        {
            nuevoRolAsignado = rolesDisponibles.FirstOrDefault() ?? "OPERADOR";
        }
    }

    private async Task CargarRolesAsync()
    {
        rolesDisponibles = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "ADMIN",
            "OPERADOR"
        };

        foreach (var rolUsuario in usuarios
                     .Select(u => u.Rol)
                     .Where(r => !string.IsNullOrWhiteSpace(r))
                     .Select(r => r!.Trim().ToUpperInvariant()))
        {
            rolesDisponibles.Add(rolUsuario);
        }

        var parametro = (await RepoParametros.FindAsync(p => p.Clave == ParametroRoles)).FirstOrDefault();
        if (parametro is null || string.IsNullOrWhiteSpace(parametro.Valor))
        {
            return;
        }

        foreach (var rol in parametro.Valor.Split('|', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
        {
            rolesDisponibles.Add(rol.Trim().ToUpperInvariant());
        }
    }

    private async Task CrearUsuario()
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;

        if (string.IsNullOrWhiteSpace(nuevoNombre) ||
            string.IsNullOrWhiteSpace(nuevoLogin) ||
            string.IsNullOrWhiteSpace(nuevoPassword) ||
            string.IsNullOrWhiteSpace(nuevoRolAsignado))
        {
            mensajeError = "Debes completar nombre, login, clave y rol.";
            return;
        }

        var loginNormalizado = nuevoLogin.Trim();
        var existeLogin = await RepoUsuarios.FindAsync(u => u.UsuarioLogin == loginNormalizado);
        if (existeLogin.Any())
        {
            mensajeError = "Ya existe un usuario con ese login.";
            return;
        }

        var rol = nuevoRolAsignado.Trim().ToUpperInvariant();

        await RepoUsuarios.AddAsync(new CatUsuario
        {
            NombreCompleto = nuevoNombre.Trim(),
            UsuarioLogin = loginNormalizado,
            Clave = nuevoPassword,
            Rol = rol,
            Activo = true,
            IdOficina = nuevaOficinaId
        });

        rolesDisponibles.Add(rol);
        await GuardarRolesAsync();

        nuevoNombre = string.Empty;
        nuevoLogin = string.Empty;
        nuevoPassword = string.Empty;
        nuevaOficinaId = null;

        await CargarTodo();
        mensajeExito = "Usuario creado correctamente.";
    }

    private void IniciarEdicion(CatUsuario usuario)
    {
        editandoId = usuario.IdUsuario;
        edicionNombre = usuario.NombreCompleto;
        edicionLogin = usuario.UsuarioLogin;
        edicionRol = RolMostrar(usuario.Rol);
        edicionActivo = usuario.Activo == true;
        edicionOficinaId = usuario.IdOficina;
        edicionPassword = string.Empty;

        if (!rolesDisponibles.Contains(edicionRol))
        {
            rolesDisponibles.Add(edicionRol);
        }
    }

    private async Task GuardarEdicion(int idUsuario)
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;

        var usuario = usuarios.FirstOrDefault(u => u.IdUsuario == idUsuario);
        if (usuario is null)
        {
            mensajeError = "No se encontró el usuario a editar.";
            return;
        }

        if (string.IsNullOrWhiteSpace(edicionNombre) || string.IsNullOrWhiteSpace(edicionLogin) || string.IsNullOrWhiteSpace(edicionRol))
        {
            mensajeError = "Nombre, login y rol son obligatorios.";
            return;
        }

        var loginNormalizado = edicionLogin.Trim();
        var loginRepetido = usuarios.Any(u => u.IdUsuario != idUsuario &&
                                             u.UsuarioLogin.Equals(loginNormalizado, StringComparison.OrdinalIgnoreCase));
        if (loginRepetido)
        {
            mensajeError = "El login indicado ya está asignado a otro usuario.";
            return;
        }

        usuario.NombreCompleto = edicionNombre.Trim();
        usuario.UsuarioLogin = loginNormalizado;
        usuario.Rol = edicionRol.Trim().ToUpperInvariant();
        usuario.Activo = edicionActivo;
        usuario.IdOficina = edicionOficinaId;

        if (!string.IsNullOrWhiteSpace(edicionPassword))
        {
            usuario.Clave = edicionPassword;
        }

        await RepoUsuarios.UpdateAsync(usuario);

        rolesDisponibles.Add(usuario.Rol);
        await GuardarRolesAsync();

        CancelarEdicion();
        await CargarTodo();
        mensajeExito = "Usuario actualizado correctamente.";
    }

    private async Task ToggleActivo(CatUsuario usuario)
    {
        usuario.Activo = usuario.Activo != true;
        await RepoUsuarios.UpdateAsync(usuario);

        await CargarTodo();
        mensajeExito = usuario.Activo == true
            ? "Usuario activado."
            : "Usuario desactivado.";
    }

    private void CancelarEdicion()
    {
        editandoId = null;
        edicionPassword = string.Empty;
    }

    private async Task AgregarRol()
    {
        var rolNormalizado = nuevoRol.Trim().ToUpperInvariant();
        if (string.IsNullOrWhiteSpace(rolNormalizado))
        {
            mensajeError = "Debes digitar un nombre de rol.";
            return;
        }

        rolesDisponibles.Add(rolNormalizado);
        nuevoRol = string.Empty;

        await GuardarRolesAsync();
        mensajeExito = "Rol agregado.";
        mensajeError = string.Empty;
    }

    private async Task EliminarRol(string rol)
    {
        if (RolEnUso(rol))
        {
            mensajeError = "No se puede eliminar un rol que tiene usuarios asignados.";
            return;
        }

        var confirmar = await JS.InvokeAsync<bool>("confirm", $"¿Eliminar el rol '{rol}'?");
        if (!confirmar)
        {
            return;
        }

        rolesDisponibles.Remove(rol);
        await GuardarRolesAsync();
        mensajeExito = "Rol eliminado.";
        mensajeError = string.Empty;
    }

    private bool RolEnUso(string rol)
        => usuarios.Any(u => RolMostrar(u.Rol).Equals(rol, StringComparison.OrdinalIgnoreCase));

    private async Task GuardarRolesAsync()
    {
        var valor = string.Join("|", rolesDisponibles.OrderBy(r => r));
        var parametro = (await RepoParametros.FindAsync(p => p.Clave == ParametroRoles)).FirstOrDefault();
        var nombreUsuario = await ObtenerNombreUsuarioActualAsync();

        if (parametro is null)
        {
            await RepoParametros.AddAsync(new CfgSistemaParametro
            {
                Clave = ParametroRoles,
                Valor = valor,
                Descripcion = "Listado de roles habilitados para administración de usuarios.",
                UsuarioActualizacion = nombreUsuario,
                FechaActualizacion = DateTime.Now
            });
            return;
        }

        parametro.Valor = valor;
        parametro.Descripcion = "Listado de roles habilitados para administración de usuarios.";
        parametro.UsuarioActualizacion = nombreUsuario;
        parametro.FechaActualizacion = DateTime.Now;

        await RepoParametros.UpdateAsync(parametro);
    }

    private async Task<string> ObtenerNombreUsuarioActualAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        return authState.User.FindFirstValue(ClaimTypes.Name) ?? "sistema";
    }

    private static string RolMostrar(string? rol)
        => string.IsNullOrWhiteSpace(rol) ? "OPERADOR" : rol.Trim().ToUpperInvariant();

    private string NombreOficina(int? id)
        => oficinas.FirstOrDefault(o => o.IdOficina == id)?.Nombre ?? "--";
}
