@page "/configuracion/usuarios"
@attribute [Authorize(Policy = "seguridad.usuarios_roles")]
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services.Security
@inject IRepository<CatUsuario> RepoUsuarios
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CfgSistemaParametro> RepoParametros
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject RolePermissionService RolePermissionService
@rendermode InteractiveServer

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-shield-lock"></i> Seguridad: Usuarios y Roles</h3>
</div>

@* --- MENSAJES GLOBALES --- *@
@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>@mensajeError
        <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(mensajeExito))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>@mensajeExito
        <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
    </div>
}

@* --- PESTAÑAS --- *@
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <button class="nav-link @(tabActiva == TabSeguridad.Usuarios ? "active fw-bold border-primary border-bottom-0" : "")"
                @onclick="() => tabActiva = TabSeguridad.Usuarios">
            <i class="bi bi-people me-2"></i>Usuarios
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(tabActiva == TabSeguridad.Roles ? "active fw-bold border-dark border-bottom-0 text-dark" : "text-muted")"
                @onclick="() => tabActiva = TabSeguridad.Roles">
            <i class="bi bi-person-badge me-2"></i>Roles
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(tabActiva == TabSeguridad.Permisos ? "active fw-bold border-success border-bottom-0 text-success" : "text-muted")"
                @onclick="() => tabActiva = TabSeguridad.Permisos">
            <i class="bi bi-shield-check me-2"></i>Permisos
        </button>
    </li>
</ul>

@* --- CONTENIDO: USUARIOS --- *@
@if (tabActiva == TabSeguridad.Usuarios)
{
    <div class="card shadow-sm border-0 animate__animated animate__fadeIn">
        <div class="card-body">
            <div class="row g-2 align-items-center mb-4">
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" @onclick="AbrirModalNuevo">
                        <i class="bi bi-person-plus-fill me-2"></i> Nuevo Usuario
                    </button>
                </div>
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input class="form-control border-start-0 ps-0"
                               placeholder="Buscar por nombre, login o rol..."
                               @bind="busqueda" @bind:event="oninput" />
                        @if (!string.IsNullOrEmpty(busqueda))
                        {
                            <button class="btn btn-outline-secondary" @onclick="() => busqueda = string.Empty">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Login</th>
                            <th>Rol</th>
                            <th>Oficina Asignada</th>
                            <th class="text-center">Estado</th>
                            <th class="text-end" style="min-width: 220px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!UsuariosFiltrados.Any())
                        {
                            <tr><td colspan="6" class="text-center py-5 text-muted">No se encontraron usuarios.</td></tr>
                        }
                        else
                        {
                            @foreach (var usuario in UsuariosFiltrados)
                            {
                                <tr class="@(usuario.Activo != true ? "bg-light text-muted" : "")">
                                    <td class="fw-bold">@usuario.NombreCompleto</td>
                                    <td><code>@usuario.UsuarioLogin</code></td>
                                    <td>
                                        <span class="badge @ObtenerBadgeRol(usuario.Rol)">@RolMostrar(usuario.Rol)</span>
                                    </td>
                                    <td>
                                        @if (usuario.IdOficina != null)
                                        {
                                            <i class="bi bi-building me-1 text-secondary"></i> 
                                            @NombreOficina(usuario.IdOficina)
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">-- Sin oficina --</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (usuario.Activo == true)
                                        {
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success">Activo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactivo</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => AbrirModalEditar(usuario)">
                                            <i class="bi bi-pencil me-1"></i>Editar
                                        </button>

                                        @if (usuario.Activo == true)
                                        {
                                            <button class="btn btn-sm btn-outline-warning" @onclick="() => ToggleActivo(usuario)">
                                                <i class="bi bi-person-slash me-1"></i>Desactivar
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => ToggleActivo(usuario)">
                                                <i class="bi bi-person-check me-1"></i>Activar
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@* --- CONTENIDO: ROLES --- *@
@if (tabActiva == TabSeguridad.Roles)
{
    <div class="card shadow-sm border-0 animate__animated animate__fadeIn">
        <div class="card-body">
            <h5 class="card-title mb-3">Administración de Roles</h5>

            <div class="row g-2 align-items-center mb-4 p-3 bg-light rounded border">
                <div class="col-md-5">
                    <label class="form-label small text-muted mb-1">Nombre del nuevo rol</label>
                    <input class="form-control" placeholder="Ej: SUPERVISOR" @bind="nuevoRol" />
                </div>
                <div class="col-auto d-flex align-items-end mt-4">
                    <button class="btn btn-dark" @onclick="AgregarRol">
                        <i class="bi bi-plus-lg me-1"></i> Agregar Rol
                    </button>
                </div>
            </div>

            <p class="text-muted mb-2">Roles disponibles en el sistema:</p>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var rol in rolesDisponibles.OrderBy(r => r))
                {
                    var esAdmin = rol.Equals("ADMIN", StringComparison.OrdinalIgnoreCase);
                    var enUso = RolEnUso(rol);

                    <div class="card border @(esAdmin ? "border-danger" : "border-secondary")" style="min-width: 220px;">
                        <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                            <span class="fw-bold @(esAdmin ? "text-danger" : "")">@rol</span>

                            @if (!enUso && !esAdmin)
                            {
                                <button class="btn btn-sm btn-outline-danger ms-2"
                                        @onclick="() => EliminarRol(rol)">
                                    <i class="bi bi-trash me-1"></i>Eliminar
                                </button>
                            }
                            else if (enUso)
                            {
                                <span class="badge bg-light text-muted border ms-2" title="En uso por usuarios">En uso</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (tabActiva == TabSeguridad.Permisos)
{
    <div class="card shadow-sm border-0 animate__animated animate__fadeIn">
        <div class="card-body">
            <h5 class="card-title mb-3">Matriz de permisos por rol</h5>
            <p class="text-muted">Define qué acciones puede ejecutar cada rol dentro del sistema.</p>

            @foreach (var rol in rolesDisponibles.OrderBy(r => r))
            {
                <div class="border rounded p-3 mb-3">
                    <h6 class="fw-bold mb-3">@rol</h6>
                    <div class="row g-2">
                        @foreach (var permiso in AppPermissions.Todos)
                        {
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           id="perm_@rol.Replace(" ", "_")_@permiso.Replace(".", "_")"
                                           checked="@TienePermiso(rol, permiso)"
                                           @onchange="e => TogglePermiso(rol, permiso, e.Value is true)" />
                                    <label class="form-check-label" for="perm_@rol.Replace(" ", "_")_@permiso.Replace(".", "_")">
                                        @EtiquetaPermiso(permiso)
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <button class="btn btn-success" @onclick="GuardarPermisosAsync">
                <i class="bi bi-save me-1"></i> Guardar permisos
            </button>
        </div>
    </div>
}

@* --- MODAL USUARIO (CREAR / EDITAR) --- *@
@if (mostrarModalUsuario)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">@(usuarioEdicion.IdUsuario == 0 ? "Nuevo Usuario" : "Editar Usuario")</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre Completo</label>
                        <input class="form-control" @bind="usuarioEdicion.NombreCompleto" placeholder="Ej: Juan Pérez" />
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Usuario Login</label>
                            <input class="form-control" @bind="usuarioEdicion.UsuarioLogin" placeholder="Ej: jperez" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Rol</label>
                            <select class="form-select" @bind="usuarioEdicion.Rol">
                                @foreach (var rol in rolesDisponibles.OrderBy(r => r))
                                {
                                    <option value="@rol">@rol</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Oficina</label>
                        <select class="form-select" @bind="usuarioEdicion.IdOficina">
                            <option value="">-- Sin oficina (Global) --</option>
                            @foreach (var oficina in oficinas.OrderBy(o => o.Nombre))
                            {
                                <option value="@oficina.IdOficina">@oficina.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            @(usuarioEdicion.IdUsuario == 0 ? "Contraseña" : "Nueva Contraseña (Opcional)")
                        </label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key"></i></span>
                            <input type="password" class="form-control" @bind="passwordEdicion"
                                   placeholder="@(usuarioEdicion.IdUsuario == 0 ? "Requerida" : "Dejar en blanco para mantener actual")" />
                        </div>
                    </div>

                    @if (usuarioEdicion.IdUsuario > 0)
                    {
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="chkActivo" @bind="usuarioEdicion.Activo" />
                            <label class="form-check-label" for="chkActivo">Usuario habilitado para ingresar</label>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="GuardarUsuario">
                        <i class="bi bi-save me-1"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum TabSeguridad { Usuarios, Roles, Permisos }
    private TabSeguridad tabActiva = TabSeguridad.Usuarios;
    private const string ParametroRoles = "SEGURIDAD_ROLES_HABILITADOS";

    private List<CatUsuario> usuarios = new();
    private List<CatOficina> oficinas = new();
    private HashSet<string> rolesDisponibles = new(StringComparer.OrdinalIgnoreCase);
    private Dictionary<string, HashSet<string>> permisosPorRol = new(StringComparer.OrdinalIgnoreCase);

    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string busqueda = string.Empty;

    // Estado Modal
    private bool mostrarModalUsuario = false;
    private CatUsuario usuarioEdicion = new();
    private string passwordEdicion = string.Empty;

    // Roles
    private string nuevoRol = string.Empty;

    private IEnumerable<CatUsuario> UsuariosFiltrados => usuarios
        .Where(u =>
            string.IsNullOrWhiteSpace(busqueda) ||
            u.NombreCompleto.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
            u.UsuarioLogin.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
            RolMostrar(u.Rol).Contains(busqueda, StringComparison.OrdinalIgnoreCase))
        .OrderBy(u => u.NombreCompleto);

    protected override async Task OnInitializedAsync() => await CargarTodo();

    private async Task CargarTodo()
    {
        usuarios = (await RepoUsuarios.GetAllAsync()).OrderBy(u => u.NombreCompleto).ToList();
        oficinas = (await RepoOficinas.GetAllAsync()).OrderBy(o => o.Nombre).ToList();
        await CargarRolesAsync();
        await CargarPermisosAsync();
    }

    private async Task CargarRolesAsync()
    {
        rolesDisponibles = new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "ADMIN", "OPERADOR" };

        foreach (var rolUsuario in usuarios.Select(u => u.Rol).Where(r => !string.IsNullOrWhiteSpace(r)))
        {
            rolesDisponibles.Add(rolUsuario!.Trim().ToUpperInvariant());
        }

        var parametro = (await RepoParametros.FindAsync(p => p.Clave == ParametroRoles)).FirstOrDefault();
        if (parametro != null && !string.IsNullOrWhiteSpace(parametro.Valor))
        {
            foreach (var rol in parametro.Valor.Split('|', StringSplitOptions.RemoveEmptyEntries))
            {
                rolesDisponibles.Add(rol.Trim().ToUpperInvariant());
            }
        }
    }

    // --- LÓGICA DE USUARIOS ---

    private void AbrirModalNuevo()
    {
        mensajeError = string.Empty;
        usuarioEdicion = new CatUsuario { Activo = true, Rol = "OPERADOR" };
        passwordEdicion = string.Empty;
        mostrarModalUsuario = true;
    }

    private void AbrirModalEditar(CatUsuario usuario)
    {
        mensajeError = string.Empty;
        usuarioEdicion = new CatUsuario
        {
            IdUsuario = usuario.IdUsuario,
            NombreCompleto = usuario.NombreCompleto,
            UsuarioLogin = usuario.UsuarioLogin,
            Rol = usuario.Rol,
            IdOficina = usuario.IdOficina,
            Activo = usuario.Activo,
            Clave = usuario.Clave
        };
        passwordEdicion = string.Empty;
        mostrarModalUsuario = true;
    }

    private void CerrarModal()
    {
        mostrarModalUsuario = false;
        usuarioEdicion = new();
    }

    private async Task GuardarUsuario()
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;

        if (string.IsNullOrWhiteSpace(usuarioEdicion.NombreCompleto) ||
            string.IsNullOrWhiteSpace(usuarioEdicion.UsuarioLogin) ||
            string.IsNullOrWhiteSpace(usuarioEdicion.Rol))
        {
            mensajeError = "Nombre, Login y Rol son obligatorios.";
            return;
        }

        if (usuarioEdicion.IdUsuario == 0 && string.IsNullOrWhiteSpace(passwordEdicion))
        {
            mensajeError = "La contraseña es obligatoria para nuevos usuarios.";
            return;
        }

        var loginNormalizado = usuarioEdicion.UsuarioLogin.Trim();
        var existeLogin = usuarios.Any(u => u.IdUsuario != usuarioEdicion.IdUsuario &&
                                            u.UsuarioLogin.Equals(loginNormalizado, StringComparison.OrdinalIgnoreCase));
        if (existeLogin)
        {
            mensajeError = "El usuario login ya está en uso.";
            return;
        }

        usuarioEdicion.UsuarioLogin = loginNormalizado;
        usuarioEdicion.Rol = usuarioEdicion.Rol!.Trim().ToUpperInvariant();

        if (!string.IsNullOrWhiteSpace(passwordEdicion))
        {
            usuarioEdicion.Clave = passwordEdicion;
        }

        if (usuarioEdicion.IdUsuario == 0)
        {
            await RepoUsuarios.AddAsync(usuarioEdicion);
            mensajeExito = "Usuario creado correctamente.";
        }
        else
        {
            await RepoUsuarios.UpdateAsync(usuarioEdicion);
            mensajeExito = "Usuario actualizado correctamente.";
        }

        if (!rolesDisponibles.Contains(usuarioEdicion.Rol))
        {
            rolesDisponibles.Add(usuarioEdicion.Rol);
            permisosPorRol[usuarioEdicion.Rol] = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            await GuardarRolesAsync();
            await GuardarPermisosAsync();
        }

        CerrarModal();
        await CargarTodo();
    }

    private async Task ToggleActivo(CatUsuario usuario)
    {
        // 1. VALIDACIÓN: Evitar auto-desactivación
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var loginActual = authState.User.Identity?.Name;

        if (!string.IsNullOrEmpty(loginActual) &&
            usuario.UsuarioLogin.Equals(loginActual, StringComparison.OrdinalIgnoreCase))
        {
            mensajeError = "⚠️ Seguridad: No puedes desactivar tu propio usuario. Si necesitas salir, cierra sesión.";
            return;
        }

        // 2. VALIDACIÓN: Evitar quedarse sin administradores
        // Si el usuario es ADMIN y lo estamos intentando desactivar (está activo)...
        if (usuario.Activo == true && RolMostrar(usuario.Rol) == "ADMIN")
        {
            // Contamos cuántos admins activos quedarían si procedemos
            var adminsActivos = usuarios.Count(u => u.Activo == true && RolMostrar(u.Rol) == "ADMIN");

            if (adminsActivos <= 1)
            {
                mensajeError = "⛔ Error Crítico: No se puede desactivar este usuario porque es el ÚNICO Administrador activo del sistema.";
                return;
            }
        }

        // Si pasa las validaciones, procedemos
        usuario.Activo = usuario.Activo != true;
        await RepoUsuarios.UpdateAsync(usuario);

        // Actualizamos mensaje de éxito según la acción realizada
        mensajeExito = usuario.Activo == true
            ? $"Usuario '{usuario.UsuarioLogin}' activado correctamente."
            : $"Usuario '{usuario.UsuarioLogin}' desactivado.";

        await CargarTodo();
    }

    // --- LÓGICA DE ROLES ---

    private async Task AgregarRol()
    {
        var rolNormalizado = nuevoRol.Trim().ToUpperInvariant();
        if (string.IsNullOrWhiteSpace(rolNormalizado)) return;

        if (!rolesDisponibles.Contains(rolNormalizado))
        {
            rolesDisponibles.Add(rolNormalizado);
            permisosPorRol[rolNormalizado] = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            await GuardarRolesAsync();
            await GuardarPermisosAsync();
            mensajeExito = "Rol agregado.";
        }
        nuevoRol = string.Empty;
    }

    private async Task EliminarRol(string rol)
    {
        if (RolEnUso(rol))
        {
            mensajeError = "No se puede eliminar un rol asignado a usuarios.";
            return;
        }

        if (await JS.InvokeAsync<bool>("confirm", $"¿Eliminar el rol '{rol}'?"))
        {
            rolesDisponibles.Remove(rol);
            permisosPorRol.Remove(rol);
            await GuardarRolesAsync();
            await GuardarPermisosAsync();
            mensajeExito = "Rol eliminado.";
        }
    }

    private async Task GuardarRolesAsync()
    {
        var valor = string.Join("|", rolesDisponibles.OrderBy(r => r));
        var parametro = (await RepoParametros.FindAsync(p => p.Clave == ParametroRoles)).FirstOrDefault();
        var usuarioActual = await ObtenerNombreUsuarioActualAsync();

        if (parametro is null)
        {
            await RepoParametros.AddAsync(new CfgSistemaParametro
            {
                Clave = ParametroRoles,
                Valor = valor,
                Descripcion = "Roles del sistema",
                UsuarioActualizacion = usuarioActual,
                FechaActualizacion = DateTime.Now
            });
        }
        else
        {
            parametro.Valor = valor;
            parametro.UsuarioActualizacion = usuarioActual;
            parametro.FechaActualizacion = DateTime.Now;
            await RepoParametros.UpdateAsync(parametro);
        }
    }

    private async Task CargarPermisosAsync()
    {
        permisosPorRol = await RolePermissionService.ObtenerMatrizAsync();

        foreach (var rol in rolesDisponibles)
        {
            if (!permisosPorRol.ContainsKey(rol))
            {
                permisosPorRol[rol] = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            }
        }
    }

    private bool TienePermiso(string rol, string permiso)
        => permisosPorRol.TryGetValue(rol, out var permisos) && permisos.Contains(permiso);

    private void TogglePermiso(string rol, string permiso, bool habilitado)
    {
        if (!permisosPorRol.TryGetValue(rol, out var permisos))
        {
            permisos = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            permisosPorRol[rol] = permisos;
        }

        if (habilitado)
        {
            permisos.Add(permiso);
        }
        else
        {
            permisos.Remove(permiso);
        }
    }

    private async Task GuardarPermisosAsync()
    {
        var parametro = (await RepoParametros.FindAsync(p => p.Clave == "SEGURIDAD_PERMISOS_POR_ROL")).FirstOrDefault();
        var usuarioActual = await ObtenerNombreUsuarioActualAsync();
        var valor = RolePermissionService.SerializarMatriz(permisosPorRol);

        if (parametro is null)
        {
            await RepoParametros.AddAsync(new CfgSistemaParametro
            {
                Clave = "SEGURIDAD_PERMISOS_POR_ROL",
                Valor = valor,
                Descripcion = "Matriz de permisos por rol",
                UsuarioActualizacion = usuarioActual,
                FechaActualizacion = DateTime.Now
            });
        }
        else
        {
            parametro.Valor = valor;
            parametro.UsuarioActualizacion = usuarioActual;
            parametro.FechaActualizacion = DateTime.Now;
            await RepoParametros.UpdateAsync(parametro);
        }

        mensajeExito = "Permisos guardados. Los cambios aplican en el próximo inicio de sesión.";
    }

    private static string EtiquetaPermiso(string permiso)
        => AppPermissions.Etiquetas.TryGetValue(permiso, out var etiqueta) ? etiqueta : permiso;

    // --- HELPERS ---

    private async Task<string> ObtenerNombreUsuarioActualAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        return authState.User.FindFirstValue(ClaimTypes.Name) ?? "sistema";
    }

    private bool RolEnUso(string rol) => usuarios.Any(u => RolMostrar(u.Rol).Equals(rol, StringComparison.OrdinalIgnoreCase));

    private static string RolMostrar(string? rol) => string.IsNullOrWhiteSpace(rol) ? "OPERADOR" : rol.Trim().ToUpperInvariant();

    private string NombreOficina(int? id) => oficinas.FirstOrDefault(o => o.IdOficina == id)?.Nombre ?? "Desconocida";

    private string ObtenerBadgeRol(string? rol) => (rol?.ToUpper()) switch
    {
        "ADMIN" => "bg-danger",
        "SUPERVISOR" => "bg-warning text-dark",
        "OPERADOR" => "bg-info text-dark",
        _ => "bg-secondary"
    };
}
