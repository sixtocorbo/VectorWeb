@page "/documentos/nuevo"
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Security.Claims
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatTipoDocumento> RepoTipos
@inject IRepository<CatEstado> RepoEstados
@inject NumeracionRangoService RangoService
@inject NavigationManager Navegador
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>
    @if (esActuacion)
    {
        <span><i class="bi bi-reply-all-fill"></i> Confeccionar Respuesta / Actuación</span>
    }
    else
    {
        <span><i class="bi bi-file-earmark-plus"></i> Ingreso de Documento - Mesa de Entrada</span>
    }
</h3>

<EditForm Model="nuevoDoc" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @if (!string.IsNullOrWhiteSpace(errorGuardar))
    {
        <div class="alert alert-danger" role="alert">@errorGuardar</div>
    }

    @if (!string.IsNullOrWhiteSpace(mensajeNumeracion))
    {
        <div class="alert alert-info" role="alert">@mensajeNumeracion</div>
    }

    @if (esActuacion)
    {
        <div class="alert alert-warning shadow-sm">
            <h5 class="alert-heading"><i class="bi bi-folder-fill"></i> Trabajando sobre el Expediente: @docPadreSeleccionado?.NumeroOficial</h5>
            <p class="mb-0">@docPadreSeleccionado?.Asunto</p>
            <hr>
            <small class="mb-0 text-muted">
                <i class="bi bi-geo-alt-fill"></i> Ubicación actual: <strong>@nombreOficinaActualDoc</strong>
            </small>
            @if (paseConActuacionForzado)
            {
                <div class="alert alert-info mt-3 mb-0 py-2">
                    El pase fue confirmado con actuación, por lo que esta actuación se guardará y se aplicará el traslado automático configurado.
                </div>
            }
            else
            {
                <div class="form-check mt-3">
                    <InputCheckbox id="soloTraerSinActuacion" class="form-check-input" @bind-Value="soloTraerSinActuacion" />
                    <label for="soloTraerSinActuacion" class="form-check-label">
                        La documentación ya está completa, solo deseo traer el expediente sin agregar esta actuación (no se guardará esta actuación ni se agregará al hilo de conversación)
                    </label>
                </div>
            }
        </div>
    }

    <div class="card mb-3">
        <div class="card-body">
            @if (!(esActuacion && soloTraerSinActuacion))
            {
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Tipo de Documento:</label>
                        <select class="form-control" value="@nuevoDoc.IdTipo" @onchange="OnTipoDocumentoChanged">
                            <option value="0">-- Seleccione Tipo --</option>
                            @foreach (var tipo in tipos)
                            {
                                <option value="@tipo.IdTipo">@tipo.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label>Año fiscal / numeración:</label>
                        <InputNumber @bind-Value="anioNumeracionSeleccionado" @bind-Value:after="OnAnioNumeracionChanged" class="form-control" min="2000" max="2100" />
                        @if (anioNumeracionSeleccionado < DateTime.Now.Year)
                        {
                            <small class="text-warning">Atención: se usará numeración histórica del año @anioNumeracionSeleccionado.</small>
                        }
                    </div>

                    <div class="col-md-4 mb-3">
                        <label>Número Oficial:</label>
                        @if (esNumeracionAutomatica)
                        {
                            <input type="text" class="form-control" value="Automático (se asigna al guardar)" disabled />
                            <small class="text-muted">Serie: <strong>@serieNumeracionAutomatica</strong> | Próximo estimado: @proximoNumeroAutomatico</small>
                        }
                        else if (esNumeracionManualInterna)
                        {
                            <InputNumber @bind-Value="numeroManualInterno" class="form-control" placeholder="Ej. 200" disabled="@bloqueoPorRangoAgotado" />
                            @if (bloqueoPorRangoAgotado)
                            {
                                <small class="text-danger">@mensajeNumeracion</small>
                            }
                            else
                            {
                                <small class="text-muted">@mensajeNumeracion</small>
                            }
                        }
                        else
                        {
                            <InputText @bind-Value="nuevoDoc.NumeroOficial" class="form-control" maxlength="50" placeholder="Ej. MEMO-2024-001" disabled="@bloqueoPorRangoAgotado" />
                            @if (bloqueoPorRangoAgotado)
                            {
                                <small class="text-danger">@mensajeNumeracion</small>
                            }
                            else if (esNumeracionExterna)
                            {
                                <small class="text-muted">Numeración manual: ingrese el número oficial y se validará su unicidad por oficina, tipo y año.</small>
                            }
                        }
                    </div>
                </div>
            }

            @if (!soloTraerSinActuacion)
            {
                <div class="mb-3">
                    <label>Contenido / Asunto del Memorando:</label>
                    <InputTextArea @bind-Value="nuevoDoc.Asunto" class="form-control" rows="4" />
                </div>
            }

            <div class="row">
                @if (!esActuacion)
                {
                    <div class="col-md-6 mb-3">
                        <label>Ubicación Inicial:</label>
                        <div class="position-relative">
                            <input type="text"
                                   class="form-control"
                                   placeholder="Escriba para buscar oficina..."
                                   value="@oficinaBusqueda"
                                   autocomplete="off"
                                   @oninput="FiltrarOficinas"
                                   @onfocus="MostrarSugerenciasOficina"
                                   @onkeydown="ManejarTecladoOficinas" />

                            @if (oficinasFiltradas.Any())
                            {
                                <div class="list-group position-absolute start-0 end-0 shadow-sm"
                                     @ref="panelSugerenciasOficinaRef"
                                     style="@EstiloPanelSugerencias">
                                    @for (var i = 0; i < oficinasFiltradas.Count; i++)
                                    {
                                        var ofi = oficinasFiltradas[i];
                                        var cssItem = i == indiceOficinaSeleccionada
                                            ? "list-group-item list-group-item-action active"
                                            : "list-group-item list-group-item-action";

                                        <button type="button"
                                                data-indice-sugerencia="@i"
                                                class="@cssItem"
                                                @onclick="() => SeleccionarOficina(ofi)">
                                            @ofi.Nombre
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <small class="text-muted">
                            Puede buscar escribiendo palabras en cualquier orden. Use ↑ ↓ y Enter para seleccionar.
                        </small>
                    </div>
                }

                @if (!(esActuacion && soloTraerSinActuacion))
                {
                    <div class="col-md-6 mb-3">
                        <label>Estado Inicial:</label>
                        <InputSelect @bind-Value="nuevoDoc.IdEstadoActual" class="form-control">
                            @foreach (var est in estados)
                            {
                                <option value="@est.IdEstado">@est.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (!esActuacion)
    {
        <div class="card mb-3 border-primary">
            <div class="card-header bg-light">
                <i class="bi bi-link-45deg"></i> Vinculación
            </div>
            <div class="card-body">
                @if (docPadreSeleccionado == null)
                {
                    <p class="mb-2 text-muted">
                        Si corresponde podés adjuntar este documento a un expediente padre existente.
                    </p>
                    <button type="button" class="btn btn-outline-primary" @onclick="AbrirModalPadres">
                        <i class="bi bi-search"></i> Buscar documento padre
                    </button>
                }
                else
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span class="me-2">
                            <strong>VINCULADO A:</strong> @docPadreSeleccionado.NumeroOficial - @docPadreSeleccionado.Asunto
                        </span>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AbrirModalPadres">
                                <i class="bi bi-search"></i> Cambiar
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" @onclick="QuitarVinculo">
                                <i class="bi bi-x-circle"></i> Quitar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="d-grid gap-2 d-md-block">
        <button type="submit" class="btn btn-success btn-lg" disabled="@bloqueoPorRangoAgotado">
            @if (esActuacion)
            {
                @if (soloTraerSinActuacion)
                {
                    <span><i class="bi bi-box-arrow-in-down"></i> Traer sin Actuación</span>
                }
                else
                {
                    <span><i class="bi bi-send-check"></i> @EtiquetaBotonPaseConActuacion</span>
                }
            }
            else
            {
                <span><i class="bi bi-save"></i> Registrar Ingreso</span>
            }
        </button>
        <a href="documentos" class="btn btn-secondary btn-lg">Cancelar</a>
    </div>

</EditForm>

@if (mostrarModalPadres)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,.45);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-diagram-3"></i> Seleccionar documento padre</h5>
                    <button type="button" class="btn-close" aria-label="Cerrar" @onclick="CerrarModalPadres"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3 align-items-end">
                        <div class="col-md-7">
                            <label class="form-label">Buscador en bandeja</label>
                            <input class="form-control"
                                   placeholder="Buscar por número, asunto, tipo, oficina o estado"
                                   @bind="FiltroModalPadre"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-md-5 text-md-end">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" checked disabled>
                                <label class="form-check-label">Ver documentos de otras oficinas</label>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Fecha creación</th>
                                <th>Nro. Oficial</th>
                                <th>Asunto</th>
                                <th>Tipo</th>
                                <th>Ubicación actual</th>
                                <th>Estado</th>
                                <th class="text-end">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!DocumentosPadrePaginados.Any())
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-3">No se encontraron documentos.</td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var doc in DocumentosPadrePaginados)
                                {
                                    <tr>
                                        <td>@doc.FechaCreacion?.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>@(string.IsNullOrWhiteSpace(doc.NumeroOficial) ? "S/N" : doc.NumeroOficial)</td>
                                        <td>@doc.Asunto</td>
                                        <td>@NombreTipo(doc.IdTipo)</td>
                                        <td>@NombreOficina(doc.IdOficinaActual)</td>
                                        <td>@NombreEstado(doc.IdEstadoActual)</td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-primary" @onclick="() => SeleccionarPadreDesdeModal(doc)">
                                                Seleccionar
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Mostrando @DesdeRegistroPadre a @HastaRegistroPadre de @TotalRegistrosPadre documento(s)</small>
                        <div class="btn-group" role="group" aria-label="Paginación padres">
                            <button type="button" class="btn btn-outline-secondary" @onclick="PaginaPadreAnterior" disabled="@(PaginaPadreEfectiva == 1)">Anterior</button>
                            <button type="button" class="btn btn-outline-secondary disabled">Página @PaginaPadreEfectiva de @TotalPaginasPadre</button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="PaginaPadreSiguiente" disabled="@(PaginaPadreEfectiva >= TotalPaginasPadre)">Siguiente</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalPadres">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }

    [SupplyParameterFromQuery]
    public int? IdPadre { get; set; }

    [SupplyParameterFromQuery]
    public bool? AutoPaseBandeja { get; set; }

    [SupplyParameterFromQuery]
    public int? AutoPaseDestino { get; set; }

    private bool esActuacion = false;
    private MaeDocumento nuevoDoc = new MaeDocumento
    {
        FechaCreacion = DateTime.Now,
        AnioDocumento = DateTime.Now.Year,
        Asunto = string.Empty
    };
    private string? errorGuardar;

    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatTipoDocumento> tipos = new List<CatTipoDocumento>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();

    private string filtroModalPadre = string.Empty;
    private List<MaeDocumento> documentosPadreFiltrados = new();
    private readonly Dictionary<int, string> nombresOficinas = new();
    private readonly Dictionary<int, string> nombresTipos = new();
    private readonly Dictionary<int, string> nombresEstados = new();
    private readonly Dictionary<long, string> indicesBusquedaPadre = new();
    private List<MaeDocumento> documentosDisponibles = new();
    private bool mostrarModalPadres;
    private int paginaPadreActual = 1;
    private int tamanoPaginaPadre = 10;
    private MaeDocumento? docPadreSeleccionado;
    private int? idOficinaBandejaEntrada;
    private int idOficinaUsuarioActual;
    private string nombreOficinaActualDoc = string.Empty;
    private bool soloTraerSinActuacion;
    private bool paseConActuacionForzado => AutoPaseBandeja == true || AutoPaseDestino.HasValue;
    private string EtiquetaBotonPaseConActuacion => AutoPaseDestino.HasValue
        ? "Guardar Actuación y Enviar todo"
        : "Guardar Actuación y Traer todo";
    private string oficinaBusqueda = string.Empty;
    private List<CatOficina> oficinasFiltradas = new();
    private int indiceOficinaSeleccionada = -1;
    private bool mostrarSugerenciasArriba = true;
    private bool esNumeracionAutomatica;
    private bool esNumeracionExterna;
    private bool esNumeracionManualInterna;
    private bool bloqueoPorRangoAgotado;
    private string mensajeNumeracion = string.Empty;
    private string serieNumeracionAutomatica = string.Empty;
    private int proximoNumeroAutomatico;
    private int anioNumeracionSeleccionado = DateTime.Now.Year;
    private MaeNumeracionRango? rangoManualInternoActivo;
    private int? numeroManualInterno;
    private ElementReference panelSugerenciasOficinaRef;
    private string EstiloPanelSugerencias => mostrarSugerenciasArriba
        ? "z-index: 20; bottom: calc(100% + .25rem);"
        : "z-index: 20; top: calc(100% + .25rem);";

    protected override async Task OnInitializedAsync()
    {
        oficinas = await RepoOficinas.GetAllAsync();
        tipos = await RepoTipos.GetAllAsync();
        estados = await RepoEstados.GetAllAsync();

        nombresOficinas.Clear();
        foreach (var oficina in oficinas)
        {
            if (!string.IsNullOrWhiteSpace(oficina.Nombre))
            {
                nombresOficinas[oficina.IdOficina] = oficina.Nombre;
            }
        }

        nombresTipos.Clear();
        foreach (var tipo in tipos)
        {
            if (!string.IsNullOrWhiteSpace(tipo.Nombre))
            {
                nombresTipos[tipo.IdTipo] = tipo.Nombre;
            }
        }

        nombresEstados.Clear();
        foreach (var estado in estados)
        {
            if (!string.IsNullOrWhiteSpace(estado.Nombre))
            {
                nombresEstados[estado.IdEstado] = estado.Nombre;
            }
        }

        documentosDisponibles = (await RepoDocs.GetAllAsync())
            .OrderByDescending(d => d.FechaCreacion ?? DateTime.MinValue)
            .ToList();

        indicesBusquedaPadre.Clear();
        foreach (var documento in documentosDisponibles)
        {
            indicesBusquedaPadre[documento.IdDocumento] = ConstruirIndiceBusquedaPadre(documento);
        }

        RecalcularDocumentosPadreFiltrados();

        var estadoInicial = estados.FirstOrDefault();
        if (estadoInicial != null)
        {
            nuevoDoc.IdEstadoActual = estadoInicial.IdEstado;
        }

        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
        idOficinaBandejaEntrada = oficinas
            .FirstOrDefault(o => string.Equals(o.Nombre, "BANDEJA DE ENTRADA", StringComparison.OrdinalIgnoreCase))
            ?.IdOficina;

        var authState = await (AuthStateTask ?? Task.FromResult(new AuthenticationState(new ClaimsPrincipal(new ClaimsIdentity()))));
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var uid))
            {
                nuevoDoc.IdUsuarioCreador = uid;
            }

            var oficinaClaim = user.FindFirst(c => c.Type == "IdOficina");
            if (oficinaClaim != null && int.TryParse(oficinaClaim.Value, out var oid))
            {
                idOficinaUsuarioActual = oid;
                nuevoDoc.IdOficinaActual = oid;
            }
        }

        oficinaBusqueda = oficinas.FirstOrDefault(o => o.IdOficina == nuevoDoc.IdOficinaActual)?.Nombre ?? string.Empty;

        if (IdPadre.HasValue)
        {
            var docPadres = await RepoDocs.GetAllAsync();
            var padre = docPadres.FirstOrDefault(d => d.IdDocumento == IdPadre.Value);

            if (padre != null)
            {
                esActuacion = true;
                docPadreSeleccionado = padre;

                nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
                nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
                nuevoDoc.IdOficinaActual = padre.IdOficinaActual;

                nombreOficinaActualDoc = oficinas.FirstOrDefault(o => o.IdOficina == padre.IdOficinaActual)?.Nombre ?? "Oficina Remota";

                var tipoMemo = tipos.FirstOrDefault(t =>
                    t.Nombre.Contains("Memorando", StringComparison.OrdinalIgnoreCase) ||
                    t.Nombre.Contains("Actuación", StringComparison.OrdinalIgnoreCase));

                if (tipoMemo != null)
                {
                    nuevoDoc.IdTipo = tipoMemo.IdTipo;
                }

                if (paseConActuacionForzado)
                {
                    soloTraerSinActuacion = false;
                }
            }
        }

        if (nuevoDoc.AnioDocumento.HasValue && nuevoDoc.AnioDocumento.Value > 0)
        {
            anioNumeracionSeleccionado = nuevoDoc.AnioDocumento.Value;
        }

        if (nuevoDoc.IdTipo > 0)
        {
            await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
        }
    }

    private IEnumerable<MaeDocumento> DocumentosPadreFiltrados => documentosPadreFiltrados;

    private IEnumerable<MaeDocumento> DocumentosPadrePaginados
        => DocumentosPadreFiltrados
            .Skip((PaginaPadreEfectiva - 1) * tamanoPaginaPadre)
            .Take(tamanoPaginaPadre);

    private int TotalRegistrosPadre => documentosPadreFiltrados.Count;
    private int TotalPaginasPadre => Math.Max(1, (int)Math.Ceiling(TotalRegistrosPadre / (double)tamanoPaginaPadre));
    private int PaginaPadreEfectiva => Math.Min(paginaPadreActual, TotalPaginasPadre);
    private int DesdeRegistroPadre => TotalRegistrosPadre == 0 ? 0 : ((PaginaPadreEfectiva - 1) * tamanoPaginaPadre) + 1;
    private int HastaRegistroPadre => Math.Min(PaginaPadreEfectiva * tamanoPaginaPadre, TotalRegistrosPadre);

    private void AbrirModalPadres()
    {
        mostrarModalPadres = true;
    }

    private void CerrarModalPadres()
    {
        mostrarModalPadres = false;
    }

    private string FiltroModalPadre
    {
        get => filtroModalPadre;
        set
        {
            if (filtroModalPadre == value)
            {
                return;
            }

            filtroModalPadre = value;
            paginaPadreActual = 1;
            RecalcularDocumentosPadreFiltrados();
        }
    }

    private void PaginaPadreAnterior()
    {
        if (PaginaPadreEfectiva > 1)
        {
            paginaPadreActual = PaginaPadreEfectiva - 1;
        }
    }

    private void PaginaPadreSiguiente()
    {
        if (PaginaPadreEfectiva < TotalPaginasPadre)
        {
            paginaPadreActual = PaginaPadreEfectiva + 1;
        }
    }

    private void SeleccionarPadreDesdeModal(MaeDocumento padre)
    {
        SeleccionarPadre(padre);
        mostrarModalPadres = false;
    }

    private void SeleccionarPadre(MaeDocumento padre)
    {
        docPadreSeleccionado = padre;
        nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
        nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
        FiltroModalPadre = string.Empty;
    }

    private void QuitarVinculo()
    {
        docPadreSeleccionado = null;
        nuevoDoc.IdDocumentoPadre = null;
        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
    }

    private async Task Guardar()
    {
        errorGuardar = null;

        if (paseConActuacionForzado)
        {
            soloTraerSinActuacion = false;
        }

        if (esActuacion && soloTraerSinActuacion && docPadreSeleccionado != null)
        {
            if (!idOficinaBandejaEntrada.HasValue)
            {
                errorGuardar = "No se encontró la oficina BANDEJA DE ENTRADA para realizar el traslado.";
                return;
            }

            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                idOficinaBandejaEntrada.Value,
                "Traslado de familia sin actuación hacia BANDEJA DE ENTRADA");

            Navegador.NavigateTo("documentos");
            return;
        }

        nuevoDoc.Asunto = nuevoDoc.Asunto?.Trim() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(nuevoDoc.Asunto))
        {
            errorGuardar = "Debe ingresar el contenido/asunto del documento.";
            return;
        }

        if (nuevoDoc.Asunto.Length > 200)
        {
            errorGuardar = "El contenido/asunto no puede superar los 200 caracteres.";
            return;
        }

        if (!tipos.Any(t => t.IdTipo == nuevoDoc.IdTipo))
        {
            errorGuardar = "Tipo de documento inválido.";
            return;
        }

        if (!estados.Any(e => e.IdEstado == nuevoDoc.IdEstadoActual))
        {
            errorGuardar = "Estado inválido.";
            return;
        }

        if (!oficinas.Any(o => o.IdOficina == nuevoDoc.IdOficinaActual))
        {
            errorGuardar = "Debe seleccionar una oficina válida.";
            return;
        }

        if (bloqueoPorRangoAgotado)
        {
            errorGuardar = $"No puede continuar: {mensajeNumeracion}";
            return;
        }

        nuevoDoc.AnioDocumento = anioNumeracionSeleccionado;

        if (esNumeracionAutomatica)
        {
            var resultadoNumeracion = await RangoService.ConsumirSiguienteNumeroAsync(nuevoDoc.IdTipo, nuevoDoc.IdOficinaActual, anioNumeracionSeleccionado);
            if (!resultadoNumeracion.Exitoso || resultadoNumeracion.Data is null)
            {
                errorGuardar = resultadoNumeracion.Mensaje;
                return;
            }

            var rangoConsumido = resultadoNumeracion.Data;
            nuevoDoc.NumeroOficial = rangoConsumido.UltimoUtilizado.ToString();
        }
        else if (esNumeracionManualInterna)
        {
            if (!numeroManualInterno.HasValue)
            {
                errorGuardar = "Debe ingresar el número oficial para la oficina interna.";
                return;
            }

            if (numeroManualInterno <= 0)
            {
                errorGuardar = "El número oficial debe ser mayor que cero.";
                return;
            }

            var rango = rangoManualInternoActivo
                ?? await RangoService.ObtenerRangoActivoAsync(nuevoDoc.IdTipo, nuevoDoc.IdOficinaActual, anioNumeracionSeleccionado);

            if (rango is null)
            {
                errorGuardar = "No hay un rango activo configurado para validar el número ingresado.";
                return;
            }

            if (numeroManualInterno < rango.NumeroInicio || numeroManualInterno > rango.NumeroFin)
            {
                errorGuardar = $"El número ingresado está fuera del rango permitido ({rango.NumeroInicio}-{rango.NumeroFin}).";
                return;
            }

            nuevoDoc.NumeroOficial = numeroManualInterno.Value.ToString();
        }
        else
        {
            nuevoDoc.NumeroOficial = nuevoDoc.NumeroOficial?.Trim();

            if (string.IsNullOrWhiteSpace(nuevoDoc.NumeroOficial))
            {
                errorGuardar = "Debe ingresar el número oficial para numeración manual.";
                return;
            }

            if (nuevoDoc.NumeroOficial.Length > 50)
            {
                errorGuardar = "El número oficial no puede superar los 50 caracteres.";
                return;
            }

        }

        var documentosExistentes = await RepoDocs.GetAllAsync();
        var existeDuplicado = documentosExistentes.Any(d =>
            d.IdTipo == nuevoDoc.IdTipo &&
            d.IdOficinaActual == nuevoDoc.IdOficinaActual &&
            d.FechaCreacion.HasValue &&
            (d.AnioDocumento ?? d.FechaCreacion.Value.Year) == anioNumeracionSeleccionado &&
            string.Equals(d.NumeroOficial, nuevoDoc.NumeroOficial, StringComparison.OrdinalIgnoreCase));

        if (existeDuplicado)
        {
            errorGuardar = "Ya existe un documento con ese número oficial para la misma oficina, tipo y año.";
            return;
        }

        await RepoDocs.AddAsync(nuevoDoc);

        var obsCreacion = esActuacion
            ? $"Confección de Memorando/Actuación (Ref: {docPadreSeleccionado?.NumeroOficial})"
            : "Se crea el documento";

        var movCreacion = new TraMovimiento
        {
            IdDocumento = nuevoDoc.IdDocumento,
            IdOficinaOrigen = nuevoDoc.IdOficinaActual,
            IdOficinaDestino = nuevoDoc.IdOficinaActual,
            FechaMovimiento = DateTime.Now,
            IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
            ObservacionPase = obsCreacion
        };
        await RepoMovimientos.AddAsync(movCreacion);

        if (AutoPaseBandeja == true && esActuacion && docPadreSeleccionado != null)
        {
            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                idOficinaUsuarioActual,
                $"Retorno de Expediente por agregación de actuación (Ref: {nuevoDoc.NumeroOficial ?? "S/N"})");
        }
        else if (AutoPaseDestino.HasValue && esActuacion && docPadreSeleccionado != null)
        {
            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                AutoPaseDestino.Value,
                $"Pase de Expediente por agregación de actuación (Ref: {nuevoDoc.NumeroOficial ?? "S/N"})");
        }
        else if (idOficinaUsuarioActual > 0 && nuevoDoc.IdOficinaActual != idOficinaUsuarioActual)
        {
            var oficinaOrigen = nuevoDoc.IdOficinaActual;
            var oficinaDestino = idOficinaBandejaEntrada ?? nuevoDoc.IdOficinaActual;
            var nombreOficinaOrigen = oficinas.FirstOrDefault(o => o.IdOficina == oficinaOrigen)?.Nombre ?? $"Oficina {oficinaOrigen}";

            var movPase = new TraMovimiento
            {
                IdDocumento = nuevoDoc.IdDocumento,
                IdOficinaOrigen = oficinaOrigen,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now.AddSeconds(1),
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = $"BANDEJA DE ENTRADA recibe el documento desde {nombreOficinaOrigen}"
            };

            await RepoMovimientos.AddAsync(movPase);

            nuevoDoc.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(nuevoDoc);
        }

        Navegador.NavigateTo("documentos");
    }

    private async Task MoverFamiliaADestino(Guid hiloConversacion, int oficinaDestino, string observacion)
    {
        var documentosFamilia = (await RepoDocs.GetAllAsync())
            .Where(d => d.IdHiloConversacion == hiloConversacion)
            .ToList();

        foreach (var documento in documentosFamilia)
        {
            if (documento.IdOficinaActual == oficinaDestino)
            {
                continue;
            }

            var movimiento = new TraMovimiento
            {
                IdDocumento = documento.IdDocumento,
                IdOficinaOrigen = documento.IdOficinaActual,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now.AddSeconds(1),
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = observacion
            };

            await RepoMovimientos.AddAsync(movimiento);

            documento.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(documento);
        }
    }

    private async Task OnTipoDocumentoChanged(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        if (!int.TryParse(valor, out var idTipoSeleccionado))
        {
            idTipoSeleccionado = 0;
        }

        nuevoDoc.IdTipo = idTipoSeleccionado;
        await EvaluarNumeracionAutomaticaAsync(idTipoSeleccionado);
    }

    private async Task EvaluarNumeracionAutomaticaAsync(int idTipoDocumento)
    {
        esNumeracionAutomatica = false;
        esNumeracionExterna = false;
        esNumeracionManualInterna = false;
        bloqueoPorRangoAgotado = false;
        mensajeNumeracion = string.Empty;
        serieNumeracionAutomatica = string.Empty;
        proximoNumeroAutomatico = 0;
        rangoManualInternoActivo = null;
        numeroManualInterno = null;
        nuevoDoc.NumeroOficial = string.Empty;

        if (idTipoDocumento <= 0)
        {
            return;
        }

        var oficinaSeleccionada = oficinas.FirstOrDefault(o => o.IdOficina == nuevoDoc.IdOficinaActual);
        var esBandejaEntrada = idOficinaBandejaEntrada.HasValue && nuevoDoc.IdOficinaActual == idOficinaBandejaEntrada.Value;
        if (oficinaSeleccionada?.EsExterna == true)
        {
            esNumeracionExterna = true;
            mensajeNumeracion = "Oficina externa: ingrese manualmente el número oficial con validación de unicidad por oficina, tipo y año.";
            return;
        }

        var rango = await RangoService.ObtenerRangoActivoAsync(idTipoDocumento, nuevoDoc.IdOficinaActual, anioNumeracionSeleccionado);

        if (rango is not null && esBandejaEntrada)
        {
            esNumeracionAutomatica = true;
            serieNumeracionAutomatica = rango.NombreRango;
            proximoNumeroAutomatico = rango.UltimoUtilizado + 1;
            mensajeNumeracion = "Modo administrado por rango: el número se asignará automáticamente al guardar.";
            return;
        }

        if (rango is not null)
        {
            esNumeracionManualInterna = true;
            rangoManualInternoActivo = rango;
            mensajeNumeracion = $"Numeración manual controlada: ingrese solo números. Rango activo habilitado: {rango.NumeroInicio} a {rango.NumeroFin}.";
            return;
        }

        var existeRangoConfigurado = await RangoService.ExisteRangoConfiguradoAsync(idTipoDocumento, nuevoDoc.IdOficinaActual, anioNumeracionSeleccionado);
        bloqueoPorRangoAgotado = true;
        mensajeNumeracion = existeRangoConfigurado
            ? "Rango agotado para esta oficina/tipo. Debe registrar un nuevo rango para continuar."
            : "Oficina interna: debe configurar un rango de numeración para esta oficina/tipo antes de crear el documento.";
    }

    private async Task OnAnioNumeracionChanged()
    {
        if (nuevoDoc.IdTipo > 0)
        {
            await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
        }
    }

    private async Task FiltrarOficinas(ChangeEventArgs e)
    {
        oficinaBusqueda = e.Value?.ToString() ?? string.Empty;
        nuevoDoc.IdOficinaActual = 0;
        indiceOficinaSeleccionada = -1;

        if (string.IsNullOrWhiteSpace(oficinaBusqueda))
        {
            oficinasFiltradas.Clear();
            return;
        }

        oficinasFiltradas = BuscarOficinas(oficinaBusqueda)
            .Take(8)
            .ToList();

        var coincidenciaExacta = oficinas.FirstOrDefault(o =>
            string.Equals(o.Nombre, oficinaBusqueda, StringComparison.OrdinalIgnoreCase));

        if (coincidenciaExacta != null)
        {
            nuevoDoc.IdOficinaActual = coincidenciaExacta.IdOficina;

            if (nuevoDoc.IdTipo > 0)
            {
                await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
            }
        }
    }

    private async Task SeleccionarOficina(CatOficina oficina)
    {
        nuevoDoc.IdOficinaActual = oficina.IdOficina;
        oficinaBusqueda = oficina.Nombre ?? string.Empty;
        oficinasFiltradas.Clear();
        indiceOficinaSeleccionada = -1;
        if (nuevoDoc.IdTipo > 0)
        {
            await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
        }
    }

    private void MostrarSugerenciasOficina()
    {
        if (!string.IsNullOrWhiteSpace(oficinaBusqueda))
        {
            oficinasFiltradas = BuscarOficinas(oficinaBusqueda)
                .Take(8)
                .ToList();
        }
    }

    private async Task ManejarTecladoOficinas(KeyboardEventArgs e)
    {
        if (!oficinasFiltradas.Any())
        {
            return;
        }

        if (e.Key == "ArrowDown")
        {
            indiceOficinaSeleccionada = Math.Min(indiceOficinaSeleccionada + 1, oficinasFiltradas.Count - 1);
            await AjustarScrollSugerenciaAsync(panelSugerenciasOficinaRef, indiceOficinaSeleccionada);
            return;
        }

        if (e.Key == "ArrowUp")
        {
            indiceOficinaSeleccionada = Math.Max(indiceOficinaSeleccionada - 1, 0);
            await AjustarScrollSugerenciaAsync(panelSugerenciasOficinaRef, indiceOficinaSeleccionada);
            return;
        }

        if (e.Key == "Enter" && indiceOficinaSeleccionada >= 0)
        {
            _ = SeleccionarOficina(oficinasFiltradas[indiceOficinaSeleccionada]);
            return;
        }

        if (e.Key == "Escape")
        {
            oficinasFiltradas.Clear();
            indiceOficinaSeleccionada = -1;
        }
    }

    private IEnumerable<CatOficina> BuscarOficinas(string terminoBusqueda)
    {
        var palabras = terminoBusqueda
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        if (palabras.Length == 0)
        {
            return Enumerable.Empty<CatOficina>();
        }

        return oficinas
            .Where(o => palabras.All(palabra =>
                (o.Nombre?.Contains(palabra, StringComparison.OrdinalIgnoreCase) ?? false)))
            .OrderBy(o => o.Nombre);
    }

    private string ConstruirIndiceBusquedaPadre(MaeDocumento doc)
        => string.Join(' ',
            doc.NumeroOficial,
            doc.Asunto,
            NombreTipo(doc.IdTipo),
            NombreOficina(doc.IdOficinaActual),
            NombreEstado(doc.IdEstadoActual),
            doc.FechaCreacion?.ToString("dd/MM/yyyy"));

    private void RecalcularDocumentosPadreFiltrados()
    {
        var terminos = filtroModalPadre
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        if (terminos.Length == 0)
        {
            documentosPadreFiltrados = documentosDisponibles;
            return;
        }

        documentosPadreFiltrados = documentosDisponibles
            .Where(d => indicesBusquedaPadre.TryGetValue(d.IdDocumento, out var indice)
                && terminos.All(termino => indice.Contains(termino, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    private string NombreOficina(int idOficina)
        => nombresOficinas.GetValueOrDefault(idOficina) ?? $"Oficina {idOficina}";

    private string NombreTipo(int idTipo)
        => nombresTipos.GetValueOrDefault(idTipo) ?? $"Tipo {idTipo}";

    private string NombreEstado(int idEstado)
        => nombresEstados.GetValueOrDefault(idEstado) ?? $"Estado {idEstado}";

    private async Task AjustarScrollSugerenciaAsync(ElementReference panelRef, int indiceSugerencia)
    {
        if (indiceSugerencia < 0)
        {
            return;
        }

        await JS.InvokeVoidAsync("scrollSugerenciaVisible", panelRef, indiceSugerencia);
    }
}
