@page "/documentos/nuevo"
@using VectorWeb.Models
@using VectorWeb.Repositories
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatTipoDocumento> RepoTipos
@inject IRepository<CatEstado> RepoEstados
@inject NavigationManager Navegador
@rendermode InteractiveServer

<h3>Ingreso de Documento - Mesa de Entrada</h3>

<EditForm Model="nuevoDoc" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="card mb-3 border-primary">
        <div class="card-header bg-light">
            <i class="bi bi-link-45deg"></i> Vinculación (Opcional)
        </div>
        <div class="card-body">
            @if (docPadreSeleccionado == null)
            {
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Buscar documento padre por Asunto o Nro..." 
                           @bind="busquedaPadre" />
                    <button type="button" class="btn btn-outline-primary" @onclick="BuscarPadre">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>

                @if (resultadosBusqueda != null && resultadosBusqueda.Any())
                {
                    <table class="table table-sm mt-2 table-hover">
                        <thead>
                            <tr>
                                <th>Nro</th>
                                <th>Asunto</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in resultadosBusqueda)
                            {
                                <tr>
                                    <td>@d.NumeroOficial</td>
                                    <td>@d.Asunto</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" @onclick="() => SeleccionarPadre(d)">
                                            Vincular
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            }
            else
            {
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <span>
                        <strong>VINCULADO A:</strong> @docPadreSeleccionado.NumeroOficial - @docPadreSeleccionado.Asunto
                    </span>
                    <button type="button" class="btn btn-sm btn-danger" @onclick="QuitarVinculo">
                        <i class="bi bi-x-circle"></i> Quitar
                    </button>
                </div>
            }
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Tipo de Documento:</label>
                    <InputSelect @bind-Value="nuevoDoc.IdTipo" class="form-control">
                        <option value="0">-- Seleccione Tipo --</option>
                        @foreach (var tipo in tipos)
                        {
                            <option value="@tipo.IdTipo">@tipo.Nombre</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-md-6 mb-3">
                    <label>Número Oficial:</label>
                    <InputText @bind-Value="nuevoDoc.NumeroOficial" class="form-control" />
                </div>
            </div>

            <div class="mb-3">
                <label>Asunto:</label>
                <InputTextArea @bind-Value="nuevoDoc.Asunto" class="form-control" rows="2" />
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Ubicación Inicial (Bandeja):</label>

                    <InputSelect @bind-Value="nuevoDoc.IdOficinaActual" class="form-control" disabled="@esActuacion">
                        @foreach (var ofi in oficinas)
                        {
                            <option value="@ofi.IdOficina">@ofi.Nombre</option>
                        }
                    </InputSelect>

                    @if (esActuacion)
                    {
                        <small class="text-danger">
                            <i class="bi bi-lock-fill"></i> Fijado a la ubicación del expediente original.
                        </small>
                    }
                </div>

                <div class="col-md-6 mb-3">
                    <label>Estado Inicial:</label>
                    <InputSelect @bind-Value="nuevoDoc.IdEstadoActual" class="form-control">
                        @foreach (var est in estados)
                        {
                            <option value="@est.IdEstado">@est.Nombre</option>
                        }
                    </InputSelect>
                </div>
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-success btn-lg">
        <i class="bi bi-save"></i> Registrar Ingreso
    </button>
    <a href="documentos" class="btn btn-secondary btn-lg">Cancelar</a>
</EditForm>

@code {
    // Recibimos al usuario autenticado (TÚ)
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; }

    [SupplyParameterFromQuery]
    public int? IdPadre { get; set; }

    [SupplyParameterFromQuery]
    public bool? AutoPaseBandeja { get; set; }

    private bool esActuacion = false;
    private MaeDocumento nuevoDoc = new MaeDocumento { FechaCreacion = DateTime.Now };
    
    // Listas
    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatTipoDocumento> tipos = new List<CatTipoDocumento>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();

    // Vinculación
    private string busquedaPadre = "";
    private List<MaeDocumento> resultadosBusqueda;
    private MaeDocumento docPadreSeleccionado;
    private int? idOficinaBandejaEntrada;

    protected override async Task OnInitializedAsync()
    {
        oficinas = await RepoOficinas.GetAllAsync();
        tipos = await RepoTipos.GetAllAsync();
        estados = await RepoEstados.GetAllAsync();

        idOficinaBandejaEntrada = oficinas
            .FirstOrDefault(o => string.Equals(o.Nombre, "BANDEJA DE ENTRADA", StringComparison.OrdinalIgnoreCase))
            ?.IdOficina;
        
        nuevoDoc.IdHiloConversacion = Guid.NewGuid();

        // /// LEER AQUÍ: LÓGICA DE SEGURIDAD ///
        var authState = await AuthStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            // 1. AUDITORÍA (OBLIGATORIA):
            // Recuperamos TU ID. Esto asegura que aunque mandes el doc a China,
            // la base de datos sepa que fuiste TÚ quien lo creó.
            var userIdClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int uid))
            {
                nuevoDoc.IdUsuarioCreador = uid;
            }

            // 2. UBICACIÓN (SUGERIDA):
            // Pre-seleccionamos tu oficina para ahorrar tiempo, pero como el Combo
            // de arriba está habilitado, puedes cambiarlo si el doc no es para ti.
            var oficinaClaim = user.FindFirst(c => c.Type == "IdOficina");
            if (oficinaClaim != null && int.TryParse(oficinaClaim.Value, out int oid))
            {
                nuevoDoc.IdOficinaActual = oid;
            }
        }

        if (IdPadre.HasValue)
        {
            var docPadre = await RepoDocs.GetAllAsync();
            var padre = docPadre.FirstOrDefault(d => d.IdDocumento == IdPadre.Value);

            if (padre != null)
            {
                esActuacion = true;
                docPadreSeleccionado = padre;
                nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
                nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
                nuevoDoc.IdOficinaActual = padre.IdOficinaActual;
                nuevoDoc.IdEstadoActual = padre.IdEstadoActual;
                nuevoDoc.Asunto = $"Ref: {padre.NumeroOficial} - ";

            }
        }
    }

    private async Task BuscarPadre()
    {
        if (!string.IsNullOrWhiteSpace(busquedaPadre))
        {
            // Nota: En producción optimizaremos esto con un FindAsync específico
            var todos = await RepoDocs.GetAllAsync();
            resultadosBusqueda = todos
                .Where(d => d.Asunto.Contains(busquedaPadre, StringComparison.OrdinalIgnoreCase) || 
                            d.NumeroOficial.Contains(busquedaPadre))
                .Take(5)
                .ToList();
        }
    }

    private void SeleccionarPadre(MaeDocumento padre)
    {
        docPadreSeleccionado = padre;
        nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
        nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion; 
        resultadosBusqueda = null;
        busquedaPadre = "";
    }

    private void QuitarVinculo()
    {
        docPadreSeleccionado = null;
        nuevoDoc.IdDocumentoPadre = null;
        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
    }

    private async Task Guardar()
    {
        // 1. Guardar en MAE_DOCUMENTO
        // Se guarda: Creador = TÚ, Oficina = LA QUE ELEGISTE
        await RepoDocs.AddAsync(nuevoDoc);

        // 2. Crear TRA_MOVIMIENTO (Historial)
        var mov = new TraMovimiento
        {
            IdDocumento = nuevoDoc.IdDocumento,
            
            // Decimos que el movimiento ocurre EN la oficina destino directamente
            // (Ya que es un ingreso inicial)
            IdOficinaOrigen = nuevoDoc.IdOficinaActual, 
            IdOficinaDestino = nuevoDoc.IdOficinaActual, 
            
            FechaMovimiento = DateTime.Now,
            
            // /// LEER AQUÍ: RESPONSABILIDAD ///
            // Aquí queda tu firma. En el historial dirá:
            // "Ingresado en [Oficina Elegida] por [Tu Nombre]"
            IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
            
            ObservacionPase = "Ingreso inicial al sistema"
        };
        
        await RepoMovimientos.AddAsync(mov);

        if (AutoPaseBandeja == true && IdPadre.HasValue && docPadreSeleccionado != null)
        {
            var oficinaOrigen = nuevoDoc.IdOficinaActual;
            var oficinaDestino = idOficinaBandejaEntrada ?? nuevoDoc.IdOficinaActual;
            var nombreOficinaOrigen = oficinas.FirstOrDefault(o => o.IdOficina == oficinaOrigen)?.Nombre ?? $"Oficina {oficinaOrigen}";

            var movPase = new TraMovimiento
            {
                IdDocumento = nuevoDoc.IdDocumento,
                IdOficinaOrigen = oficinaOrigen,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now,
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = $"Pase automático desde {nombreOficinaOrigen} hacia BANDEJA DE ENTRADA"
            };

            await RepoMovimientos.AddAsync(movPase);

            nuevoDoc.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(nuevoDoc);
        }

        Navegador.NavigateTo("documentos");
    }
}
