@page "/documentos/nuevo"
@using VectorWeb.Models
@using VectorWeb.Repositories
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatTipoDocumento> RepoTipos
@inject IRepository<CatEstado> RepoEstados
@inject NavigationManager Navegador
@rendermode InteractiveServer

<h3>
    @if (esActuacion)
    {
        <span><i class="bi bi-reply-all-fill"></i> Confeccionar Respuesta / Actuación</span>
    }
    else
    {
        <span><i class="bi bi-file-earmark-plus"></i> Ingreso de Documento - Mesa de Entrada</span>
    }
</h3>

<EditForm Model="nuevoDoc" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @if (!string.IsNullOrWhiteSpace(errorGuardar))
    {
        <div class="alert alert-danger" role="alert">@errorGuardar</div>
    }

    @if (!esActuacion)
    {
        <div class="card mb-3 border-primary">
            <div class="card-header bg-light">
                <i class="bi bi-link-45deg"></i> Vinculación (Opcional)
            </div>
            <div class="card-body">
                @if (docPadreSeleccionado == null)
                {
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar documento padre por Asunto o Nro..."
                               @bind="busquedaPadre" />
                        <button type="button" class="btn btn-outline-primary" @onclick="BuscarPadre">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>

                    @if (resultadosBusqueda != null && resultadosBusqueda.Any())
                    {
                        <table class="table table-sm mt-2 table-hover">
                            <thead>
                                <tr>
                                    <th>Nro</th>
                                    <th>Asunto</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var d in resultadosBusqueda)
                                {
                                    <tr>
                                        <td>@d.NumeroOficial</td>
                                        <td>@d.Asunto</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary" @onclick="() => SeleccionarPadre(d)">
                                                Vincular
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                }
                else
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>
                            <strong>VINCULADO A:</strong> @docPadreSeleccionado.NumeroOficial - @docPadreSeleccionado.Asunto
                        </span>
                        <button type="button" class="btn btn-sm btn-danger" @onclick="QuitarVinculo">
                            <i class="bi bi-x-circle"></i> Quitar
                        </button>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning shadow-sm">
            <h5 class="alert-heading"><i class="bi bi-folder-fill"></i> Trabajando sobre el Expediente: @docPadreSeleccionado?.NumeroOficial</h5>
            <p class="mb-0">@docPadreSeleccionado?.Asunto</p>
            <hr>
            <small class="mb-0 text-muted">
                <i class="bi bi-geo-alt-fill"></i> Ubicación actual: <strong>@nombreOficinaActualDoc</strong>
            </small>
            <div class="form-check mt-3">
                <InputCheckbox id="soloTraerSinActuacion" class="form-check-input" @bind-Value="soloTraerSinActuacion" />
                <label for="soloTraerSinActuacion" class="form-check-label">
                    La documentación ya está completa, solo deseo traer el expediente sin agregar esta actuación (no se guardará esta actuación ni se agregará al hilo de conversación)
                </label>
            </div>
        </div>
    }

    <div class="card mb-3">
        <div class="card-body">
            @if (!(esActuacion && soloTraerSinActuacion))
            {
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Tipo de Documento:</label>
                        <InputSelect @bind-Value="nuevoDoc.IdTipo" class="form-control">
                            <option value="0">-- Seleccione Tipo --</option>
                            @foreach (var tipo in tipos)
                            {
                                <option value="@tipo.IdTipo">@tipo.Nombre</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Número Oficial (Opcional):</label>
                        <InputText @bind-Value="nuevoDoc.NumeroOficial" class="form-control" placeholder="Ej. MEMO-2024-001" />
                    </div>
                </div>
            }

            @if (!soloTraerSinActuacion)
            {
                <div class="mb-3">
                    <label>Contenido / Asunto del Memorando:</label>
                    <InputTextArea @bind-Value="nuevoDoc.Asunto" class="form-control" rows="4" />
                </div>
            }

            <div class="row">
                @if (!esActuacion)
                {
                    <div class="col-md-6 mb-3">
                        <label>Ubicación Inicial:</label>
                        <input type="text"
                               class="form-control"
                               placeholder="Escriba para buscar oficina..."
                               value="@oficinaBusqueda"
                               @oninput="FiltrarOficinas" />

                        @if (oficinasFiltradas.Any())
                        {
                            <div class="list-group mt-2">
                                @foreach (var ofi in oficinasFiltradas)
                                {
                                    <button type="button"
                                            class="list-group-item list-group-item-action"
                                            @onclick="() => SeleccionarOficina(ofi)">
                                        @ofi.Nombre
                                    </button>
                                }
                            </div>
                        }

                        <small class="text-muted">
                            Puede buscar escribiendo palabras en cualquier orden.
                        </small>
                    </div>
                }

                @if (!(esActuacion && soloTraerSinActuacion))
                {
                    <div class="col-md-6 mb-3">
                        <label>Estado Inicial:</label>
                        <InputSelect @bind-Value="nuevoDoc.IdEstadoActual" class="form-control">
                            @foreach (var est in estados)
                            {
                                <option value="@est.IdEstado">@est.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-block">
        <button type="submit" class="btn btn-success btn-lg">
            @if (esActuacion)
            {
                @if (soloTraerSinActuacion)
                {
                    <span><i class="bi bi-box-arrow-in-down"></i> Traer sin Actuación</span>
                }
                else
                {
                    <span><i class="bi bi-send-check"></i> Guardar Actuación y Traer todo</span>
                }
            }
            else
            {
                <span><i class="bi bi-save"></i> Registrar Ingreso</span>
            }
        </button>
        <a href="documentos" class="btn btn-secondary btn-lg">Cancelar</a>
    </div>

</EditForm>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }

    [SupplyParameterFromQuery]
    public int? IdPadre { get; set; }

    [SupplyParameterFromQuery]
    public bool? AutoPaseBandeja { get; set; }

    private bool esActuacion = false;
    private MaeDocumento nuevoDoc = new MaeDocumento
    {
        FechaCreacion = DateTime.Now,
        Asunto = string.Empty
    };
    private string? errorGuardar;

    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatTipoDocumento> tipos = new List<CatTipoDocumento>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();

    private string busquedaPadre = string.Empty;
    private List<MaeDocumento>? resultadosBusqueda;
    private MaeDocumento? docPadreSeleccionado;
    private int? idOficinaBandejaEntrada;
    private int idOficinaUsuarioActual;
    private string nombreOficinaActualDoc = string.Empty;
    private bool soloTraerSinActuacion;
    private string oficinaBusqueda = string.Empty;
    private List<CatOficina> oficinasFiltradas = new();

    protected override async Task OnInitializedAsync()
    {
        oficinas = await RepoOficinas.GetAllAsync();
        tipos = await RepoTipos.GetAllAsync();
        estados = await RepoEstados.GetAllAsync();

        var estadoInicial = estados.FirstOrDefault();
        if (estadoInicial != null)
        {
            nuevoDoc.IdEstadoActual = estadoInicial.IdEstado;
        }

        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
        idOficinaBandejaEntrada = oficinas
            .FirstOrDefault(o => string.Equals(o.Nombre, "BANDEJA DE ENTRADA", StringComparison.OrdinalIgnoreCase))
            ?.IdOficina;

        var authState = await (AuthStateTask ?? Task.FromResult(new AuthenticationState(new ClaimsPrincipal(new ClaimsIdentity()))));
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var uid))
            {
                nuevoDoc.IdUsuarioCreador = uid;
            }

            var oficinaClaim = user.FindFirst(c => c.Type == "IdOficina");
            if (oficinaClaim != null && int.TryParse(oficinaClaim.Value, out var oid))
            {
                idOficinaUsuarioActual = oid;
                nuevoDoc.IdOficinaActual = oid;
            }
        }

        oficinaBusqueda = oficinas.FirstOrDefault(o => o.IdOficina == nuevoDoc.IdOficinaActual)?.Nombre ?? string.Empty;

        if (IdPadre.HasValue)
        {
            var docPadres = await RepoDocs.GetAllAsync();
            var padre = docPadres.FirstOrDefault(d => d.IdDocumento == IdPadre.Value);

            if (padre != null)
            {
                esActuacion = true;
                docPadreSeleccionado = padre;

                nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
                nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
                nuevoDoc.IdOficinaActual = padre.IdOficinaActual;

                nombreOficinaActualDoc = oficinas.FirstOrDefault(o => o.IdOficina == padre.IdOficinaActual)?.Nombre ?? "Oficina Remota";

                var tipoMemo = tipos.FirstOrDefault(t =>
                    t.Nombre.Contains("Memorando", StringComparison.OrdinalIgnoreCase) ||
                    t.Nombre.Contains("Actuación", StringComparison.OrdinalIgnoreCase));

                if (tipoMemo != null)
                {
                    nuevoDoc.IdTipo = tipoMemo.IdTipo;
                }
            }
        }
    }

    private async Task BuscarPadre()
    {
        if (!string.IsNullOrWhiteSpace(busquedaPadre))
        {
            var todos = await RepoDocs.GetAllAsync();
            resultadosBusqueda = todos
                .Where(d =>
                    (d.Asunto?.Contains(busquedaPadre, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (!string.IsNullOrWhiteSpace(d.NumeroOficial) && d.NumeroOficial.Contains(busquedaPadre, StringComparison.OrdinalIgnoreCase)))
                .Take(5)
                .ToList();
        }
    }

    private void SeleccionarPadre(MaeDocumento padre)
    {
        docPadreSeleccionado = padre;
        nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
        nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
        resultadosBusqueda = null;
        busquedaPadre = string.Empty;
    }

    private void QuitarVinculo()
    {
        docPadreSeleccionado = null;
        nuevoDoc.IdDocumentoPadre = null;
        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
    }

    private async Task Guardar()
    {
        errorGuardar = null;

        if (esActuacion && soloTraerSinActuacion && docPadreSeleccionado != null)
        {
            if (!idOficinaBandejaEntrada.HasValue)
            {
                errorGuardar = "No se encontró la oficina BANDEJA DE ENTRADA para realizar el traslado.";
                return;
            }

            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                idOficinaBandejaEntrada.Value,
                "Traslado de familia sin actuación hacia BANDEJA DE ENTRADA");

            Navegador.NavigateTo("documentos");
            return;
        }

        nuevoDoc.Asunto = nuevoDoc.Asunto?.Trim() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(nuevoDoc.Asunto))
        {
            errorGuardar = "Debe ingresar el contenido/asunto del documento.";
            return;
        }

        if (nuevoDoc.Asunto.Length > 200)
        {
            errorGuardar = "El contenido/asunto no puede superar los 200 caracteres.";
            return;
        }

        if (!tipos.Any(t => t.IdTipo == nuevoDoc.IdTipo))
        {
            errorGuardar = "Tipo de documento inválido.";
            return;
        }

        if (!estados.Any(e => e.IdEstado == nuevoDoc.IdEstadoActual))
        {
            errorGuardar = "Estado inválido.";
            return;
        }

        if (!oficinas.Any(o => o.IdOficina == nuevoDoc.IdOficinaActual))
        {
            errorGuardar = "Debe seleccionar una oficina válida.";
            return;
        }

        await RepoDocs.AddAsync(nuevoDoc);

        var obsCreacion = esActuacion
            ? $"Confección de Memorando/Actuación (Ref: {docPadreSeleccionado?.NumeroOficial})"
            : "Se crea el documento";

        var movCreacion = new TraMovimiento
        {
            IdDocumento = nuevoDoc.IdDocumento,
            IdOficinaOrigen = nuevoDoc.IdOficinaActual,
            IdOficinaDestino = nuevoDoc.IdOficinaActual,
            FechaMovimiento = DateTime.Now,
            IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
            ObservacionPase = obsCreacion
        };
        await RepoMovimientos.AddAsync(movCreacion);

        if (AutoPaseBandeja == true && esActuacion && docPadreSeleccionado != null)
        {
            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                idOficinaUsuarioActual,
                $"Retorno de Expediente por agregación de actuación (Ref: {nuevoDoc.NumeroOficial ?? "S/N"})");
        }
        else if (idOficinaUsuarioActual > 0 && nuevoDoc.IdOficinaActual != idOficinaUsuarioActual)
        {
            var oficinaOrigen = nuevoDoc.IdOficinaActual;
            var oficinaDestino = idOficinaBandejaEntrada ?? nuevoDoc.IdOficinaActual;
            var nombreOficinaOrigen = oficinas.FirstOrDefault(o => o.IdOficina == oficinaOrigen)?.Nombre ?? $"Oficina {oficinaOrigen}";

            var movPase = new TraMovimiento
            {
                IdDocumento = nuevoDoc.IdDocumento,
                IdOficinaOrigen = oficinaOrigen,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now.AddSeconds(1),
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = $"BANDEJA DE ENTRADA recibe el documento desde {nombreOficinaOrigen}"
            };

            await RepoMovimientos.AddAsync(movPase);

            nuevoDoc.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(nuevoDoc);
        }

        Navegador.NavigateTo("documentos");
    }

    private async Task MoverFamiliaADestino(Guid hiloConversacion, int oficinaDestino, string observacion)
    {
        var documentosFamilia = (await RepoDocs.GetAllAsync())
            .Where(d => d.IdHiloConversacion == hiloConversacion)
            .ToList();

        foreach (var documento in documentosFamilia)
        {
            if (documento.IdOficinaActual == oficinaDestino)
            {
                continue;
            }

            var movimiento = new TraMovimiento
            {
                IdDocumento = documento.IdDocumento,
                IdOficinaOrigen = documento.IdOficinaActual,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now.AddSeconds(1),
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = observacion
            };

            await RepoMovimientos.AddAsync(movimiento);

            documento.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(documento);
        }
    }

    private void FiltrarOficinas(ChangeEventArgs e)
    {
        oficinaBusqueda = e.Value?.ToString() ?? string.Empty;
        nuevoDoc.IdOficinaActual = 0;

        if (string.IsNullOrWhiteSpace(oficinaBusqueda))
        {
            oficinasFiltradas.Clear();
            return;
        }

        oficinasFiltradas = BuscarOficinas(oficinaBusqueda)
            .Take(8)
            .ToList();

        var coincidenciaExacta = oficinas.FirstOrDefault(o =>
            string.Equals(o.Nombre, oficinaBusqueda, StringComparison.OrdinalIgnoreCase));

        if (coincidenciaExacta != null)
        {
            nuevoDoc.IdOficinaActual = coincidenciaExacta.IdOficina;
        }
    }

    private void SeleccionarOficina(CatOficina oficina)
    {
        nuevoDoc.IdOficinaActual = oficina.IdOficina;
        oficinaBusqueda = oficina.Nombre ?? string.Empty;
        oficinasFiltradas.Clear();
    }

    private IEnumerable<CatOficina> BuscarOficinas(string terminoBusqueda)
    {
        var palabras = terminoBusqueda
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        if (palabras.Length == 0)
        {
            return Enumerable.Empty<CatOficina>();
        }

        return oficinas
            .Where(o => palabras.All(palabra =>
                (o.Nombre?.Contains(palabra, StringComparison.OrdinalIgnoreCase) ?? false)))
            .OrderBy(o => o.Nombre);
    }
}
