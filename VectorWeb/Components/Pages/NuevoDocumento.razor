@page "/documentos/nuevo"
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.Security.Claims
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatTipoDocumento> RepoTipos
@inject IRepository<CatEstado> RepoEstados
@inject NumeracionRangoService RangoService
@inject NavigationManager Navegador
@rendermode InteractiveServer

<h3>
    @if (esActuacion)
    {
        <span><i class="bi bi-reply-all-fill"></i> Confeccionar Respuesta / Actuación</span>
    }
    else
    {
        <span><i class="bi bi-file-earmark-plus"></i> Ingreso de Documento - Mesa de Entrada</span>
    }
</h3>

<EditForm Model="nuevoDoc" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @if (!string.IsNullOrWhiteSpace(errorGuardar))
    {
        <div class="alert alert-danger" role="alert">@errorGuardar</div>
    }

    @if (!string.IsNullOrWhiteSpace(mensajeNumeracion))
    {
        <div class="alert alert-info" role="alert">@mensajeNumeracion</div>
    }

    @if (!esActuacion)
    {
        <div class="card mb-3 border-primary">
            <div class="card-header bg-light">
                <i class="bi bi-link-45deg"></i> Vinculación (Opcional)
            </div>
            <div class="card-body">
                @if (docPadreSeleccionado == null)
                {
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar documento padre por Asunto o Nro..."
                               @bind="busquedaPadre" />
                        <button type="button" class="btn btn-outline-primary" @onclick="BuscarPadre">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>

                    @if (resultadosBusqueda != null && resultadosBusqueda.Any())
                    {
                        <table class="table table-sm mt-2 table-hover">
                            <thead>
                                <tr>
                                    <th>Nro</th>
                                    <th>Asunto</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var d in resultadosBusqueda)
                                {
                                    <tr>
                                        <td>@d.NumeroOficial</td>
                                        <td>@d.Asunto</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary" @onclick="() => SeleccionarPadre(d)">
                                                Vincular
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                }
                else
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>
                            <strong>VINCULADO A:</strong> @docPadreSeleccionado.NumeroOficial - @docPadreSeleccionado.Asunto
                        </span>
                        <button type="button" class="btn btn-sm btn-danger" @onclick="QuitarVinculo">
                            <i class="bi bi-x-circle"></i> Quitar
                        </button>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning shadow-sm">
            <h5 class="alert-heading"><i class="bi bi-folder-fill"></i> Trabajando sobre el Expediente: @docPadreSeleccionado?.NumeroOficial</h5>
            <p class="mb-0">@docPadreSeleccionado?.Asunto</p>
            <hr>
            <small class="mb-0 text-muted">
                <i class="bi bi-geo-alt-fill"></i> Ubicación actual: <strong>@nombreOficinaActualDoc</strong>
            </small>
            @if (paseConActuacionForzado)
            {
                <div class="alert alert-info mt-3 mb-0 py-2">
                    El pase fue confirmado con actuación, por lo que esta actuación se guardará y se aplicará el traslado automático configurado.
                </div>
            }
            else
            {
                <div class="form-check mt-3">
                    <InputCheckbox id="soloTraerSinActuacion" class="form-check-input" @bind-Value="soloTraerSinActuacion" />
                    <label for="soloTraerSinActuacion" class="form-check-label">
                        La documentación ya está completa, solo deseo traer el expediente sin agregar esta actuación (no se guardará esta actuación ni se agregará al hilo de conversación)
                    </label>
                </div>
            }
        </div>
    }

    <div class="card mb-3">
        <div class="card-body">
            @if (!(esActuacion && soloTraerSinActuacion))
            {
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Tipo de Documento:</label>
                        <select class="form-control" value="@nuevoDoc.IdTipo" @onchange="OnTipoDocumentoChanged">
                            <option value="0">-- Seleccione Tipo --</option>
                            @foreach (var tipo in tipos)
                            {
                                <option value="@tipo.IdTipo">@tipo.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Número Oficial:</label>
                        @if (esNumeracionAutomatica)
                        {
                            <input type="text" class="form-control" value="Automático (se asigna al guardar)" disabled />
                            <small class="text-muted">Serie: <strong>@serieNumeracionAutomatica</strong> | Próximo estimado: @proximoNumeroAutomatico</small>
                        }
                        else
                        {
                            <InputText @bind-Value="nuevoDoc.NumeroOficial" class="form-control" maxlength="50" placeholder="Ej. MEMO-2024-001" />
                            @if (esNumeracionExterna)
                            {
                                <small class="text-muted">Numeración externa: ingrese el número oficial provisto por la entidad de origen.</small>
                            }
                        }
                    </div>
                </div>
            }

            @if (!soloTraerSinActuacion)
            {
                <div class="mb-3">
                    <label>Contenido / Asunto del Memorando:</label>
                    <InputTextArea @bind-Value="nuevoDoc.Asunto" class="form-control" rows="4" />
                </div>
            }

            <div class="row">
                @if (!esActuacion)
                {
                    <div class="col-md-6 mb-3">
                        <label>Ubicación Inicial:</label>
                        <div class="position-relative">
                            <input type="text"
                                   class="form-control"
                                   placeholder="Escriba para buscar oficina..."
                                   value="@oficinaBusqueda"
                                   autocomplete="off"
                                   @oninput="FiltrarOficinas"
                                   @onfocus="MostrarSugerenciasOficina"
                                   @onkeydown="ManejarTecladoOficinas" />

                            @if (oficinasFiltradas.Any())
                            {
                                <div class="list-group position-absolute start-0 end-0 shadow-sm"
                                     style="@EstiloPanelSugerencias">
                                    @for (var i = 0; i < oficinasFiltradas.Count; i++)
                                    {
                                        var ofi = oficinasFiltradas[i];
                                        var cssItem = i == indiceOficinaSeleccionada
                                            ? "list-group-item list-group-item-action active"
                                            : "list-group-item list-group-item-action";

                                        <button type="button"
                                                class="@cssItem"
                                                @onclick="() => SeleccionarOficina(ofi)">
                                            @ofi.Nombre
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <small class="text-muted">
                            Puede buscar escribiendo palabras en cualquier orden. Use ↑ ↓ y Enter para seleccionar.
                        </small>
                    </div>
                }

                @if (!(esActuacion && soloTraerSinActuacion))
                {
                    <div class="col-md-6 mb-3">
                        <label>Estado Inicial:</label>
                        <InputSelect @bind-Value="nuevoDoc.IdEstadoActual" class="form-control">
                            @foreach (var est in estados)
                            {
                                <option value="@est.IdEstado">@est.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-block">
        <button type="submit" class="btn btn-success btn-lg">
            @if (esActuacion)
            {
                @if (soloTraerSinActuacion)
                {
                    <span><i class="bi bi-box-arrow-in-down"></i> Traer sin Actuación</span>
                }
                else
                {
                    <span><i class="bi bi-send-check"></i> @EtiquetaBotonPaseConActuacion</span>
                }
            }
            else
            {
                <span><i class="bi bi-save"></i> Registrar Ingreso</span>
            }
        </button>
        <a href="documentos" class="btn btn-secondary btn-lg">Cancelar</a>
    </div>

</EditForm>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }

    [SupplyParameterFromQuery]
    public int? IdPadre { get; set; }

    [SupplyParameterFromQuery]
    public bool? AutoPaseBandeja { get; set; }

    [SupplyParameterFromQuery]
    public int? AutoPaseDestino { get; set; }

    private bool esActuacion = false;
    private MaeDocumento nuevoDoc = new MaeDocumento
    {
        FechaCreacion = DateTime.Now,
        Asunto = string.Empty
    };
    private string? errorGuardar;

    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatTipoDocumento> tipos = new List<CatTipoDocumento>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();

    private string busquedaPadre = string.Empty;
    private List<MaeDocumento>? resultadosBusqueda;
    private MaeDocumento? docPadreSeleccionado;
    private int? idOficinaBandejaEntrada;
    private int idOficinaUsuarioActual;
    private string nombreOficinaActualDoc = string.Empty;
    private bool soloTraerSinActuacion;
    private bool paseConActuacionForzado => AutoPaseBandeja == true || AutoPaseDestino.HasValue;
    private string EtiquetaBotonPaseConActuacion => AutoPaseDestino.HasValue
        ? "Guardar Actuación y Enviar todo"
        : "Guardar Actuación y Traer todo";
    private string oficinaBusqueda = string.Empty;
    private List<CatOficina> oficinasFiltradas = new();
    private int indiceOficinaSeleccionada = -1;
    private bool mostrarSugerenciasArriba = true;
    private bool esNumeracionAutomatica;
    private bool esNumeracionExterna;
    private string mensajeNumeracion = string.Empty;
    private string serieNumeracionAutomatica = string.Empty;
    private int proximoNumeroAutomatico;
    private string EstiloPanelSugerencias => mostrarSugerenciasArriba
        ? "z-index: 20; bottom: calc(100% + .25rem);"
        : "z-index: 20; top: calc(100% + .25rem);";

    protected override async Task OnInitializedAsync()
    {
        oficinas = await RepoOficinas.GetAllAsync();
        tipos = await RepoTipos.GetAllAsync();
        estados = await RepoEstados.GetAllAsync();

        var estadoInicial = estados.FirstOrDefault();
        if (estadoInicial != null)
        {
            nuevoDoc.IdEstadoActual = estadoInicial.IdEstado;
        }

        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
        idOficinaBandejaEntrada = oficinas
            .FirstOrDefault(o => string.Equals(o.Nombre, "BANDEJA DE ENTRADA", StringComparison.OrdinalIgnoreCase))
            ?.IdOficina;

        var authState = await (AuthStateTask ?? Task.FromResult(new AuthenticationState(new ClaimsPrincipal(new ClaimsIdentity()))));
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var uid))
            {
                nuevoDoc.IdUsuarioCreador = uid;
            }

            var oficinaClaim = user.FindFirst(c => c.Type == "IdOficina");
            if (oficinaClaim != null && int.TryParse(oficinaClaim.Value, out var oid))
            {
                idOficinaUsuarioActual = oid;
                nuevoDoc.IdOficinaActual = oid;
            }
        }

        oficinaBusqueda = oficinas.FirstOrDefault(o => o.IdOficina == nuevoDoc.IdOficinaActual)?.Nombre ?? string.Empty;

        if (IdPadre.HasValue)
        {
            var docPadres = await RepoDocs.GetAllAsync();
            var padre = docPadres.FirstOrDefault(d => d.IdDocumento == IdPadre.Value);

            if (padre != null)
            {
                esActuacion = true;
                docPadreSeleccionado = padre;

                nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
                nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
                nuevoDoc.IdOficinaActual = padre.IdOficinaActual;

                nombreOficinaActualDoc = oficinas.FirstOrDefault(o => o.IdOficina == padre.IdOficinaActual)?.Nombre ?? "Oficina Remota";

                var tipoMemo = tipos.FirstOrDefault(t =>
                    t.Nombre.Contains("Memorando", StringComparison.OrdinalIgnoreCase) ||
                    t.Nombre.Contains("Actuación", StringComparison.OrdinalIgnoreCase));

                if (tipoMemo != null)
                {
                    nuevoDoc.IdTipo = tipoMemo.IdTipo;
                }

                if (paseConActuacionForzado)
                {
                    soloTraerSinActuacion = false;
                }
            }
        }

        if (nuevoDoc.IdTipo > 0)
        {
            await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
        }
    }

    private async Task BuscarPadre()
    {
        if (!string.IsNullOrWhiteSpace(busquedaPadre))
        {
            var todos = await RepoDocs.GetAllAsync();
            resultadosBusqueda = todos
                .Where(d =>
                    (d.Asunto?.Contains(busquedaPadre, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (!string.IsNullOrWhiteSpace(d.NumeroOficial) && d.NumeroOficial.Contains(busquedaPadre, StringComparison.OrdinalIgnoreCase)))
                .Take(5)
                .ToList();
        }
    }

    private void SeleccionarPadre(MaeDocumento padre)
    {
        docPadreSeleccionado = padre;
        nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
        nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
        resultadosBusqueda = null;
        busquedaPadre = string.Empty;
    }

    private void QuitarVinculo()
    {
        docPadreSeleccionado = null;
        nuevoDoc.IdDocumentoPadre = null;
        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
    }

    private async Task Guardar()
    {
        errorGuardar = null;

        if (paseConActuacionForzado)
        {
            soloTraerSinActuacion = false;
        }

        if (esActuacion && soloTraerSinActuacion && docPadreSeleccionado != null)
        {
            if (!idOficinaBandejaEntrada.HasValue)
            {
                errorGuardar = "No se encontró la oficina BANDEJA DE ENTRADA para realizar el traslado.";
                return;
            }

            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                idOficinaBandejaEntrada.Value,
                "Traslado de familia sin actuación hacia BANDEJA DE ENTRADA");

            Navegador.NavigateTo("documentos");
            return;
        }

        nuevoDoc.Asunto = nuevoDoc.Asunto?.Trim() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(nuevoDoc.Asunto))
        {
            errorGuardar = "Debe ingresar el contenido/asunto del documento.";
            return;
        }

        if (nuevoDoc.Asunto.Length > 200)
        {
            errorGuardar = "El contenido/asunto no puede superar los 200 caracteres.";
            return;
        }

        if (!tipos.Any(t => t.IdTipo == nuevoDoc.IdTipo))
        {
            errorGuardar = "Tipo de documento inválido.";
            return;
        }

        if (!estados.Any(e => e.IdEstado == nuevoDoc.IdEstadoActual))
        {
            errorGuardar = "Estado inválido.";
            return;
        }

        if (!oficinas.Any(o => o.IdOficina == nuevoDoc.IdOficinaActual))
        {
            errorGuardar = "Debe seleccionar una oficina válida.";
            return;
        }

        if (esNumeracionAutomatica)
        {
            try
            {
                var rangoConsumido = await RangoService.ConsumirSiguienteNumeroAsync(nuevoDoc.IdTipo, nuevoDoc.IdOficinaActual);
                nuevoDoc.NumeroOficial = $"{rangoConsumido.NombreRango}-{rangoConsumido.UltimoUtilizado}";
            }
            catch (InvalidOperationException ex)
            {
                errorGuardar = ex.Message;
                return;
            }
        }
        else
        {
            nuevoDoc.NumeroOficial = nuevoDoc.NumeroOficial?.Trim();

            if (string.IsNullOrWhiteSpace(nuevoDoc.NumeroOficial))
            {
                errorGuardar = "Debe ingresar el número oficial para numeración externa.";
                return;
            }

            if (nuevoDoc.NumeroOficial.Length > 50)
            {
                errorGuardar = "El número oficial no puede superar los 50 caracteres.";
                return;
            }

            var documentosExistentes = await RepoDocs.GetAllAsync();
            var existeDuplicado = documentosExistentes.Any(d =>
                d.IdTipo == nuevoDoc.IdTipo &&
                d.IdOficinaActual == nuevoDoc.IdOficinaActual &&
                d.FechaCreacion.HasValue &&
                d.FechaCreacion.Value.Year == (nuevoDoc.FechaCreacion ?? DateTime.Now).Year &&
                string.Equals(d.NumeroOficial, nuevoDoc.NumeroOficial, StringComparison.OrdinalIgnoreCase));

            if (existeDuplicado)
            {
                errorGuardar = "Ya existe un documento con ese número oficial para la misma oficina, tipo y año.";
                return;
            }
        }

        await RepoDocs.AddAsync(nuevoDoc);

        var obsCreacion = esActuacion
            ? $"Confección de Memorando/Actuación (Ref: {docPadreSeleccionado?.NumeroOficial})"
            : "Se crea el documento";

        var movCreacion = new TraMovimiento
        {
            IdDocumento = nuevoDoc.IdDocumento,
            IdOficinaOrigen = nuevoDoc.IdOficinaActual,
            IdOficinaDestino = nuevoDoc.IdOficinaActual,
            FechaMovimiento = DateTime.Now,
            IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
            ObservacionPase = obsCreacion
        };
        await RepoMovimientos.AddAsync(movCreacion);

        if (AutoPaseBandeja == true && esActuacion && docPadreSeleccionado != null)
        {
            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                idOficinaUsuarioActual,
                $"Retorno de Expediente por agregación de actuación (Ref: {nuevoDoc.NumeroOficial ?? "S/N"})");
        }
        else if (AutoPaseDestino.HasValue && esActuacion && docPadreSeleccionado != null)
        {
            await MoverFamiliaADestino(
                docPadreSeleccionado.IdHiloConversacion,
                AutoPaseDestino.Value,
                $"Pase de Expediente por agregación de actuación (Ref: {nuevoDoc.NumeroOficial ?? "S/N"})");
        }
        else if (idOficinaUsuarioActual > 0 && nuevoDoc.IdOficinaActual != idOficinaUsuarioActual)
        {
            var oficinaOrigen = nuevoDoc.IdOficinaActual;
            var oficinaDestino = idOficinaBandejaEntrada ?? nuevoDoc.IdOficinaActual;
            var nombreOficinaOrigen = oficinas.FirstOrDefault(o => o.IdOficina == oficinaOrigen)?.Nombre ?? $"Oficina {oficinaOrigen}";

            var movPase = new TraMovimiento
            {
                IdDocumento = nuevoDoc.IdDocumento,
                IdOficinaOrigen = oficinaOrigen,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now.AddSeconds(1),
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = $"BANDEJA DE ENTRADA recibe el documento desde {nombreOficinaOrigen}"
            };

            await RepoMovimientos.AddAsync(movPase);

            nuevoDoc.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(nuevoDoc);
        }

        Navegador.NavigateTo("documentos");
    }

    private async Task MoverFamiliaADestino(Guid hiloConversacion, int oficinaDestino, string observacion)
    {
        var documentosFamilia = (await RepoDocs.GetAllAsync())
            .Where(d => d.IdHiloConversacion == hiloConversacion)
            .ToList();

        foreach (var documento in documentosFamilia)
        {
            if (documento.IdOficinaActual == oficinaDestino)
            {
                continue;
            }

            var movimiento = new TraMovimiento
            {
                IdDocumento = documento.IdDocumento,
                IdOficinaOrigen = documento.IdOficinaActual,
                IdOficinaDestino = oficinaDestino,
                FechaMovimiento = DateTime.Now.AddSeconds(1),
                IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador,
                ObservacionPase = observacion
            };

            await RepoMovimientos.AddAsync(movimiento);

            documento.IdOficinaActual = oficinaDestino;
            await RepoDocs.UpdateAsync(documento);
        }
    }

    private async Task OnTipoDocumentoChanged(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        if (!int.TryParse(valor, out var idTipoSeleccionado))
        {
            idTipoSeleccionado = 0;
        }

        nuevoDoc.IdTipo = idTipoSeleccionado;
        await EvaluarNumeracionAutomaticaAsync(idTipoSeleccionado);
    }

    private async Task EvaluarNumeracionAutomaticaAsync(int idTipoDocumento)
    {
        esNumeracionAutomatica = false;
        esNumeracionExterna = false;
        mensajeNumeracion = string.Empty;
        serieNumeracionAutomatica = string.Empty;
        proximoNumeroAutomatico = 0;

        if (idTipoDocumento <= 0)
        {
            return;
        }

        var rango = await RangoService.ObtenerRangoActivoAsync(idTipoDocumento, nuevoDoc.IdOficinaActual);

        if (rango is not null)
        {
            esNumeracionAutomatica = true;
            serieNumeracionAutomatica = rango.NombreRango;
            proximoNumeroAutomatico = rango.UltimoUtilizado + 1;
            nuevoDoc.NumeroOficial = string.Empty;
            mensajeNumeracion = "Modo administrado por rango: el número se asignará automáticamente al guardar.";
            return;
        }

        esNumeracionExterna = true;
        mensajeNumeracion = "Modo numeración externa: ingrese manualmente el número oficial con validación de unicidad por oficina, tipo y año.";
    }

    private async Task FiltrarOficinas(ChangeEventArgs e)
    {
        oficinaBusqueda = e.Value?.ToString() ?? string.Empty;
        nuevoDoc.IdOficinaActual = 0;
        indiceOficinaSeleccionada = -1;

        if (string.IsNullOrWhiteSpace(oficinaBusqueda))
        {
            oficinasFiltradas.Clear();
            return;
        }

        oficinasFiltradas = BuscarOficinas(oficinaBusqueda)
            .Take(8)
            .ToList();

        var coincidenciaExacta = oficinas.FirstOrDefault(o =>
            string.Equals(o.Nombre, oficinaBusqueda, StringComparison.OrdinalIgnoreCase));

        if (coincidenciaExacta != null)
        {
            nuevoDoc.IdOficinaActual = coincidenciaExacta.IdOficina;

            if (nuevoDoc.IdTipo > 0)
            {
                await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
            }
        }
    }

    private async Task SeleccionarOficina(CatOficina oficina)
    {
        nuevoDoc.IdOficinaActual = oficina.IdOficina;
        oficinaBusqueda = oficina.Nombre ?? string.Empty;
        oficinasFiltradas.Clear();
        indiceOficinaSeleccionada = -1;

        if (nuevoDoc.IdTipo > 0)
        {
            await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
        }
    }

    private void MostrarSugerenciasOficina()
    {
        if (!string.IsNullOrWhiteSpace(oficinaBusqueda))
        {
            oficinasFiltradas = BuscarOficinas(oficinaBusqueda)
                .Take(8)
                .ToList();
        }
    }

    private void ManejarTecladoOficinas(KeyboardEventArgs e)
    {
        if (!oficinasFiltradas.Any())
        {
            return;
        }

        if (e.Key == "ArrowDown")
        {
            indiceOficinaSeleccionada = Math.Min(indiceOficinaSeleccionada + 1, oficinasFiltradas.Count - 1);
            return;
        }

        if (e.Key == "ArrowUp")
        {
            indiceOficinaSeleccionada = Math.Max(indiceOficinaSeleccionada - 1, 0);
            return;
        }

        if (e.Key == "Enter" && indiceOficinaSeleccionada >= 0)
        {
            SeleccionarOficina(oficinasFiltradas[indiceOficinaSeleccionada]);
            return;
        }

        if (e.Key == "Escape")
        {
            oficinasFiltradas.Clear();
            indiceOficinaSeleccionada = -1;
        }
    }

    private IEnumerable<CatOficina> BuscarOficinas(string terminoBusqueda)
    {
        var palabras = terminoBusqueda
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        if (palabras.Length == 0)
        {
            return Enumerable.Empty<CatOficina>();
        }

        return oficinas
            .Where(o => palabras.All(palabra =>
                (o.Nombre?.Contains(palabra, StringComparison.OrdinalIgnoreCase) ?? false)))
            .OrderBy(o => o.Nombre);
    }
}
