@page "/documentos/nuevo"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "documentos.editar")]
@using VectorWeb.Models
@using VectorWeb.Repositories
@using VectorWeb.Services
@using VectorWeb.Utils
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using System.Globalization
@using System.Security.Claims
@using System.Text
@inject IRepository<MaeDocumento> RepoDocs
@inject IRepository<TraMovimiento> RepoMovimientos
@inject IRepository<CatOficina> RepoOficinas
@inject IRepository<CatTipoDocumento> RepoTipos
@inject IRepository<CatEstado> RepoEstados
@inject IRepository<MaeRecluso> RepoReclusos
@inject NumeracionRangoService RangoService
@inject DocumentoPlazosService DocumentoPlazosService
@inject NavigationManager Navegador
@inject IJSRuntime JS
@inject SecretariaDbContext DbContext
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>@(esActuacion ? "Nueva Actuación" : "Nuevo Ingreso") - Vector</PageTitle>

<style>
    .form-section {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .section-title {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #0d6efd;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #f1f4f8;
        padding-bottom: 8px;
        margin-bottom: 1.5rem;
    }

    .search-panel {
        background: #f8fbff;
        border-radius: 8px;
        border: 1px solid #d0e2ff;
    }

    .label-custom {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }

    .modal-backdrop-custom {
        background-color: rgba(0,0,0,.5);
        backdrop-filter: blur(4px);
    }
</style>

<div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 fw-bold mb-0">
            @if (esActuacion)
            {
                <span class="text-primary"><i class="bi bi-reply-all-fill me-2"></i>Actuación sobre Expediente</span>
            }
            else
            {
                <span class="text-success"><i class="bi bi-file-earmark-plus me-2"></i>Ingreso - Mesa de Entrada</span>
            }
        </h2>
        <a href="documentos" class="btn btn-outline-secondary btn-sm shadow-sm">
            <i class="bi bi-arrow-left"></i> Cancelar y Volver
        </a>
    </header>

    <EditForm EditContext="editContextNuevoDocumento" OnSubmit="IgnorarSubmitNuevoDocumento">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrWhiteSpace(errorGuardar))
        {
            <div class="alert alert-danger shadow-sm border-start border-4 border-danger" role="alert">
                <i class="bi bi-exclamation-octagon-fill me-2"></i> @errorGuardar
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(mensajeNumeracion))
        {
            <div class="alert alert-info border-0 shadow-sm small py-2 mb-4" role="alert">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <span><i class="bi bi-info-circle-fill me-2"></i> @mensajeNumeracion</span>
                    @if (MostrarAccesoGestionRangos)
                    {
                        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AbrirGestionRangosConContexto">
                            <i class="bi bi-sliders me-1"></i> Gestionar rango de esta oficina
                        </button>
                    }
                </div>
            </div>
        }

        @if (esActuacion)
        {
            <div class="alert alert-warning shadow-sm border-0 mb-4 p-4">
                <div class="row align-items-center">
                    <div class="col-md-9">
                        <h5 class="fw-bold mb-1"><i class="bi bi-folder-fill me-2"></i>Expediente: @TipoYNumeroExpediente</h5>
                        <p class="mb-0 text-dark">@docPadreSeleccionado?.Asunto</p>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-geo-alt-fill text-danger"></i> Ubicación actual: <strong>@nombreOficinaActualDoc</strong>
                        </small>
                        @if (paseConActuacionForzado)
                        {
                            <div class="mt-2">
                                <span class="badge bg-primary px-3 py-2">Oficina destino: @NombreOficinaDestinoPase</span>
                            </div>
                        }
                    </div>
                    <div class="col-md-3 text-md-end mt-3 mt-md-0">
                        @if (!paseConActuacionForzado)
                        {
                            <div class="form-check form-switch d-inline-block text-start">
                                <InputCheckbox id="soloTraerSinActuacion" class="form-check-input shadow-none" @bind-Value="soloTraerSinActuacion" />
                                <label for="soloTraerSinActuacion" class="form-check-label small fw-bold">Solo traer expediente</label>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <div class="row g-4">
            <div class="col-lg-12">
                <div class="form-section p-4">
                    @if (!(esActuacion && soloTraerSinActuacion))
                    {
                        <div class="section-title">Identificación y Clasificación</div>
                        <div class="row g-3 mb-4">
                            @if (!esActuacion)
                            {
                                <div class="col-md-6">
                                    <label class="label-custom mb-1">Oficina de Ubicación Inicial</label>
                                    <div class="position-relative" @ref="contenedorSugerenciasOficinaRef">
                                        <div class="input-group">
                                            <span class="input-group-text bg-white text-muted"><i class="bi bi-building"></i></span>
                                            <input type="text" class="form-control shadow-none" placeholder="Buscar oficina..."
                                                   value="@oficinaBusqueda" autocomplete="off"
                                                   @oninput="FiltrarOficinas" @onfocus="MostrarSugerenciasOficina" @onkeydown="ManejarTecladoOficinas" />
                                        </div>

                                        @if (oficinasFiltradas.Any())
                                        {
                                            <div class="list-group position-absolute start-0 end-0 shadow border-0 mt-1" style="@EstiloPanelSugerencias">
                                                @for (var i = 0; i < oficinasFiltradas.Count; i++)
                                                {
                                                    var ofi = oficinasFiltradas[i];
                                                    var activeClass = i == indiceOficinaSeleccionada ? "active" : "";
                                                    <button type="button" class="list-group-item list-group-item-action @activeClass py-2" @onclick="() => SeleccionarOficina(ofi)">
                                                        @ofi.Nombre
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <div class="col-md-4">
                                <label class="label-custom mb-1">Tipo de Documento</label>
                                <select class="form-select shadow-none" value="@nuevoDoc.IdTipo" @onchange="OnTipoDocumentoChanged">
                                    <option value="0">-- Seleccione Tipo --</option>
                                    @foreach (var tipo in tipos)
                                    {
                                        <option value="@tipo.IdTipo">@tipo.Nombre</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="label-custom mb-1">Estado del Trámite</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white text-muted"><i class="bi bi-flag"></i></span>
                                    <InputSelect @bind-Value="nuevoDoc.IdEstadoActual" class="form-select shadow-none">
                                        @foreach (var est in estados)
                                        {
                                            <option value="@est.IdEstado">@est.Nombre</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="label-custom mb-1">Año Fiscal</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-calendar-event"></i></span>
                                    <InputNumber @bind-Value="anioNumeracionSeleccionado" @bind-Value:after="OnAnioNumeracionChanged" class="form-control shadow-none" min="2000" max="2100" />
                                </div>
                                @if (anioNumeracionSeleccionado < DateTime.Now.Year)
                                {
                                    <small class="text-warning fw-bold d-block mt-1">Modo numeración histórica.</small>
                                }
                            </div>

                            <div class="col-md-4">
                                <label class="label-custom mb-1">Número Oficial</label>
                                @if (esNumeracionAutomatica)
                                {
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-light" value="Automático" disabled />
                                        <span class="input-group-text bg-primary text-white"><i class="bi bi-magic"></i></span>
                                    </div>
                                    <small class="text-muted d-block mt-1">Estimado: <strong>@proximoNumeroAutomatico</strong> (@serieNumeracionAutomatica)</small>
                                }
                                else if (esNumeracionManualInterna)
                                {
                                    <InputNumber @bind-Value="numeroManualInterno" class="form-control shadow-none border-primary" placeholder="Ingresar número" disabled="@bloqueoPorRangoAgotado" />
                                }
                                else
                                {
                                    <InputText @bind-Value="nuevoDoc.NumeroOficial" class="form-control shadow-none" maxlength="50" placeholder="Ej. JUZ-100/26" disabled="@bloqueoPorRangoAgotado" />
                                }
                            </div>
                        </div>

                        <div class="alert alert-light border d-flex align-items-center mb-3 py-2">
                            <i class="bi bi-hourglass-split text-info me-2 fs-5"></i>
                            <div>
                                <small class="text-muted text-uppercase fw-bold" style="font-size:0.7rem;">Vencimiento Calculado (Dec. 500/991)</small>
                                <div class="fw-bold text-dark">
                                    @nuevoDoc.FechaVencimiento?.ToString("dddd dd 'de' MMMM, yyyy")
                                </div>
                            </div>
                        </div>
                    }

                    @if (!soloTraerSinActuacion)
                    {
                        <div class="section-title">Detalle del Contenido</div>

                        @if (mostrarAvisoTextoSugeridoPadre)
                        {
                            <div class="alert alert-info border-0 shadow-sm py-2 px-3 mb-3 small">
                                <i class="bi bi-info-circle-fill me-1"></i>
                                El asunto y la descripción se sugieren porque provienen del expediente padre. Podés modificarlos si lo necesitás;
                                mantener nombres de PPL en el texto ayuda a la trazabilidad en búsquedas.
                            </div>
                        }

                        @if (!esActuacion)
                        {
                            <div class="search-panel p-3 mb-4">
                                <label class="label-custom mb-2"><i class="bi bi-people-fill me-1 text-primary"></i> Vincular PPL al Asunto</label>
                                <div class="row g-2">
                                    <div class="col-md-7 position-relative">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                            <input type="text" class="form-control shadow-none" placeholder="Buscar por nombre o CI..."
                                                   value="@busquedaReclusoAsunto" autocomplete="off"
                                                   @oninput="FiltrarReclusosAsunto" @onfocus="MostrarSugerenciasPPL" @onblur="OcultarSugerenciasPPLAsync" @onkeydown="ManejarTecladoPPL" />
                                        </div>

                                        @if (mostrarSugerenciasPPL && reclusosFiltradosAsunto.Any())
                                        {
                                            <div class="list-group position-absolute start-0 end-0 shadow border-0 mt-1" style="z-index: 1000;">
                                                @for (var i = 0; i < reclusosFiltradosAsunto.Count; i++)
                                                {
                                                    var recluso = reclusosFiltradosAsunto[i];
                                                    var activeClass = i == indicePPLSeleccionado ? "active" : "";
                                                    <button type="button" class="list-group-item list-group-item-action @activeClass small py-2" @onclick="() => AgregarReclusoAsunto(recluso)">
                                                        <strong>@recluso.NombreCompleto</strong> <span class="opacity-75">· @recluso.Documento</span>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <div class="col-md-5 d-flex gap-2">
                                        <button type="button" class="btn btn-primary btn-sm px-3 shadow-sm" @onclick="InsertarReclusosEnAsunto" disabled="@(!reclusosSeleccionadosAsunto.Any())">
                                            <i class="bi bi-pencil-square me-1"></i> Insertar
                                        </button>
                                        <button type="button" class="btn btn-light btn-sm px-3 border" @onclick="LimpiarReclusosAsunto" disabled="@(!reclusosSeleccionadosAsunto.Any())">
                                            Limpiar
                                        </button>
                                    </div>
                                </div>

                                @if (reclusosSeleccionadosAsunto.Any())
                                {
                                    <div class="mt-3 d-flex flex-wrap gap-1">
                                        @foreach (var recluso in reclusosSeleccionadosAsunto)
                                        {
                                            <span class="badge bg-white text-primary border border-primary-subtle d-inline-flex align-items-center gap-2 py-2 px-3 shadow-sm">
                                                @recluso.NombreCompleto
                                                <i class="bi bi-x-circle-fill text-danger cursor-pointer" style="cursor:pointer" @onclick="() => QuitarReclusoAsunto(recluso.IdRecluso)"></i>
                                            </span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <div class="mb-3">
                            <label class="label-custom mb-1">Asunto</label>
                            <InputTextArea @bind-Value="nuevoDoc.Asunto" class="form-control shadow-none" rows="3" placeholder="Ingrese el asunto del documento..." />
                            <div class="text-end">
                                <small class="@(nuevoDoc.Asunto?.Length > 200 ? "text-danger" : "text-muted")">@(nuevoDoc.Asunto?.Length ?? 0) / 200 caracteres</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="label-custom mb-1">Descripción detallada</label>
                            <InputTextArea @bind-Value="nuevoDoc.Descripcion" class="form-control shadow-none" rows="4" placeholder="Ingrese una descripción detallada (opcional)..." />
                        </div>
                    }
                </div>
            </div>

            @if (!esActuacion)
            {
                <div class="col-12">
                    <div class="form-section p-4 border-primary border-opacity-25">
                        <div class="section-title text-dark"><i class="bi bi-link-45deg me-1"></i>Referencia de Expediente Padre</div>
                        @if (docPadreSeleccionado == null)
                        {
                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded-3 border border-dashed">
                                <p class="mb-0 text-muted small"><i class="bi bi-info-circle me-1"></i> ¿Este documento es un adjunto de otro expediente?</p>
                                <button type="button" class="btn btn-sm btn-outline-primary fw-bold" @onclick="AbrirModalPadres">
                                    <i class="bi bi-search me-1"></i> Vincular Padre
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-primary d-flex justify-content-between align-items-center mb-0 shadow-sm p-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-white rounded-circle p-2 me-3">
                                        <i class="bi bi-diagram-3-fill text-primary"></i>
                                    </div>
                                    <div>
                                        <span class="d-block small text-uppercase fw-bold opacity-75">Documento Padre</span>
                                        <strong class="fs-5">@docPadreSeleccionado.NumeroOficial</strong>
                                        <span class="d-block small text-truncate" style="max-width: 400px;">@docPadreSeleccionado.Asunto</span>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-light border fw-bold" @onclick="AbrirModalPadres">Cambiar</button>
                                    <button type="button" class="btn btn-sm btn-danger fw-bold shadow-sm" @onclick="QuitarVinculo"><i class="bi bi-x-lg"></i></button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="mt-5 d-flex gap-2 justify-content-center">
            <button type="button" class="btn btn-success btn-lg px-5 shadow fw-bold" disabled="@bloqueoPorRangoAgotado" @onclick="GuardarDesdeBotonAsync">
                @if (esActuacion)
                {
                    @if (soloTraerSinActuacion)
                    {
                        <span><i class="bi bi-box-arrow-in-down me-2"></i>Traer Expediente</span>
                    }
                    else
                    {
                        <span><i class="bi bi-send-check me-2"></i>@EtiquetaBotonPaseConActuacion</span>
                    }
                }
                else
                {
                    <span><i class="bi bi-save-fill me-2"></i>Registrar Documento</span>
                }
            </button>
            <a href="documentos" class="btn btn-outline-secondary btn-lg px-4">Cancelar</a>
        </div>
    </EditForm>
</div>

@if (mostrarModalPadres)
{
    <div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold"><i class="bi bi-search me-2"></i>Seleccionar Documento Padre</h5>
                    <button type="button" class="btn-close btn-close-white" aria-label="Cerrar" @onclick="CerrarModalPadres"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label fw-bold small text-muted">Buscador Global</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                                <input class="form-control border-start-0 shadow-none" placeholder="Nro oficial, asunto o tipo..."
                                       @bind="FiltroModalPadre" @bind:event="oninput" />
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end d-flex align-items-end justify-content-md-end">
                            <span class="badge bg-light text-muted border py-2 px-3"><i class="bi bi-info-circle me-1"></i> Búsqueda en todas las oficinas</span>
                        </div>
                    </div>

                    <div class="table-responsive rounded-3 border">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="small text-uppercase p-3" style="width: 150px">Fecha</th>
                                    <th class="small text-uppercase p-3" style="width: 180px">Nro. Oficial</th>
                                    <th class="small text-uppercase p-3">Asunto</th>
                                    <th class="small text-uppercase p-3" style="width: 130px">Ubicación</th>
                                    <th class="small text-uppercase p-3 text-end" style="width: 130px">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!DocumentosPadrePaginados.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <i class="bi bi-folder-x fs-1 d-block mb-2"></i>
                                            No se encontraron documentos candidatos.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var doc in DocumentosPadrePaginados)
                                    {
                                        <tr>
                                            <td class="p-3">
                                                <div class="fw-bold">@doc.FechaCreacion?.ToString("dd/MM/yyyy")</div>
                                                <small class="text-muted">@doc.FechaCreacion?.ToString("HH:mm") hs</small>
                                            </td>
                                            <td class="p-3"><span class="badge bg-light text-primary border border-primary-subtle fw-bold">@(string.IsNullOrWhiteSpace(doc.NumeroOficial) ? "S/N" : doc.NumeroOficial)</span></td>
                                            <td class="p-3 small fw-medium">@doc.Asunto</td>
                                            <td class="p-3 small">@NombreOficina(doc.IdOficinaActual)</td>
                                            <td class="p-3 text-end">
                                                <button type="button" class="btn btn-sm btn-primary shadow-sm px-3" @onclick="() => SeleccionarPadreDesdeModal(doc)">
                                                    Elegir
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light p-3">
                    <div class="me-auto small text-muted">Mostrando @DesdeRegistroPadre-@HastaRegistroPadre de @TotalRegistrosPadre</div>
                    <div class="btn-group btn-group-sm me-3 shadow-sm">
                        <button type="button" class="btn btn-white border" @onclick="PaginaPadreAnterior" disabled="@(PaginaPadreEfectiva == 1)"><i class="bi bi-chevron-left"></i></button>
                        <span class="btn btn-white border disabled px-3">Página @PaginaPadreEfectiva</span>
                        <button type="button" class="btn btn-white border" @onclick="PaginaPadreSiguiente" disabled="@(PaginaPadreEfectiva >= TotalPaginasPadre)"><i class="bi bi-chevron-right"></i></button>
                    </div>
                    <button type="button" class="btn btn-secondary shadow-sm" @onclick="CerrarModalPadres">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }

    [SupplyParameterFromQuery]
    public long? IdPadre { get; set; }

    [SupplyParameterFromQuery]
    public bool? AutoPaseBandeja { get; set; }

    [SupplyParameterFromQuery]
    public int? AutoPaseDestino { get; set; }

    private bool esActuacion = false;
    private MaeDocumento nuevoDoc = new MaeDocumento
    {
        FechaCreacion = DateTime.Now,
        AnioDocumento = DateTime.Now.Year,
        Asunto = string.Empty
    };
    private EditContext editContextNuevoDocumento = default!;
    private string? errorGuardar;

    private IEnumerable<CatOficina> oficinas = new List<CatOficina>();
    private IEnumerable<CatTipoDocumento> tipos = new List<CatTipoDocumento>();
    private IEnumerable<CatEstado> estados = new List<CatEstado>();
    private List<MaeRecluso> reclusosActivos = new();
    private string busquedaReclusoAsunto = string.Empty;
    private List<MaeRecluso> reclusosFiltradosAsunto = new();
    private List<MaeRecluso> reclusosSeleccionadosAsunto = new();
    private int indicePPLSeleccionado = -1;
    private bool mostrarSugerenciasPPL;
    private string? bloqueReclusosHeredado;

    private string filtroModalPadre = string.Empty;
    private List<MaeDocumento> documentosPadreFiltrados = new();
    private readonly Dictionary<int, string> nombresOficinas = new();
    private readonly Dictionary<int, int> usoOficinas = new();
    private readonly Dictionary<int, string> nombresTipos = new();
    private readonly Dictionary<int, string> nombresEstados = new();
    private readonly Dictionary<long, string> indicesBusquedaPadre = new();
    private List<MaeDocumento> documentosDisponibles = new();
    private bool mostrarModalPadres;
    private int paginaPadreActual = 1;
    private int tamanoPaginaPadre = 10;
    private MaeDocumento? docPadreSeleccionado;
    private int? idOficinaBandejaEntrada;
    private int idOficinaUsuarioActual;
    private string nombreOficinaActualDoc = string.Empty;
    private bool soloTraerSinActuacion;
    private bool mostrarAvisoTextoSugeridoPadre;
    private bool paseConActuacionForzado => AutoPaseBandeja == true || AutoPaseDestino.HasValue;
    private string EtiquetaBotonPaseConActuacion => AutoPaseDestino.HasValue
        ? "Guardar y Enviar todo"
        : "Guardar y Traer todo";
    private string TipoYNumeroExpediente
    {
        get
        {
            var numero = docPadreSeleccionado?.NumeroOficial?.Trim();
            if (string.IsNullOrWhiteSpace(numero)) return "S/D";

            var tipo = NombreTipo(docPadreSeleccionado?.IdTipo);
            return string.IsNullOrWhiteSpace(tipo) ? numero : $"{tipo} {numero}";
        }
    }
    private string NombreOficinaDestinoPase
    {
        get
        {
            if (AutoPaseDestino.HasValue)
            {
                return NombreOficina(AutoPaseDestino.Value);
            }

            if (AutoPaseBandeja == true && idOficinaUsuarioActual > 0)
            {
                return NombreOficina(idOficinaUsuarioActual);
            }

            return "S/D";
        }
    }
    private string oficinaBusqueda = string.Empty;
    private List<CatOficina> oficinasFiltradas = new();
    private int indiceOficinaSeleccionada = -1;
    private bool esNumeracionAutomatica;
    private bool esNumeracionExterna;
    private bool esNumeracionManualInterna;
    private bool bloqueoPorRangoAgotado;
    private string mensajeNumeracion = string.Empty;
    private string serieNumeracionAutomatica = string.Empty;
    private int proximoNumeroAutomatico;
    private int anioNumeracionSeleccionado = DateTime.Now.Year;
    private MaeNumeracionRango? rangoManualInternoActivo;
    private int? numeroManualInterno;
    private const string EstiloPanelSugerencias = "z-index: 20; top: calc(100% + .25rem);";
    private ElementReference contenedorSugerenciasOficinaRef;
    private DotNetObjectReference<NuevoDocumento>? dotNetRef;
    private bool detectorClickRegistrado;
    private bool MostrarAccesoGestionRangos =>
        bloqueoPorRangoAgotado
        && string.Equals(mensajeNumeracion, "No hay rango configurado para el tipo de documento seleccionado.", StringComparison.Ordinal)
        && nuevoDoc.IdTipo > 0
        && nuevoDoc.IdOficinaActual > 0;

    protected override async Task OnInitializedAsync()
    {
        editContextNuevoDocumento = new EditContext(nuevoDoc);

        oficinas = await RepoOficinas.GetAllAsync();
        tipos = await RepoTipos.GetAllAsync();
        estados = await RepoEstados.GetAllAsync();
        reclusosActivos = (await RepoReclusos.GetAllAsync())
            .Where(r => r.Activo == true)
            .OrderBy(r => r.NombreCompleto)
            .ToList();

        foreach (var of in oficinas) if (!string.IsNullOrWhiteSpace(of.Nombre)) nombresOficinas[of.IdOficina] = of.Nombre;
        await CargarUsoOficinasAsync();
        foreach (var t in tipos) if (!string.IsNullOrWhiteSpace(t.Nombre)) nombresTipos[t.IdTipo] = t.Nombre;
        foreach (var e in estados) if (!string.IsNullOrWhiteSpace(e.Nombre)) nombresEstados[e.IdEstado] = e.Nombre;

        documentosDisponibles = (await RepoDocs.GetAllAsync()).OrderByDescending(d => d.FechaCreacion).ToList();
        foreach (var doc in documentosDisponibles) indicesBusquedaPadre[doc.IdDocumento] = ConstruirIndiceBusquedaPadre(doc);
        RecalcularDocumentosPadreFiltrados();

        if (estados.Any()) nuevoDoc.IdEstadoActual = estados.First().IdEstado;
        nuevoDoc.IdHiloConversacion = Guid.NewGuid();
        idOficinaBandejaEntrada = oficinas.FirstOrDefault(o => o.Nombre.Contains("BANDEJA DE ENTRADA", StringComparison.OrdinalIgnoreCase))?.IdOficina;

        var authState = await (AuthStateTask ?? Task.FromResult(new AuthenticationState(new ClaimsPrincipal())));
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var uid = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(uid, out var idU)) nuevoDoc.IdUsuarioCreador = idU;
            var oid = user.FindFirst("IdOficina")?.Value;
            if (int.TryParse(oid, out var idO)) { idOficinaUsuarioActual = idO; nuevoDoc.IdOficinaActual = idO; }
        }

        oficinaBusqueda = string.Empty;

        if (IdPadre.HasValue)
        {
            var padre = documentosDisponibles.FirstOrDefault(d => d.IdDocumento == IdPadre.Value);
            if (padre != null)
            {
                esActuacion = true;
                docPadreSeleccionado = padre;
                nuevoDoc.IdDocumentoPadre = padre.IdDocumento;
                nuevoDoc.IdHiloConversacion = padre.IdHiloConversacion;
                nuevoDoc.IdOficinaActual = padre.IdOficinaActual;
                bloqueReclusosHeredado = ExtraerBloqueReclusos(padre.Asunto);
                nombreOficinaActualDoc = NombreOficina(padre.IdOficinaActual);
                oficinaBusqueda = nombreOficinaActualDoc;
                var tM = tipos.FirstOrDefault(t => t.Nombre.Contains("Memorando", StringComparison.OrdinalIgnoreCase));
                if (tM != null) nuevoDoc.IdTipo = tM.IdTipo;
                if (paseConActuacionForzado)
                {
                    soloTraerSinActuacion = false;
                    nuevoDoc.Asunto = padre.Asunto?.Trim() ?? string.Empty;
                    nuevoDoc.Descripcion = padre.Descripcion;
                    mostrarAvisoTextoSugeridoPadre = !string.IsNullOrWhiteSpace(nuevoDoc.Asunto)
                        || !string.IsNullOrWhiteSpace(nuevoDoc.Descripcion);
                }
            }
        }

        // Si hay un tipo seleccionado (ej. Memorando por defecto en actuación), calculamos el vencimiento inicial
        if (nuevoDoc.IdTipo > 0)
        {
            await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo);
            await CalcularVencimientoAsync(nuevoDoc.IdTipo);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || detectorClickRegistrado)
        {
            return;
        }

        var funcionRegistroDisponible = await JS.InvokeAsync<string>("eval", "typeof window.registrarOcultarSugerenciasOficina") == "function";
        if (!funcionRegistroDisponible)
        {
            return;
        }

        dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("registrarOcultarSugerenciasOficina", contenedorSugerenciasOficinaRef, dotNetRef);
        detectorClickRegistrado = true;
    }

    // Cómputo de plazos centralizado en DocumentoPlazosService.
    private async Task CalcularVencimientoAsync(int idTipo)
    {
        var fechaBase = DateTime.Today.AddDays(1);
        nuevoDoc.FechaVencimiento = await DocumentoPlazosService.CalcularFechaVencimientoAsync(idTipo, fechaBase)
            ?? DocumentoPlazosService.CalcularFechaVencimiento(fechaBase, 10);
    }

    private IEnumerable<MaeDocumento> DocumentosPadrePaginados => documentosPadreFiltrados.Skip((PaginaPadreEfectiva - 1) * tamanoPaginaPadre).Take(tamanoPaginaPadre);
    private int TotalRegistrosPadre => documentosPadreFiltrados.Count;
    private int TotalPaginasPadre => Math.Max(1, (int)Math.Ceiling(TotalRegistrosPadre / (double)tamanoPaginaPadre));
    private int PaginaPadreEfectiva => Math.Min(paginaPadreActual, TotalPaginasPadre);
    private int DesdeRegistroPadre => TotalRegistrosPadre == 0 ? 0 : ((PaginaPadreEfectiva - 1) * tamanoPaginaPadre) + 1;
    private int HastaRegistroPadre => Math.Min(PaginaPadreEfectiva * tamanoPaginaPadre, TotalRegistrosPadre);

    private void AbrirModalPadres() => mostrarModalPadres = true;
    private void CerrarModalPadres() => mostrarModalPadres = false;
    private string FiltroModalPadre { get => filtroModalPadre; set { if (filtroModalPadre == value) return; filtroModalPadre = value; paginaPadreActual = 1; RecalcularDocumentosPadreFiltrados(); } }
    private void PaginaPadreAnterior() { if (PaginaPadreEfectiva > 1) paginaPadreActual--; }
    private void PaginaPadreSiguiente() { if (PaginaPadreEfectiva < TotalPaginasPadre) paginaPadreActual++; }
    private void SeleccionarPadreDesdeModal(MaeDocumento p) { SeleccionarPadre(p); mostrarModalPadres = false; }
    private void SeleccionarPadre(MaeDocumento p) { docPadreSeleccionado = p; nuevoDoc.IdDocumentoPadre = p.IdDocumento; nuevoDoc.IdHiloConversacion = p.IdHiloConversacion; }
    private void QuitarVinculo() { docPadreSeleccionado = null; nuevoDoc.IdDocumentoPadre = null; nuevoDoc.IdHiloConversacion = Guid.NewGuid(); }

    private async Task Guardar()
    {
        errorGuardar = null;
        try
        {
            if (esActuacion)
            {
                nuevoDoc.Asunto = ConstruirAsuntoConReclusos(nuevoDoc.Asunto, bloqueReclusosHeredado);
            }

            if (esActuacion && soloTraerSinActuacion && docPadreSeleccionado != null)
            {
                if (!idOficinaBandejaEntrada.HasValue) { errorGuardar = "Error: No se encontró la Bandeja de Entrada."; return; }
                await MoverFamiliaADestino(docPadreSeleccionado.IdHiloConversacion, idOficinaBandejaEntrada.Value, "Traslado de familia sin actuación");
                Navegador.NavigateTo("documentos"); return;
            }

            if (string.IsNullOrWhiteSpace(nuevoDoc.Asunto)) { errorGuardar = "Asunto obligatorio."; return; }
            if (nuevoDoc.IdTipo <= 0) { errorGuardar = "Debe seleccionar un tipo de documento."; return; }
            if (nuevoDoc.IdOficinaActual <= 0) { errorGuardar = "Debe seleccionar una oficina válida."; return; }
            if (esNumeracionAutomatica)
            {
                var res = await RangoService.ConsumirSiguienteNumeroAsync(nuevoDoc.IdTipo, nuevoDoc.IdOficinaActual, anioNumeracionSeleccionado);
                if (!res.Exitoso) { errorGuardar = res.Mensaje; return; }
                nuevoDoc.NumeroOficial = res.Data?.UltimoUtilizado.ToString();
            }
            else if (esNumeracionManualInterna)
            {
                if (!numeroManualInterno.HasValue) { errorGuardar = "Número oficial obligatorio."; return; }
                nuevoDoc.NumeroOficial = numeroManualInterno.Value.ToString();
            }

            // Si FechaVencimiento es nula (caso raro), recalculamos por seguridad.
            if (!nuevoDoc.FechaVencimiento.HasValue)
            {
                await CalcularVencimientoAsync(nuevoDoc.IdTipo);
            }

            await using var trans = await DbContext.Database.BeginTransactionAsync();
            try
            {
                await RepoDocs.AddAsync(nuevoDoc);
                await RepoMovimientos.AddAsync(new TraMovimiento { IdDocumento = nuevoDoc.IdDocumento, IdOficinaOrigen = nuevoDoc.IdOficinaActual, IdOficinaDestino = nuevoDoc.IdOficinaActual, FechaMovimiento = DateTime.Now, IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador, ObservacionPase = esActuacion ? "Actuación agregada" : "Documento creado" });

                if (AutoPaseBandeja == true) await MoverFamiliaADestino(nuevoDoc.IdHiloConversacion, idOficinaUsuarioActual, "Traslado automático retorno");
                else if (AutoPaseDestino.HasValue) await MoverFamiliaADestino(nuevoDoc.IdHiloConversacion, AutoPaseDestino.Value, "Traslado automático destino");
                else if (!esActuacion
                    && idOficinaBandejaEntrada.HasValue
                    && nuevoDoc.IdOficinaActual != idOficinaBandejaEntrada.Value)
                {
                    await MoverFamiliaADestino(
                        nuevoDoc.IdHiloConversacion,
                        idOficinaBandejaEntrada.Value,
                        "Ingreso automático a bandeja de entrada");
                }

                await trans.CommitAsync(); Navegador.NavigateTo("documentos");
            }
            catch { await trans.RollbackAsync(); throw; }
        }
        catch (Exception ex) { errorGuardar = ex.Message; await JS.InvokeVoidAsync("window.scrollTo", 0, 0); }
    }

    private Task IgnorarSubmitNuevoDocumento(EditContext _) => Task.CompletedTask;
    private async Task GuardarDesdeBotonAsync() { if (editContextNuevoDocumento.Validate()) await Guardar(); }

    private async Task MoverFamiliaADestino(Guid hilo, int destino, string obs)
    {
        var fam = (await RepoDocs.GetAllAsync()).Where(d => d.IdHiloConversacion == hilo).ToList();
        foreach (var d in fam)
        {
            if (d.IdOficinaActual == destino) continue;
            await RepoMovimientos.AddAsync(new TraMovimiento { IdDocumento = d.IdDocumento, IdOficinaOrigen = d.IdOficinaActual, IdOficinaDestino = destino, FechaMovimiento = DateTime.Now, IdUsuarioResponsable = nuevoDoc.IdUsuarioCreador, ObservacionPase = obs });
            d.IdOficinaActual = destino; await RepoDocs.UpdateAsync(d);
        }
    }

    private async Task OnTipoDocumentoChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var idT))
        {
            nuevoDoc.IdTipo = idT;
            // 1. Numeración Automática
            await EvaluarNumeracionAutomaticaAsync(idT);
            // 2. Cálculo de Vencimiento (Decreto 500)
            await CalcularVencimientoAsync(idT);
        }
    }

    private async Task EvaluarNumeracionAutomaticaAsync(int idT)
    {
        esNumeracionAutomatica = esNumeracionExterna = esNumeracionManualInterna = bloqueoPorRangoAgotado = false;
        mensajeNumeracion = string.Empty;
        rangoManualInternoActivo = null;
        var ofi = oficinas.FirstOrDefault(o => o.IdOficina == nuevoDoc.IdOficinaActual);
        if (ofi?.EsExterna == true) { esNumeracionExterna = true; return; }
        var rango = await RangoService.ObtenerRangoActivoAsync(idT, nuevoDoc.IdOficinaActual, anioNumeracionSeleccionado);
        if (rango != null && idOficinaBandejaEntrada == nuevoDoc.IdOficinaActual) { esNumeracionAutomatica = true; serieNumeracionAutomatica = rango.NombreRango; proximoNumeroAutomatico = rango.UltimoUtilizado + 1; }
        else if (rango != null) { esNumeracionManualInterna = true; rangoManualInternoActivo = rango; }
        else { bloqueoPorRangoAgotado = true; mensajeNumeracion = "No hay rango configurado para el tipo de documento seleccionado."; }
    }

    private async Task OnAnioNumeracionChanged() { if (nuevoDoc.IdTipo > 0) await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo); }

    private void AbrirGestionRangosConContexto()
    {
        if (!MostrarAccesoGestionRangos) return;
        var destino = $"/configuracion/rangos?tipo={nuevoDoc.IdTipo}&oficina={nuevoDoc.IdOficinaActual}&anio={anioNumeracionSeleccionado}";
        Navegador.NavigateTo(destino);
    }

    private void FiltrarOficinas(ChangeEventArgs e)
    {
        oficinaBusqueda = e.Value?.ToString() ?? "";
        indiceOficinaSeleccionada = -1;
        nuevoDoc.IdOficinaActual = 0;
        mensajeNumeracion = string.Empty;
        esNumeracionAutomatica = false;
        esNumeracionManualInterna = false;
        esNumeracionExterna = false;
        bloqueoPorRangoAgotado = false;
        rangoManualInternoActivo = null;
        numeroManualInterno = null;
        oficinasFiltradas = BuscarOficinas(oficinaBusqueda).Take(8).ToList();
    }

    private async Task SeleccionarOficina(CatOficina o) { nuevoDoc.IdOficinaActual = o.IdOficina; oficinaBusqueda = o.Nombre; oficinasFiltradas.Clear(); if (nuevoDoc.IdTipo > 0) await EvaluarNumeracionAutomaticaAsync(nuevoDoc.IdTipo); }
    private void MostrarSugerenciasOficina()
    {
        oficinasFiltradas = string.IsNullOrWhiteSpace(oficinaBusqueda)
            ? oficinas.OrderByDescending(o => usoOficinas.GetValueOrDefault(o.IdOficina)).ThenBy(o => o.Nombre).Take(8).ToList()
            : BuscarOficinas(oficinaBusqueda).Take(8).ToList();
    }

    private async Task ManejarTecladoOficinas(KeyboardEventArgs e)
    {
        if (e.Key == "ArrowDown") indiceOficinaSeleccionada = Math.Min(indiceOficinaSeleccionada + 1, oficinasFiltradas.Count - 1);
        else if (e.Key == "ArrowUp") indiceOficinaSeleccionada = Math.Max(indiceOficinaSeleccionada - 1, 0);
        else if (e.Key == "Enter" && indiceOficinaSeleccionada >= 0) await SeleccionarOficina(oficinasFiltradas[indiceOficinaSeleccionada]);
        else if (e.Key == "Escape") OcultarSugerenciasOficina();
    }

    [JSInvokable]
    public void OcultarSugerenciasOficina()
    {
        if (!oficinasFiltradas.Any())
        {
            return;
        }

        oficinasFiltradas.Clear();
        indiceOficinaSeleccionada = -1;
        StateHasChanged();
    }

    private async Task CargarUsoOficinasAsync()
    {
        var movimientos = await DbContext.TraMovimientos
            .AsNoTracking()
            .Select(m => new { m.IdOficinaOrigen, m.IdOficinaDestino })
            .ToListAsync();

        usoOficinas.Clear();
        foreach (var movimiento in movimientos)
        {
            SumarUsoOficina(movimiento.IdOficinaOrigen);
            SumarUsoOficina(movimiento.IdOficinaDestino);
        }
    }

    private void SumarUsoOficina(int? idOficina)
    {
        if (!idOficina.HasValue || idOficina.Value <= 0) return;
        usoOficinas[idOficina.Value] = usoOficinas.GetValueOrDefault(idOficina.Value) + 1;
    }

    private IEnumerable<CatOficina> BuscarOficinas(string t)
    {
        if (string.IsNullOrWhiteSpace(t))
        {
            return oficinas
                .OrderByDescending(o => usoOficinas.GetValueOrDefault(o.IdOficina))
                .ThenBy(o => o.Nombre);
        }

        return oficinas
            .Where(o => o.Nombre.Contains(t, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(o => PuntajeCoincidencia(o.Nombre, t))
            .ThenByDescending(o => usoOficinas.GetValueOrDefault(o.IdOficina))
            .ThenBy(o => o.Nombre);
    }

    private static int PuntajeCoincidencia(string? nombreOficina, string termino)
    {
        if (string.IsNullOrWhiteSpace(nombreOficina)) return 0;
        if (nombreOficina.Equals(termino, StringComparison.OrdinalIgnoreCase)) return 3;
        if (nombreOficina.StartsWith(termino, StringComparison.OrdinalIgnoreCase)) return 2;
        return 1;
    }
    private string ConstruirIndiceBusquedaPadre(MaeDocumento d) => $"{d.NumeroOficial} {d.Asunto} {d.Descripcion}";
    private void RecalcularDocumentosPadreFiltrados() => documentosPadreFiltrados = string.IsNullOrWhiteSpace(filtroModalPadre) ? documentosDisponibles : documentosDisponibles.Where(d => indicesBusquedaPadre[d.IdDocumento].Contains(filtroModalPadre, StringComparison.OrdinalIgnoreCase)).ToList();

    private string NombreOficina(int id) => nombresOficinas.GetValueOrDefault(id) ?? "S/D";
    private string NombreTipo(int? idTipo) => idTipo.HasValue ? nombresTipos.GetValueOrDefault(idTipo.Value) ?? string.Empty : string.Empty;
    private async Task AjustarScrollSugerenciaAsync(ElementReference r, int i) => await JS.InvokeVoidAsync("scrollSugerenciaVisible", r, i);

    private void FiltrarReclusosAsunto(ChangeEventArgs e)
    {
        busquedaReclusoAsunto = e.Value?.ToString() ?? "";
        var busquedaNormalizada = NormalizarTextoBusqueda(busquedaReclusoAsunto);
        reclusosFiltradosAsunto = reclusosActivos
            .Where(r => NormalizarTextoBusqueda(r.NombreCompleto).Contains(busquedaNormalizada, StringComparison.OrdinalIgnoreCase))
            .Take(8)
            .ToList();
        mostrarSugerenciasPPL = true;
    }

    private static string NormalizarTextoBusqueda(string? texto)
    {
        if (string.IsNullOrWhiteSpace(texto)) return string.Empty;

        var textoNormalizado = texto.Normalize(NormalizationForm.FormD);
        var builder = new StringBuilder(textoNormalizado.Length);

        foreach (var c in textoNormalizado)
        {
            if (CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
            {
                builder.Append(c);
            }
        }

        return builder.ToString().Normalize(NormalizationForm.FormC);
    }

    private void MostrarSugerenciasPPL() => FiltrarReclusosAsunto(new ChangeEventArgs { Value = busquedaReclusoAsunto });
    private async Task OcultarSugerenciasPPLAsync()
    {
        await Task.Delay(150);
        mostrarSugerenciasPPL = false;
    }

    private Task ManejarTecladoPPL(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && indicePPLSeleccionado >= 0) AgregarReclusoAsunto(reclusosFiltradosAsunto[indicePPLSeleccionado]);
        return Task.CompletedTask;
    }
    private void AgregarReclusoAsunto(MaeRecluso r) { if (!reclusosSeleccionadosAsunto.Any(s => s.IdRecluso == r.IdRecluso)) reclusosSeleccionadosAsunto.Add(r); busquedaReclusoAsunto = ""; reclusosFiltradosAsunto.Clear(); mostrarSugerenciasPPL = false; }
    private void QuitarReclusoAsunto(int id) => reclusosSeleccionadosAsunto.RemoveAll(r => r.IdRecluso == id);
    private void LimpiarReclusosAsunto() => reclusosSeleccionadosAsunto.Clear();
    private void InsertarReclusosEnAsunto() { if (reclusosSeleccionadosAsunto.Any()) nuevoDoc.Asunto += $" | PPL(s): {string.Join(", ", reclusosSeleccionadosAsunto.Select(r => r.NombreCompleto))}"; }

    private static string? ExtraerBloqueReclusos(string? asunto)
    {
        if (string.IsNullOrWhiteSpace(asunto)) return null;

        const string marcador = " | PPL(s): ";
        var indice = asunto.IndexOf(marcador, StringComparison.OrdinalIgnoreCase);
        return indice < 0 ? null : asunto[indice..].Trim();
    }

    private static string ConstruirAsuntoConReclusos(string? asuntoIngresado, string? bloqueReclusos)
    {
        if (string.IsNullOrWhiteSpace(bloqueReclusos)) return asuntoIngresado?.Trim() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(asuntoIngresado)) return bloqueReclusos;
        if (asuntoIngresado.Contains("| PPL(s):", StringComparison.OrdinalIgnoreCase)) return asuntoIngresado.Trim();

        return $"{asuntoIngresado.Trim()} {bloqueReclusos}";
    }

    public async ValueTask DisposeAsync()
    {
        if (detectorClickRegistrado)
        {
            await JS.InvokeVoidAsync("desregistrarOcultarSugerenciasOficina", contenedorSugerenciasOficinaRef);
        }

        dotNetRef?.Dispose();
    }
}
