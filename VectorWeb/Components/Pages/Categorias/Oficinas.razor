@page "/configuracion/oficinas"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "configuracion.catalogos")]
@using Microsoft.EntityFrameworkCore
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<CatOficina> RepoOficina
@inject SecretariaDbContext DbContext
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>Gestión de Oficinas</h3>

@if (!string.IsNullOrWhiteSpace(mensajeError))
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @mensajeError
        <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(mensajeExito))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @mensajeExito
        <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
    </div>
}

<div class="row mb-3 g-2 align-items-center">
    <div class="col-md-4">
        <input type="text" class="form-control" placeholder="Buscar oficina..." @bind="busquedaOficina" @bind:event="oninput" />
    </div>
    <div class="col-md-4">
        <input type="text" class="form-control" placeholder="Nombre de nueva oficina..." @bind="nuevaOficinaNombre" />
    </div>
    <div class="col-auto">
        <button class="btn btn-success" @onclick="AgregarOficina">
            <i class="bi bi-plus-lg"></i> Agregar
        </button>
    </div>
    <div class="col-auto ms-auto">
        <button class="btn btn-primary" @onclick="AbrirModalUnificacion">
            <i class="bi bi-intersect"></i> Unificar Duplicados
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var oficina in OficinasFiltradas)
            {
                <tr>
                    <td><span class="badge bg-secondary">@oficina.IdOficina</span></td>
                    <td>
                        @if (oficinaEditandoId == oficina.IdOficina)
                        {
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" @bind="nombreEdicion" />
                                <button class="btn btn-success" @onclick="() => GuardarEdicion(oficina)"><i class="bi bi-check"></i></button>
                                <button class="btn btn-outline-secondary" @onclick="CancelarEdicion"><i class="bi bi-x"></i></button>
                            </div>
                        }
                        else
                        {
                            @oficina.Nombre
                        }
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" checked="@(oficina.EsExterna == true)" @onchange="(e) => CambiarTipoOficina(oficina, e)" />
                            <label class="form-check-label small text-muted">@(oficina.EsExterna == true ? "Externa" : "Interna")</label>
                        </div>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm me-1" @onclick="() => IniciarEdicion(oficina)">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @onclick="() => Eliminar(oficina.IdOficina)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* --- MODAL DE UNIFICACIÓN --- *@
@if (mostrarModalUnificacion)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Unificar Oficinas Duplicadas</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle-fill me-1"></i>
                        Esta acción moverá todos los documentos, movimientos y usuarios de las oficinas "A Eliminar" hacia la "Oficina Principal".
                        <strong>Las oficinas duplicadas serán borradas permanentemente.</strong>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-success">1. Seleccione la Oficina Principal (La que quedará)</label>
                        <select class="form-select border-success" @bind="idOficinaMaestra">
                            <option value="0">-- Seleccione la correcta --</option>
                            @foreach (var ofi in listaOficinas.OrderBy(o => o.Nombre))
                            {
                                <option value="@ofi.IdOficina">@ofi.Nombre (ID: @ofi.IdOficina)</option>
                            }
                        </select>
                    </div>

                    @if (idOficinaMaestra > 0)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold text-danger">2. Seleccione las oficinas duplicadas (Se eliminarán)</label>
                            <input type="text" class="form-control mb-2 form-control-sm" placeholder="Filtrar lista..." @bind="filtroModal" @bind:event="oninput" />

                            <div class="border rounded p-2 bg-light" style="max-height: 250px; overflow-y: auto;">
                                @foreach (var ofi in listaOficinas.Where(o => o.IdOficina != idOficinaMaestra && (string.IsNullOrEmpty(filtroModal) || o.Nombre.Contains(filtroModal, StringComparison.OrdinalIgnoreCase))))
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               id="chk_@ofi.IdOficina"
                                               checked="@idsDuplicados.Contains(ofi.IdOficina)"
                                               @onchange="(e) => ToggleDuplicado(ofi.IdOficina, e)">
                                        <label class="form-check-label" for="chk_@ofi.IdOficina">
                                            @ofi.Nombre <span class="text-muted small">(ID: @ofi.IdOficina)</span>
                                        </label>
                                    </div>
                                }
                            </div>
                            <div class="form-text mt-1">
                                Seleccionadas para borrar: <strong>@idsDuplicados.Count</strong>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-danger"
                            disabled="@(idOficinaMaestra == 0 || idsDuplicados.Count == 0 || procesandoUnificacion)"
                            @onclick="EjecutarUnificacion">
                        @if (procesandoUnificacion)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-intersect me-1"></i> Confirmar Unificación
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CatOficina> listaOficinas = new();
    private string nuevaOficinaNombre = string.Empty;
    private string busquedaOficina = string.Empty;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;

    // Estado Edición Rápida
    private int oficinaEditandoId = 0;
    private string nombreEdicion = string.Empty;

    // Estado Unificación
    private bool mostrarModalUnificacion = false;
    private int idOficinaMaestra = 0;
    private HashSet<int> idsDuplicados = new();
    private string filtroModal = string.Empty;
    private bool procesandoUnificacion = false;

    private IEnumerable<CatOficina> OficinasFiltradas
    {
        get
        {
            if (string.IsNullOrWhiteSpace(busquedaOficina)) return listaOficinas;
            var tokens = busquedaOficina.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            return listaOficinas.Where(oficina =>
            {
                var nombre = oficina.Nombre?.Trim() ?? string.Empty;
                return tokens.All(token => nombre.Contains(token, StringComparison.OrdinalIgnoreCase));
            });
        }
    }

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar()
    {
        listaOficinas = (await RepoOficina.GetAllAsync()).OrderBy(o => o.Nombre).ToList();
    }

    private async Task AgregarOficina()
    {
        if (!string.IsNullOrWhiteSpace(nuevaOficinaNombre))
        {
            mensajeError = string.Empty;
            // CORREGIDO: Eliminada la propiedad 'Activo'
            await RepoOficina.AddAsync(new CatOficina { Nombre = nuevaOficinaNombre.Trim(), EsExterna = false });
            nuevaOficinaNombre = string.Empty;
            mensajeExito = "Oficina agregada.";
            await Cargar();
        }
    }

    private async Task CambiarTipoOficina(CatOficina oficina, ChangeEventArgs e)
    {
        if (oficina is null) return;
        oficina.EsExterna = (e.Value is bool b && b);
        await RepoOficina.UpdateAsync(oficina);
        // No recargamos todo para mantener el estado visual suave
    }

    // --- EDICIÓN DE NOMBRE ---
    private void IniciarEdicion(CatOficina oficina)
    {
        oficinaEditandoId = oficina.IdOficina;
        nombreEdicion = oficina.Nombre;
    }

    private void CancelarEdicion()
    {
        oficinaEditandoId = 0;
        nombreEdicion = string.Empty;
    }

    private async Task GuardarEdicion(CatOficina oficina)
    {
        if (!string.IsNullOrWhiteSpace(nombreEdicion))
        {
            oficina.Nombre = nombreEdicion;
            await RepoOficina.UpdateAsync(oficina);
            oficinaEditandoId = 0;
            mensajeExito = "Nombre actualizado.";
        }
    }

    // --- ELIMINACIÓN SEGURA ---
    private async Task Eliminar(int id)
    {
        var oficina = listaOficinas.FirstOrDefault(o => o.IdOficina == id);
        if (oficina is null) return;

        // Validaciones Manuales para dar feedback claro
        var tieneDocumentos = await DbContext.MaeDocumentos.AsNoTracking().AnyAsync(d => d.IdOficinaActual == id);
        var tieneMovs = await DbContext.TraMovimientos.AsNoTracking().AnyAsync(m => m.IdOficinaOrigen == id || m.IdOficinaDestino == id);
        var tieneUsers = await DbContext.CatUsuarios.AsNoTracking().AnyAsync(u => u.IdOficina == id);
        var tieneRangos = await DbContext.MaeNumeracionRangos.AsNoTracking().AnyAsync(n => n.IdOficina == id);

        if (tieneDocumentos || tieneMovs || tieneUsers || tieneRangos)
        {
            mensajeError = $"No se puede eliminar '{oficina.Nombre}'. Tiene datos asociados. Use la función 'Unificar' si es un duplicado.";
            return;
        }

        if (await JS.InvokeAsync<bool>("confirm", $"¿Eliminar '{oficina.Nombre}'?"))
        {
            await RepoOficina.DeleteAsync(id);
            mensajeExito = "Oficina eliminada.";
            await Cargar();
        }
    }

    // --- LÓGICA DE UNIFICACIÓN (SQL PURO) ---
    private void AbrirModalUnificacion()
    {
        idOficinaMaestra = 0;
        idsDuplicados.Clear();
        filtroModal = string.Empty;
        mostrarModalUnificacion = true;
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
    }

    private void CerrarModal() => mostrarModalUnificacion = false;

    private void ToggleDuplicado(int id, ChangeEventArgs e)
    {
        if (e.Value is bool check && check) idsDuplicados.Add(id);
        else idsDuplicados.Remove(id);
    }

    private async Task EjecutarUnificacion()
    {
        if (idOficinaMaestra == 0 || idsDuplicados.Count == 0) return;

        procesandoUnificacion = true;

        using var transaccion = await DbContext.Database.BeginTransactionAsync();
        try
        {
            var idsString = string.Join(",", idsDuplicados);

            // 1. Mover Documentos (Ubicación Actual)
            await DbContext.Database.ExecuteSqlRawAsync(
                $"UPDATE Mae_Documento SET IdOficinaActual = {idOficinaMaestra} WHERE IdOficinaActual IN ({idsString})");

            // 2. Mover Historial (Origen)
            await DbContext.Database.ExecuteSqlRawAsync(
                $"UPDATE Tra_Movimiento SET IdOficinaOrigen = {idOficinaMaestra} WHERE IdOficinaOrigen IN ({idsString})");

            // 3. Mover Historial (Destino)
            await DbContext.Database.ExecuteSqlRawAsync(
                $"UPDATE Tra_Movimiento SET IdOficinaDestino = {idOficinaMaestra} WHERE IdOficinaDestino IN ({idsString})");

            // 4. Mover Usuarios
            await DbContext.Database.ExecuteSqlRawAsync(
                $"UPDATE Cat_Usuario SET IdOficina = {idOficinaMaestra} WHERE IdOficina IN ({idsString})");

            // 5. Mover Rangos de Numeración (CORREGIDO: Nombre en Plural)
            await DbContext.Database.ExecuteSqlRawAsync(
                $"UPDATE Mae_NumeracionRangos SET IdOficina = {idOficinaMaestra} WHERE IdOficina IN ({idsString})");

            // 6. Finalmente, eliminar las duplicadas
            await DbContext.Database.ExecuteSqlRawAsync(
                $"DELETE FROM Cat_Oficina WHERE IdOficina IN ({idsString})");

            await transaccion.CommitAsync();

            mensajeExito = "Unificación completada correctamente.";
            mostrarModalUnificacion = false;
            await Cargar();
        }
        catch (Exception ex)
        {
            await transaccion.RollbackAsync();
            mensajeError = $"Error al unificar: {ex.Message}";
        }
        finally
        {
            procesandoUnificacion = false;
        }
    }
}
