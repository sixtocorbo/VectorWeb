@page "/configuracion/oficinas"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "configuracion.catalogos")]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Web
@using VectorWeb.Models
@using VectorWeb.Repositories
@inject IRepository<CatOficina> RepoOficina
@inject SecretariaDbContext DbContext
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1 text-primary fw-bold">Gestión de Oficinas</h3>
            <p class="text-muted small mb-0">Administre el catálogo de oficinas y resuelva duplicados.</p>
        </div>
        <button class="btn btn-primary shadow-sm" @onclick="AbrirModalUnificacion">
            <i class="bi bi-intersect me-2"></i>Unificar Duplicados
        </button>
    </div>

    @* --- SECCIÓN DE MENSAJES --- *@
    @if (!string.IsNullOrWhiteSpace(mensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-octagon-fill me-2"></i> @mensajeError
            <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(mensajeExito))
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @mensajeExito
            <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
        </div>
    }

    @* --- FILTROS Y ALTA --- *@
    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-muted">Buscar</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0 shadow-none" placeholder="Filtrar lista..." @bind="busquedaOficina" @bind:event="oninput" />
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label fw-bold small text-uppercase text-muted">Nombre de nueva oficina</label>
                    <input type="text" class="form-control shadow-none" placeholder="Ej. Dirección de Finanzas" @bind="nuevaOficinaNombre" />
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100 fw-bold shadow-sm" @onclick="AgregarOficina">
                        <i class="bi bi-plus-lg me-2"></i>Agregar Oficina
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* --- TABLA PRINCIPAL --- *@
    <div class="card shadow-sm border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 80px;" class="text-center">ID</th>
                        <th>Nombre de la Oficina</th>
                        <th style="width: 160px;">Tipo</th>
                        <th style="width: 280px;" class="text-end px-4">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var oficina in OficinasFiltradas)
                    {
                        <tr class="@(oficinaEditandoId == oficina.IdOficina ? "table-primary table-opacity-10" : "")">
                            <td class="text-center">
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border">@oficina.IdOficina</span>
                            </td>
                            <td>
                                @if (oficinaEditandoId == oficina.IdOficina)
                                {
                                    <div class="input-group input-group-sm w-100 shadow-sm">
                                        <input type="text" class="form-control border-primary"
                                               @bind="nombreEdicion"
                                               @onkeyup="(e) => GuardarEdicionConEnter(e, oficina)" />
                                        <button class="btn btn-success px-3" @onclick="() => GuardarEdicion(oficina)">
                                            <i class="bi bi-check-lg me-1"></i> Guardar
                                        </button>
                                        <button class="btn btn-light border px-3" @onclick="CancelarEdicion">
                                            <i class="bi bi-x me-1"></i> Cancelar
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span class="fw-medium">@oficina.Nombre</span>
                                }
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="sw_@oficina.IdOficina"
                                           checked="@(oficina.EsExterna == true)" @onchange="(e) => CambiarTipoOficina(oficina, e)" />
                                    <label class="form-check-label small text-muted" for="sw_@oficina.IdOficina">
                                        @(oficina.EsExterna == true ? "Externa" : "Interna")
                                    </label>
                                </div>
                            </td>
                            <td class="text-end px-4">
                                @if (oficinaEditandoId != oficina.IdOficina)
                                {
                                    <div class="d-flex justify-content-end gap-2">
                                        <button class="btn btn-outline-primary btn-sm px-3" @onclick="() => IniciarEdicion(oficina)">
                                            <i class="bi bi-pencil me-1"></i> Editar
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm px-3" @onclick="() => Eliminar(oficina.IdOficina)">
                                            <i class="bi bi-trash me-1"></i> Eliminar
                                        </button>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* --- MODAL DE UNIFICACIÓN --- *@
@if (mostrarModalUnificacion)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-intersect me-2"></i>Unificar Oficinas</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info border-0 shadow-sm small mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Esta acción moverá documentos, movimientos y usuarios a la oficina principal.
                        <strong>Los duplicados se eliminarán permanentemente.</strong>
                    </div>

                    <div class="mb-4 text-start">
                        <label class="form-label fw-bold text-success">1. Oficina Principal (La que prevalece)</label>
                        <select class="form-select border-success shadow-none" @bind="idOficinaMaestra">
                            <option value="0">-- Seleccione la oficina correcta --</option>
                            @foreach (var ofi in listaOficinas.OrderBy(o => o.Nombre))
                            {
                                <option value="@ofi.IdOficina">@ofi.Nombre (ID: @ofi.IdOficina)</option>
                            }
                        </select>
                    </div>

                    @if (idOficinaMaestra > 0)
                    {
                        <div class="mb-3 text-start animate__animated animate__fadeIn">
                            <label class="form-label fw-bold text-danger">2. Seleccione duplicados a eliminar</label>
                            <input type="text" class="form-control form-control-sm mb-2 shadow-none" placeholder="Filtrar por nombre..." @bind="filtroModal" @bind:event="oninput" />

                            <div class="border rounded bg-white p-2" style="max-height: 200px; overflow-y: auto;">
                                @foreach (var ofi in listaOficinas.Where(o => o.IdOficina != idOficinaMaestra && (string.IsNullOrEmpty(filtroModal) || o.Nombre.Contains(filtroModal, StringComparison.OrdinalIgnoreCase))))
                                {
                                    <div class="form-check py-1 border-bottom border-light">
                                        <input class="form-check-input" type="checkbox" id="chk_@ofi.IdOficina"
                                               checked="@idsDuplicados.Contains(ofi.IdOficina)"
                                               @onchange="(e) => ToggleDuplicado(ofi.IdOficina, e)">
                                        <label class="form-check-label d-flex justify-content-between pe-2" for="chk_@ofi.IdOficina">
                                            <span>@ofi.Nombre</span>
                                            <span class="text-muted small">ID: @ofi.IdOficina</span>
                                        </label>
                                    </div>
                                }
                            </div>
                            <div class="form-text mt-2 text-end">
                                Seleccionadas para borrar: <span class="badge bg-danger">@idsDuplicados.Count</span>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-secondary px-4" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-danger px-4 shadow-sm"
                            disabled="@(idOficinaMaestra == 0 || idsDuplicados.Count == 0 || procesandoUnificacion)"
                            @onclick="EjecutarUnificacion">
                        @if (procesandoUnificacion)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="bi bi-intersect me-2"></i>
                        }
                        Confirmar Unificación
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CatOficina> listaOficinas = new();
    private string nuevaOficinaNombre = string.Empty;
    private string busquedaOficina = string.Empty;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;

    // Estado Edición
    private int oficinaEditandoId = 0;
    private string nombreEdicion = string.Empty;

    // Estado Unificación
    private bool mostrarModalUnificacion = false;
    private int idOficinaMaestra = 0;
    private HashSet<int> idsDuplicados = new();
    private string filtroModal = string.Empty;
    private bool procesandoUnificacion = false;

    private IEnumerable<CatOficina> OficinasFiltradas
    {
        get
        {
            if (string.IsNullOrWhiteSpace(busquedaOficina)) return listaOficinas;
            var tokens = busquedaOficina.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            return listaOficinas.Where(oficina =>
            {
                var nombre = oficina.Nombre?.Trim() ?? string.Empty;
                return tokens.All(token => nombre.Contains(token, StringComparison.OrdinalIgnoreCase));
            });
        }
    }

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar()
    {
        listaOficinas = (await RepoOficina.GetAllAsync()).OrderBy(o => o.Nombre).ToList();
    }

    private async Task AgregarOficina()
    {
        if (!string.IsNullOrWhiteSpace(nuevaOficinaNombre))
        {
            mensajeError = string.Empty;
            await RepoOficina.AddAsync(new CatOficina { Nombre = nuevaOficinaNombre.Trim(), EsExterna = false });
            nuevaOficinaNombre = string.Empty;
            mensajeExito = "Oficina agregada correctamente.";
            await Cargar();
        }
    }

    private async Task CambiarTipoOficina(CatOficina oficina, ChangeEventArgs e)
    {
        if (oficina is null) return;
        oficina.EsExterna = (e.Value is bool b && b);
        await RepoOficina.UpdateAsync(oficina);
    }

    private void IniciarEdicion(CatOficina oficina)
    {
        oficinaEditandoId = oficina.IdOficina;
        nombreEdicion = oficina.Nombre;
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
    }

    private void CancelarEdicion()
    {
        oficinaEditandoId = 0;
        nombreEdicion = string.Empty;
    }

    private async Task GuardarEdicionConEnter(KeyboardEventArgs e, CatOficina oficina)
    {
        if (e.Key == "Enter")
        {
            await GuardarEdicion(oficina);
        }
    }

    private async Task GuardarEdicion(CatOficina oficina)
    {
        if (!string.IsNullOrWhiteSpace(nombreEdicion))
        {
            oficina.Nombre = nombreEdicion.Trim();
            await RepoOficina.UpdateAsync(oficina);
            oficinaEditandoId = 0;
            mensajeExito = "Cambios guardados exitosamente.";
        }
    }

    private async Task Eliminar(int id)
    {
        var oficina = listaOficinas.FirstOrDefault(o => o.IdOficina == id);
        if (oficina is null) return;

        var tieneDocumentos = await DbContext.MaeDocumentos.AsNoTracking().AnyAsync(d => d.IdOficinaActual == id);
        var tieneMovs = await DbContext.TraMovimientos.AsNoTracking().AnyAsync(m => m.IdOficinaOrigen == id || m.IdOficinaDestino == id);
        var tieneUsers = await DbContext.CatUsuarios.AsNoTracking().AnyAsync(u => u.IdOficina == id);

        if (tieneDocumentos || tieneMovs || tieneUsers)
        {
            mensajeError = $"No se puede eliminar '{oficina.Nombre}'. Contiene registros vinculados. Intente 'Unificar'.";
            return;
        }

        if (await JS.InvokeAsync<bool>("confirm", $"¿Eliminar definitivamente '{oficina.Nombre}'?"))
        {
            await RepoOficina.DeleteAsync(id);
            mensajeExito = "Oficina eliminada.";
            await Cargar();
        }
    }

    private void AbrirModalUnificacion()
    {
        idOficinaMaestra = 0;
        idsDuplicados.Clear();
        filtroModal = string.Empty;
        mostrarModalUnificacion = true;
    }

    private void CerrarModal() => mostrarModalUnificacion = false;

    private void ToggleDuplicado(int id, ChangeEventArgs e)
    {
        if (e.Value is bool check && check) idsDuplicados.Add(id);
        else idsDuplicados.Remove(id);
    }

    private async Task EjecutarUnificacion()
    {
        if (idOficinaMaestra == 0 || idsDuplicados.Count == 0) return;
        procesandoUnificacion = true;

        using var transaccion = await DbContext.Database.BeginTransactionAsync();
        try
        {
            var idsString = string.Join(",", idsDuplicados);

            await DbContext.Database.ExecuteSqlRawAsync($"UPDATE Mae_Documento SET IdOficinaActual = {idOficinaMaestra} WHERE IdOficinaActual IN ({idsString})");
            await DbContext.Database.ExecuteSqlRawAsync($"UPDATE Tra_Movimiento SET IdOficinaOrigen = {idOficinaMaestra} WHERE IdOficinaOrigen IN ({idsString})");
            await DbContext.Database.ExecuteSqlRawAsync($"UPDATE Tra_Movimiento SET IdOficinaDestino = {idOficinaMaestra} WHERE IdOficinaDestino IN ({idsString})");
            await DbContext.Database.ExecuteSqlRawAsync($"UPDATE Cat_Usuario SET IdOficina = {idOficinaMaestra} WHERE IdOficina IN ({idsString})");
            await DbContext.Database.ExecuteSqlRawAsync($"UPDATE Mae_NumeracionRangos SET IdOficina = {idOficinaMaestra} WHERE IdOficina IN ({idsString})");
            await DbContext.Database.ExecuteSqlRawAsync($"DELETE FROM Cat_Oficina WHERE IdOficina IN ({idsString})");

            await transaccion.CommitAsync();
            mensajeExito = "Unificación completada con éxito.";
            mostrarModalUnificacion = false;
            await Cargar();
        }
        catch (Exception ex)
        {
            await transaccion.RollbackAsync();
            mensajeError = $"Error: {ex.Message}";
        }
        finally
        {
            procesandoUnificacion = false;
        }
    }
}
